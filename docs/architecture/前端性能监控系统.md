# 前端性能监控系统

## 1. 性能监控架构

### 1.1 监控指标体系
```typescript
// apps/web/src/lib/performance-monitoring.ts
export interface PerformanceMetrics {
  // Core Web Vitals
  vitals: {
    lcp: number | null           // Largest Contentful Paint
    fid: number | null           // First Input Delay
    cls: number | null           // Cumulative Layout Shift
    fcp: number | null           // First Contentful Paint
    ttfb: number | null          // Time to First Byte
  }
  
  // 自定义业务指标
  custom: {
    stockDataLoadTime: number | null      // 股票数据加载时间
    chartRenderTime: number | null        // 图表渲染时间
    searchResponseTime: number | null     // 搜索响应时间
    routeNavigationTime: number | null    // 路由跳转时间
    apiResponseTime: number | null        // API平均响应时间
  }
  
  // 资源性能
  resources: {
    jsSize: number                        // JS文件总大小
    cssSize: number                       // CSS文件总大小
    imageSize: number                     // 图片总大小
    totalSize: number                     // 总资源大小
    resourceCount: number                 // 资源文件数量
  }
  
  // 用户体验指标
  ux: {
    sessionDuration: number               // 会话持续时间
    pageViews: number                     // 页面浏览量
    bounceRate: number                    // 跳出率
    errorRate: number                     // 错误率
    userInteractions: number              // 用户交互次数
  }
}

export const PERFORMANCE_THRESHOLDS = {
  vitals: {
    lcp: { good: 2500, needsImprovement: 4000 },      // ms
    fid: { good: 100, needsImprovement: 300 },        // ms
    cls: { good: 0.1, needsImprovement: 0.25 },       // score
    fcp: { good: 1800, needsImprovement: 3000 },      // ms
    ttfb: { good: 800, needsImprovement: 1800 }       // ms
  },
  custom: {
    stockDataLoadTime: { good: 1000, needsImprovement: 2000 },
    chartRenderTime: { good: 500, needsImprovement: 1000 },
    searchResponseTime: { good: 200, needsImprovement: 500 },
    routeNavigationTime: { good: 300, needsImprovement: 600 }
  },
  resources: {
    jsSize: { good: 300 * 1024, needsImprovement: 500 * 1024 },      // bytes
    totalSize: { good: 1024 * 1024, needsImprovement: 2048 * 1024 }   // bytes
  }
} as const

export enum PerformanceLevel {
  GOOD = 'good',
  NEEDS_IMPROVEMENT = 'needs_improvement', 
  POOR = 'poor'
}
```

### 1.2 性能数据收集器
```typescript
// apps/web/src/lib/performance-collector.ts
class PerformanceCollector {
  private metrics: Partial<PerformanceMetrics> = { vitals: {}, custom: {}, resources: {}, ux: {} }
  private observers: Map<string, PerformanceObserver> = new Map()
  private startTime: number = Date.now()

  constructor() {
    this.initializeObservers()
    this.collectResourceMetrics()
    this.collectCustomMetrics()
  }

  private initializeObservers() {
    // Core Web Vitals Observer
    this.createObserver('vitals', ['largest-contentful-paint', 'first-input', 'layout-shift'], (entry) => {
      switch (entry.entryType) {
        case 'largest-contentful-paint':
          this.metrics.vitals!.lcp = Math.round(entry.startTime)
          break
        case 'first-input':
          this.metrics.vitals!.fid = Math.round(entry.processingStart - entry.startTime)
          break
        case 'layout-shift':
          if (!(entry as any).hadRecentInput) {
            this.metrics.vitals!.cls = (this.metrics.vitals!.cls || 0) + (entry as any).value
          }
          break
      }
    })

    // Paint Observer
    this.createObserver('paint', ['paint'], (entry) => {
      if (entry.name === 'first-contentful-paint') {
        this.metrics.vitals!.fcp = Math.round(entry.startTime)
      }
    })

    // Navigation Observer
    this.createObserver('navigation', ['navigation'], (entry) => {
      const navEntry = entry as PerformanceNavigationTiming
      this.metrics.vitals!.ttfb = Math.round(navEntry.responseStart - navEntry.requestStart)
    })

    // Resource Observer
    this.createObserver('resource', ['resource'], (entry) => {
      this.collectResourceSize(entry as PerformanceResourceTiming)
    })
  }

  private createObserver(name: string, entryTypes: string[], callback: (entry: PerformanceEntry) => void) {
    try {
      const observer = new PerformanceObserver((list) => {
        list.getEntries().forEach(callback)
      })
      observer.observe({ entryTypes })
      this.observers.set(name, observer)
    } catch (error) {
      console.warn(`Failed to create ${name} observer:`, error)
    }
  }

  private collectResourceSize(entry: PerformanceResourceTiming) {
    const url = new URL(entry.name)
    const extension = url.pathname.split('.').pop()?.toLowerCase()
    
    if (!this.metrics.resources) this.metrics.resources = { jsSize: 0, cssSize: 0, imageSize: 0, totalSize: 0, resourceCount: 0 }
    
    const size = entry.transferSize || entry.encodedBodySize || 0
    this.metrics.resources.totalSize += size
    this.metrics.resources.resourceCount += 1

    if (extension === 'js') {
      this.metrics.resources.jsSize += size
    } else if (extension === 'css') {
      this.metrics.resources.cssSize += size
    } else if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'].includes(extension || '')) {
      this.metrics.resources.imageSize += size
    }
  }

  private collectCustomMetrics() {
    if (!this.metrics.custom) this.metrics.custom = {}
    
    // 监听自定义事件
    window.addEventListener('stock-data-loaded', (event: CustomEvent) => {
      this.metrics.custom!.stockDataLoadTime = event.detail.loadTime
    })

    window.addEventListener('chart-rendered', (event: CustomEvent) => {
      this.metrics.custom!.chartRenderTime = event.detail.renderTime
    })

    window.addEventListener('search-completed', (event: CustomEvent) => {
      this.metrics.custom!.searchResponseTime = event.detail.responseTime
    })

    window.addEventListener('route-navigated', (event: CustomEvent) => {
      this.metrics.custom!.routeNavigationTime = event.detail.navigationTime
    })
  }

  // 开始测量自定义指标
  startMeasurement(name: string): () => number {
    const startTime = performance.now()
    return () => {
      const duration = Math.round(performance.now() - startTime)
      
      // 触发自定义事件
      window.dispatchEvent(new CustomEvent(`${name}`, {
        detail: { 
          [name === 'stock-data-loaded' ? 'loadTime' : 
           name === 'chart-rendered' ? 'renderTime' :
           name === 'search-completed' ? 'responseTime' :
           name === 'route-navigated' ? 'navigationTime' : 'duration']: duration 
        }
      }))
      
      return duration
    }
  }

  getMetrics(): Partial<PerformanceMetrics> {
    // 计算UX指标
    if (!this.metrics.ux) this.metrics.ux = { sessionDuration: 0, pageViews: 0, bounceRate: 0, errorRate: 0, userInteractions: 0 }
    this.metrics.ux.sessionDuration = Date.now() - this.startTime
    
    return { ...this.metrics }
  }

  getMetricLevel(category: keyof typeof PERFORMANCE_THRESHOLDS, metric: string, value: number): PerformanceLevel {
    const thresholds = PERFORMANCE_THRESHOLDS[category]?.[metric as keyof typeof PERFORMANCE_THRESHOLDS[typeof category]]
    
    if (!thresholds) return PerformanceLevel.GOOD
    
    if (value <= thresholds.good) return PerformanceLevel.GOOD
    if (value <= thresholds.needsImprovement) return PerformanceLevel.NEEDS_IMPROVEMENT
    return PerformanceLevel.POOR
  }

  dispose() {
    this.observers.forEach(observer => observer.disconnect())
    this.observers.clear()
  }
}

// 全局性能收集器实例
export const performanceCollector = new PerformanceCollector()
```

### 1.3 React Hook集成
```typescript
// apps/web/src/hooks/use-performance-monitoring.ts
import { useEffect, useRef } from 'react'
import { performanceCollector } from '@/lib/performance-collector'

export const usePerformanceMonitoring = (componentName: string) => {
  const mountTime = useRef<number>(0)
  const renderCount = useRef<number>(0)

  useEffect(() => {
    mountTime.current = performance.now()
    renderCount.current += 1

    return () => {
      const unmountTime = performance.now()
      const lifespan = unmountTime - mountTime.current

      // 记录组件生命周期指标
      console.debug(`Component ${componentName}:`, {
        lifespan: Math.round(lifespan),
        renderCount: renderCount.current
      })
    }
  }, [componentName])

  // 测量渲染时间
  const measureRender = (callback: () => void) => {
    const startTime = performance.now()
    callback()
    const renderTime = performance.now() - startTime
    
    console.debug(`${componentName} render time:`, Math.round(renderTime), 'ms')
    return renderTime
  }

  return { measureRender }
}

// 股票数据加载性能监控
export const useStockDataPerformance = () => {
  const measureDataLoad = (dataFetchFn: () => Promise<any>) => {
    const endMeasurement = performanceCollector.startMeasurement('stock-data-loaded')
    
    return dataFetchFn().finally(() => {
      endMeasurement()
    })
  }

  return { measureDataLoad }
}

// 图表渲染性能监控
export const useChartPerformance = () => {
  const measureChartRender = (renderFn: () => void) => {
    const endMeasurement = performanceCollector.startMeasurement('chart-rendered')
    renderFn()
    endMeasurement()
  }

  return { measureChartRender }
}

// 搜索性能监控
export const useSearchPerformance = () => {
  const measureSearch = (searchFn: () => Promise<any>) => {
    const endMeasurement = performanceCollector.startMeasurement('search-completed')
    
    return searchFn().finally(() => {
      endMeasurement()
    })
  }

  return { measureSearch }
}
```

## 2. 性能监控仪表板

### 2.1 性能监控组件
```typescript
// apps/web/src/components/performance/performance-dashboard.tsx
import { useEffect, useState } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { performanceCollector, PerformanceMetrics, PERFORMANCE_THRESHOLDS, PerformanceLevel } from '@/lib/performance-collector'

export const PerformanceDashboard = () => {
  const [metrics, setMetrics] = useState<Partial<PerformanceMetrics>>({})
  const [isVisible, setIsVisible] = useState(false)

  useEffect(() => {
    const updateMetrics = () => {
      setMetrics(performanceCollector.getMetrics())
    }

    // 定期更新指标
    const interval = setInterval(updateMetrics, 5000)
    updateMetrics()

    return () => clearInterval(interval)
  }, [])

  // 开发环境显示快捷键
  useEffect(() => {
    const handleKeyPress = (event: KeyboardEvent) => {
      if (event.ctrlKey && event.shiftKey && event.key === 'P') {
        setIsVisible(!isVisible)
      }
    }

    window.addEventListener('keydown', handleKeyPress)
    return () => window.removeEventListener('keydown', handleKeyPress)
  }, [isVisible])

  const getMetricBadge = (level: PerformanceLevel) => {
    const variants = {
      [PerformanceLevel.GOOD]: 'default' as const,
      [PerformanceLevel.NEEDS_IMPROVEMENT]: 'secondary' as const,
      [PerformanceLevel.POOR]: 'destructive' as const
    }
    
    const labels = {
      [PerformanceLevel.GOOD]: '优秀',
      [PerformanceLevel.NEEDS_IMPROVEMENT]: '需改进',
      [PerformanceLevel.POOR]: '较差'
    }

    return <Badge variant={variants[level]}>{labels[level]}</Badge>
  }

  const calculateScore = (): number => {
    let totalScore = 0
    let totalWeight = 0

    // Core Web Vitals权重
    if (metrics.vitals?.lcp) {
      const level = performanceCollector.getMetricLevel('vitals', 'lcp', metrics.vitals.lcp)
      totalScore += level === PerformanceLevel.GOOD ? 100 : level === PerformanceLevel.NEEDS_IMPROVEMENT ? 70 : 30
      totalWeight += 25
    }

    if (metrics.vitals?.fid) {
      const level = performanceCollector.getMetricLevel('vitals', 'fid', metrics.vitals.fid)
      totalScore += level === PerformanceLevel.GOOD ? 100 : level === PerformanceLevel.NEEDS_IMPROVEMENT ? 70 : 30
      totalWeight += 25
    }

    if (metrics.vitals?.cls !== null && metrics.vitals?.cls !== undefined) {
      const level = performanceCollector.getMetricLevel('vitals', 'cls', metrics.vitals.cls)
      totalScore += level === PerformanceLevel.GOOD ? 100 : level === PerformanceLevel.NEEDS_IMPROVEMENT ? 70 : 30
      totalWeight += 25
    }

    if (metrics.vitals?.fcp) {
      const level = performanceCollector.getMetricLevel('vitals', 'fcp', metrics.vitals.fcp)
      totalScore += level === PerformanceLevel.GOOD ? 100 : level === PerformanceLevel.NEEDS_IMPROVEMENT ? 70 : 30
      totalWeight += 25
    }

    return totalWeight > 0 ? Math.round(totalScore / totalWeight) : 0
  }

  if (!isVisible && process.env.NODE_ENV !== 'development') {
    return null
  }

  const overallScore = calculateScore()

  return (
    <div className={`fixed bottom-4 right-4 z-50 max-w-md ${isVisible ? 'block' : 'hidden'}`}>
      <Card className="shadow-lg border-2">
        <CardHeader className="pb-3">
          <CardTitle className="flex items-center justify-between text-lg">
            性能监控
            <div className="flex items-center gap-2">
              <span className="text-2xl font-bold">{overallScore}</span>
              {getMetricBadge(
                overallScore >= 90 ? PerformanceLevel.GOOD :
                overallScore >= 70 ? PerformanceLevel.NEEDS_IMPROVEMENT :
                PerformanceLevel.POOR
              )}
            </div>
          </CardTitle>
        </CardHeader>
        
        <CardContent className="space-y-4">
          {/* Core Web Vitals */}
          <div>
            <h4 className="font-medium mb-2">Core Web Vitals</h4>
            <div className="space-y-2 text-sm">
              {metrics.vitals?.lcp && (
                <div className="flex justify-between items-center">
                  <span>LCP</span>
                  <div className="flex items-center gap-2">
                    <span>{Math.round(metrics.vitals.lcp)}ms</span>
                    {getMetricBadge(performanceCollector.getMetricLevel('vitals', 'lcp', metrics.vitals.lcp))}
                  </div>
                </div>
              )}
              
              {metrics.vitals?.fid && (
                <div className="flex justify-between items-center">
                  <span>FID</span>
                  <div className="flex items-center gap-2">
                    <span>{Math.round(metrics.vitals.fid)}ms</span>
                    {getMetricBadge(performanceCollector.getMetricLevel('vitals', 'fid', metrics.vitals.fid))}
                  </div>
                </div>
              )}
              
              {metrics.vitals?.cls !== null && metrics.vitals?.cls !== undefined && (
                <div className="flex justify-between items-center">
                  <span>CLS</span>
                  <div className="flex items-center gap-2">
                    <span>{metrics.vitals.cls.toFixed(3)}</span>
                    {getMetricBadge(performanceCollector.getMetricLevel('vitals', 'cls', metrics.vitals.cls))}
                  </div>
                </div>
              )}

              {metrics.vitals?.fcp && (
                <div className="flex justify-between items-center">
                  <span>FCP</span>
                  <div className="flex items-center gap-2">
                    <span>{Math.round(metrics.vitals.fcp)}ms</span>
                    {getMetricBadge(performanceCollector.getMetricLevel('vitals', 'fcp', metrics.vitals.fcp))}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* 自定义业务指标 */}
          {Object.keys(metrics.custom || {}).length > 0 && (
            <div>
              <h4 className="font-medium mb-2">业务指标</h4>
              <div className="space-y-2 text-sm">
                {metrics.custom?.stockDataLoadTime && (
                  <div className="flex justify-between items-center">
                    <span>股票数据加载</span>
                    <div className="flex items-center gap-2">
                      <span>{Math.round(metrics.custom.stockDataLoadTime)}ms</span>
                      {getMetricBadge(performanceCollector.getMetricLevel('custom', 'stockDataLoadTime', metrics.custom.stockDataLoadTime))}
                    </div>
                  </div>
                )}

                {metrics.custom?.chartRenderTime && (
                  <div className="flex justify-between items-center">
                    <span>图表渲染</span>
                    <div className="flex items-center gap-2">
                      <span>{Math.round(metrics.custom.chartRenderTime)}ms</span>
                      {getMetricBadge(performanceCollector.getMetricLevel('custom', 'chartRenderTime', metrics.custom.chartRenderTime))}
                    </div>
                  </div>
                )}

                {metrics.custom?.searchResponseTime && (
                  <div className="flex justify-between items-center">
                    <span>搜索响应</span>
                    <div className="flex items-center gap-2">
                      <span>{Math.round(metrics.custom.searchResponseTime)}ms</span>
                      {getMetricBadge(performanceCollector.getMetricLevel('custom', 'searchResponseTime', metrics.custom.searchResponseTime))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* 资源使用 */}
          {metrics.resources && (
            <div>
              <h4 className="font-medium mb-2">资源使用</h4>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span>总大小</span>
                  <span>{(metrics.resources.totalSize / 1024).toFixed(1)}KB</span>
                </div>
                <div className="flex justify-between">
                  <span>JS大小</span>
                  <span>{(metrics.resources.jsSize / 1024).toFixed(1)}KB</span>
                </div>
                <div className="flex justify-between">
                  <span>CSS大小</span>
                  <span>{(metrics.resources.cssSize / 1024).toFixed(1)}KB</span>
                </div>
                <div className="flex justify-between">
                  <span>资源数量</span>
                  <span>{metrics.resources.resourceCount}</span>
                </div>
              </div>
            </div>
          )}

          <div className="pt-2 border-t text-xs text-muted-foreground">
            Ctrl+Shift+P 切换显示
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
```

### 2.2 性能警告系统
```typescript
// apps/web/src/components/performance/performance-alerts.tsx
import { useEffect, useState } from 'react'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { AlertTriangle, X } from 'lucide-react'
import { performanceCollector, PERFORMANCE_THRESHOLDS, PerformanceLevel } from '@/lib/performance-collector'

interface PerformanceAlert {
  id: string
  type: 'warning' | 'error'
  title: string
  message: string
  timestamp: number
}

export const PerformanceAlerts = () => {
  const [alerts, setAlerts] = useState<PerformanceAlert[]>([])

  useEffect(() => {
    const checkPerformance = () => {
      const metrics = performanceCollector.getMetrics()
      const newAlerts: PerformanceAlert[] = []

      // 检查Core Web Vitals
      if (metrics.vitals?.lcp && metrics.vitals.lcp > PERFORMANCE_THRESHOLDS.vitals.lcp.needsImprovement) {
        newAlerts.push({
          id: 'lcp-poor',
          type: 'error',
          title: 'LCP性能较差',
          message: `最大内容绘制时间过长 (${Math.round(metrics.vitals.lcp)}ms)，影响用户体验`,
          timestamp: Date.now()
        })
      }

      if (metrics.vitals?.fid && metrics.vitals.fid > PERFORMANCE_THRESHOLDS.vitals.fid.needsImprovement) {
        newAlerts.push({
          id: 'fid-poor',
          type: 'error',
          title: 'FID性能较差',
          message: `首次输入延迟过长 (${Math.round(metrics.vitals.fid)}ms)，影响交互响应`,
          timestamp: Date.now()
        })
      }

      if (metrics.vitals?.cls && metrics.vitals.cls > PERFORMANCE_THRESHOLDS.vitals.cls.needsImprovement) {
        newAlerts.push({
          id: 'cls-poor',
          type: 'error',
          title: 'CLS布局抖动',
          message: `累积布局偏移过大 (${metrics.vitals.cls.toFixed(3)})，页面不稳定`,
          timestamp: Date.now()
        })
      }

      // 检查自定义指标
      if (metrics.custom?.stockDataLoadTime && 
          metrics.custom.stockDataLoadTime > PERFORMANCE_THRESHOLDS.custom.stockDataLoadTime.needsImprovement) {
        newAlerts.push({
          id: 'stock-data-slow',
          type: 'warning',
          title: '股票数据加载缓慢',
          message: `数据加载时间过长 (${Math.round(metrics.custom.stockDataLoadTime)}ms)`,
          timestamp: Date.now()
        })
      }

      // 检查资源大小
      if (metrics.resources?.totalSize && 
          metrics.resources.totalSize > PERFORMANCE_THRESHOLDS.resources.totalSize.needsImprovement) {
        newAlerts.push({
          id: 'bundle-large',
          type: 'warning',
          title: '资源包过大',
          message: `总资源大小过大 (${(metrics.resources.totalSize / 1024).toFixed(1)}KB)`,
          timestamp: Date.now()
        })
      }

      // 更新警告列表，避免重复
      setAlerts(prev => {
        const existingIds = prev.map(a => a.id)
        const filteredNew = newAlerts.filter(a => !existingIds.includes(a.id))
        return [...prev, ...filteredNew]
      })
    }

    const interval = setInterval(checkPerformance, 10000) // 10秒检查一次
    checkPerformance()

    return () => clearInterval(interval)
  }, [])

  const dismissAlert = (id: string) => {
    setAlerts(prev => prev.filter(alert => alert.id !== id))
  }

  const dismissAll = () => {
    setAlerts([])
  }

  if (alerts.length === 0) {
    return null
  }

  return (
    <div className="fixed top-4 right-4 z-50 space-y-2 max-w-sm">
      {alerts.map(alert => (
        <Alert key={alert.id} variant={alert.type === 'error' ? 'destructive' : 'default'}>
          <AlertTriangle className="h-4 w-4" />
          <div className="flex-1">
            <AlertTitle>{alert.title}</AlertTitle>
            <AlertDescription className="text-sm">
              {alert.message}
            </AlertDescription>
          </div>
          <button
            onClick={() => dismissAlert(alert.id)}
            className="ml-2 p-1 rounded-full hover:bg-muted"
          >
            <X className="h-4 w-4" />
          </button>
        </Alert>
      ))}
      
      {alerts.length > 1 && (
        <div className="flex justify-end">
          <button
            onClick={dismissAll}
            className="text-xs text-muted-foreground hover:text-foreground"
          >
            清除所有警告
          </button>
        </div>
      )}
    </div>
  )
}
```

## 3. 性能数据上报

### 3.1 数据上报服务
```typescript
// apps/web/src/lib/performance-reporter.ts
export interface PerformanceReport {
  sessionId: string
  userId?: string
  url: string
  userAgent: string
  timestamp: number
  metrics: Partial<PerformanceMetrics>
  context: {
    viewportSize: { width: number; height: number }
    connectionType: string
    deviceMemory?: number
    hardwareConcurrency: number
  }
}

class PerformanceReporter {
  private sessionId: string
  private reportQueue: PerformanceReport[] = []
  private isReporting = false

  constructor() {
    this.sessionId = this.generateSessionId()
    this.setupAutoReporting()
  }

  private generateSessionId(): string {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
  }

  private setupAutoReporting() {
    // 页面卸载时上报
    window.addEventListener('beforeunload', () => {
      this.flushReports()
    })

    // 定期上报
    setInterval(() => {
      this.reportCurrentMetrics()
    }, 30000) // 30秒上报一次

    // 页面隐藏时上报
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        this.reportCurrentMetrics()
      }
    })
  }

  private getDeviceInfo() {
    const navigator = window.navigator as any
    return {
      viewportSize: {
        width: window.innerWidth,
        height: window.innerHeight
      },
      connectionType: navigator.connection?.effectiveType || 'unknown',
      deviceMemory: navigator.deviceMemory || undefined,
      hardwareConcurrency: navigator.hardwareConcurrency || 1
    }
  }

  reportCurrentMetrics() {
    const metrics = performanceCollector.getMetrics()
    
    const report: PerformanceReport = {
      sessionId: this.sessionId,
      userId: this.getCurrentUserId(),
      url: window.location.href,
      userAgent: navigator.userAgent,
      timestamp: Date.now(),
      metrics,
      context: this.getDeviceInfo()
    }

    this.reportQueue.push(report)
    
    if (this.reportQueue.length >= 5 || this.shouldForceReport(metrics)) {
      this.flushReports()
    }
  }

  private getCurrentUserId(): string | undefined {
    // 从认证系统获取用户ID
    try {
      const user = JSON.parse(localStorage.getItem('user') || '{}')
      return user.id
    } catch {
      return undefined
    }
  }

  private shouldForceReport(metrics: Partial<PerformanceMetrics>): boolean {
    // 性能指标较差时强制上报
    if (metrics.vitals?.lcp && metrics.vitals.lcp > 4000) return true
    if (metrics.vitals?.fid && metrics.vitals.fid > 300) return true
    if (metrics.vitals?.cls && metrics.vitals.cls > 0.25) return true
    return false
  }

  async flushReports() {
    if (this.isReporting || this.reportQueue.length === 0) return

    this.isReporting = true
    const reportsToSend = [...this.reportQueue]
    this.reportQueue = []

    try {
      // 使用beacon API确保数据能够发送
      if (navigator.sendBeacon && reportsToSend.length === 1) {
        const success = navigator.sendBeacon(
          '/api/performance/report',
          JSON.stringify(reportsToSend[0])
        )
        if (!success) throw new Error('Beacon failed')
      } else {
        // 回退到fetch
        await fetch('/api/performance/report', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ reports: reportsToSend }),
          keepalive: true
        })
      }

      console.debug('Performance reports sent:', reportsToSend.length)
    } catch (error) {
      console.warn('Failed to send performance reports:', error)
      // 重新加入队列等待下次发送
      this.reportQueue.unshift(...reportsToSend)
    } finally {
      this.isReporting = false
    }
  }

  // 手动报告特定事件
  reportEvent(eventName: string, data: any) {
    const report: PerformanceReport = {
      sessionId: this.sessionId,
      userId: this.getCurrentUserId(),
      url: window.location.href,
      userAgent: navigator.userAgent,
      timestamp: Date.now(),
      metrics: {
        custom: {
          [eventName]: data.duration || data.value || 1
        }
      },
      context: this.getDeviceInfo()
    }

    this.reportQueue.push(report)
  }
}

export const performanceReporter = new PerformanceReporter()
```

### 3.2 后端接收端点
```typescript
// apps/server/src/routers/performance.ts
import { z } from 'zod'
import { procedure, router } from '../lib/trpc'

const performanceReportSchema = z.object({
  sessionId: z.string(),
  userId: z.string().optional(),
  url: z.string(),
  userAgent: z.string(),
  timestamp: z.number(),
  metrics: z.object({
    vitals: z.object({
      lcp: z.number().nullable(),
      fid: z.number().nullable(),
      cls: z.number().nullable(),
      fcp: z.number().nullable(),
      ttfb: z.number().nullable()
    }).optional(),
    custom: z.record(z.number().nullable()).optional(),
    resources: z.object({
      jsSize: z.number(),
      cssSize: z.number(),
      imageSize: z.number(),
      totalSize: z.number(),
      resourceCount: z.number()
    }).optional(),
    ux: z.object({
      sessionDuration: z.number(),
      pageViews: z.number(),
      bounceRate: z.number(),
      errorRate: z.number(),
      userInteractions: z.number()
    }).optional()
  }),
  context: z.object({
    viewportSize: z.object({
      width: z.number(),
      height: z.number()
    }),
    connectionType: z.string(),
    deviceMemory: z.number().optional(),
    hardwareConcurrency: z.number()
  })
})

export const performanceRouter = router({
  report: procedure
    .input(z.object({
      reports: z.array(performanceReportSchema).optional(),
      report: performanceReportSchema.optional()
    }))
    .mutation(async ({ input }) => {
      const reports = input.reports || (input.report ? [input.report] : [])
      
      // 存储性能数据到数据库
      for (const report of reports) {
        await db.insert(performanceReports).values({
          sessionId: report.sessionId,
          userId: report.userId,
          url: report.url,
          userAgent: report.userAgent,
          timestamp: new Date(report.timestamp),
          metrics: JSON.stringify(report.metrics),
          context: JSON.stringify(report.context),
          createdAt: new Date()
        })

        // 检查是否需要告警
        await checkPerformanceAlerts(report)
      }

      return { success: true, processed: reports.length }
    }),

  getMetrics: procedure
    .input(z.object({
      timeRange: z.enum(['1h', '24h', '7d', '30d']).default('24h'),
      userId: z.string().optional()
    }))
    .query(async ({ input }) => {
      const timeRangeMap = {
        '1h': 1,
        '24h': 24,
        '7d': 24 * 7,
        '30d': 24 * 30
      }

      const hours = timeRangeMap[input.timeRange]
      const startTime = new Date(Date.now() - hours * 60 * 60 * 1000)

      const reports = await db
        .select()
        .from(performanceReports)
        .where(
          and(
            gte(performanceReports.timestamp, startTime),
            input.userId ? eq(performanceReports.userId, input.userId) : undefined
          )
        )
        .orderBy(desc(performanceReports.timestamp))

      // 聚合性能数据
      const aggregated = aggregatePerformanceData(reports)
      
      return aggregated
    })
})

async function checkPerformanceAlerts(report: any) {
  const metrics = report.metrics
  
  // 检查关键指标
  if (metrics.vitals?.lcp && metrics.vitals.lcp > 4000) {
    // 发送告警
    console.warn(`Performance Alert: High LCP for user ${report.userId}: ${metrics.vitals.lcp}ms`)
  }
  
  if (metrics.vitals?.cls && metrics.vitals.cls > 0.25) {
    console.warn(`Performance Alert: High CLS for user ${report.userId}: ${metrics.vitals.cls}`)
  }
}

function aggregatePerformanceData(reports: any[]) {
  // 聚合逻辑实现
  return {
    totalReports: reports.length,
    averageMetrics: {
      lcp: calculateAverage(reports, 'metrics.vitals.lcp'),
      fid: calculateAverage(reports, 'metrics.vitals.fid'),
      cls: calculateAverage(reports, 'metrics.vitals.cls')
    },
    trends: calculateTrends(reports)
  }
}
```

## 4. 实施检查清单

### 4.1 开发阶段
- [ ] 实现性能数据收集器
- [ ] 创建React Hook集成
- [ ] 构建监控仪表板组件
- [ ] 实现警告系统
- [ ] 配置数据上报服务

### 4.2 测试阶段
- [ ] 性能指标准确性验证
- [ ] 不同设备和网络条件测试
- [ ] 数据上报可靠性测试
- [ ] 警告阈值调优
- [ ] 监控面板功能测试

### 4.3 部署阶段
- [ ] 生产环境监控配置
- [ ] 性能基准线建立
- [ ] 告警通道配置
- [ ] 数据分析仪表板集成
- [ ] 持续优化流程建立

## 5. 性能优化建议

### 5.1 基于监控数据的优化
```typescript
// apps/web/src/lib/performance-optimizer.ts
export class PerformanceOptimizer {
  static analyzeAndOptimize(metrics: PerformanceMetrics) {
    const recommendations: string[] = []

    // LCP优化建议
    if (metrics.vitals.lcp && metrics.vitals.lcp > 2500) {
      recommendations.push('考虑预加载关键资源或优化图片加载')
      recommendations.push('实施服务端渲染或静态生成')
      recommendations.push('优化CSS阻塞资源')
    }

    // FID优化建议  
    if (metrics.vitals.fid && metrics.vitals.fid > 100) {
      recommendations.push('减少主线程阻塞时间')
      recommendations.push('优化JavaScript执行时间')
      recommendations.push('使用Web Workers处理复杂计算')
    }

    // CLS优化建议
    if (metrics.vitals.cls && metrics.vitals.cls > 0.1) {
      recommendations.push('为图片和视频设置明确尺寸')
      recommendations.push('避免在现有内容上方插入内容')
      recommendations.push('使用骨架屏预留布局空间')
    }

    // 资源优化建议
    if (metrics.resources.totalSize > 1024 * 1024) {
      recommendations.push('实施代码分割减少包大小')
      recommendations.push('启用Gzip/Brotli压缩')
      recommendations.push('移除未使用的代码和依赖')
    }

    return recommendations
  }
}
```

## 6. 监控报告模板

### 6.1 定期性能报告
```typescript
// scripts/generate-performance-report.ts
export const generateWeeklyPerformanceReport = async () => {
  const report = {
    period: 'Weekly',
    dateRange: `${getWeekStart()} - ${getWeekEnd()}`,
    metrics: {
      coreWebVitals: {
        lcp: { average: 2100, trend: '+5%', status: 'good' },
        fid: { average: 85, trend: '-10%', status: 'good' },
        cls: { average: 0.08, trend: '-15%', status: 'good' }
      },
      businessMetrics: {
        stockDataLoad: { average: 1200, trend: '+8%' },
        chartRender: { average: 450, trend: '-5%' },
        searchResponse: { average: 180, trend: '-12%' }
      },
      userExperience: {
        bounceRate: '12%',
        sessionDuration: '8.5min',
        pageViews: '15.2/session'
      }
    },
    recommendations: [
      '优化股票数据API响应时间',
      '实施图表组件懒加载',
      '添加搜索结果缓存'
    ]
  }

  return report
}
```

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"id": "fix-frontend-performance", "content": "\u4fee\u590d\u524d\u7aef\u6027\u80fd\u7b56\u7565 - \u4ee3\u7801\u5206\u5272\u3001\u61d2\u52a0\u8f7d\u3001\u56fe\u50cf\u4f18\u5316", "status": "completed"}, {"id": "fix-data-security", "content": "\u5b8c\u5584\u6570\u636e\u5b89\u5168\u89c4\u8303 - \u52a0\u5bc6\u6807\u51c6\u3001\u5ba1\u8ba1\u65e5\u5fd7", "status": "completed"}, {"id": "fix-accessibility", "content": "\u660e\u786e\u65e0\u969c\u788d\u6027\u6d4b\u8bd5\u6d41\u7a0b\u548c\u5408\u89c4\u76ee\u6807", "status": "completed"}, {"id": "fix-routing", "content": "\u5b8c\u5584\u8def\u7531\u4fdd\u62a4\u548c\u5bfc\u822a\u89c4\u8303", "status": "completed"}, {"id": "add-performance-monitoring", "content": "\u6dfb\u52a0\u524d\u7aef\u6027\u80fd\u76d1\u63a7", "status": "completed"}]