# 测试设计：故事1.1 - 数据库架构扩展和股票基础数据管理

**日期**: 2025-08-26  
**设计师**: Quinn (测试架构师)  
**故事版本**: 1.4
**相关风险档案**: docs/qa/assessments/1.1-risk-20250826.md

## 测试策略概述

- **测试场景总数**: 16个
- **单元测试**: 5个 (31% - 快速反馈和纯逻辑验证)  
- **集成测试**: 8个 (50% - 组件交互和数据库操作主体)
- **E2E测试**: 3个 (19% - 关键流程验证，符合测试金字塔)
- **优先级分布**: P0: 11个, P1: 4个, P2: 2个

## 测试执行策略

### 执行顺序 (Fail Fast原则)
1. **P0单元测试** (1.1-UNIT-001/002/004) - 立即反馈基础逻辑
2. **P0集成测试** (1.1-INT-001/002/003/005/006/009/010) - 核心组件交互
3. **P0 E2E测试** (1.1-E2E-002/003/004) - 关键业务流程  
4. **P1测试** - 核心功能补充验证
5. **P2测试** - 时间允许时执行

### 测试环境要求
- **单元测试**: 内存数据库，Mock外部依赖
- **集成测试**: 独立测试数据库实例，Docker化环境
- **E2E测试**: 完整staging环境，模拟生产配置

## 按验收标准的测试场景

### AC1: SQLite架构优化

| ID           | 级别   | 优先级 | 测试场景                           | 理由                      | 缓解风险    |
|--------------|--------|--------|------------------------------------|---------------------------|-------------|
| 1.1-INT-001  | 集成   | P0     | 连接池管理验证                     | 多组件交互，需真实DB环境  | TECH-002    |
| 1.1-E2E-001  | E2E    | P0     | 百人并发性能测试(查询<200ms)       | 性能SLA需完整环境验证     | PERF-001    |
| 1.1-UNIT-001 | 单元   | P1     | 连接池状态计算                     | 纯计算逻辑，可独立测试    | TECH-002    |

**测试覆盖**: 连接池管理✅、并发性能✅、索引策略(间接)✅

### AC2: 扩展Drizzle Schema

| ID           | 级别   | 优先级 | 测试场景                           | 理由                      | 缓解风险    |
|--------------|--------|--------|------------------------------------|---------------------------|-------------|
| 1.1-INT-002  | 集成   | P0     | Schema创建和关系验证               | 涉及DB Schema变更和ORM    | TECH-003, DATA-002 |
| 1.1-UNIT-002 | 单元   | P0     | 股票代码格式验证                   | 纯验证逻辑，可独立测试    | BUS-001     |
| 1.1-INT-003  | 集成   | P0     | 外键约束验证                       | 需真实DB验证约束行为      | DATA-002    |

**测试覆盖**: 表结构创建✅、外键约束✅、数据验证✅

### AC3: 数据存储优化

| ID           | 级别   | 优先级 | 测试场景                           | 理由                      | 缓解风险    |
|--------------|--------|--------|------------------------------------|---------------------------|-------------|
| 1.1-UNIT-003 | 单元   | P1     | PRAGMA配置验证                     | 配置逻辑验证，可单独测试  | -           |
| 1.1-INT-004  | 集成   | P2     | 数据清理机制测试                   | 涉及DB操作和时间逻辑      | -           |

**测试覆盖**: PRAGMA配置✅、数据清理✅、存储管理(集成覆盖)✅

### AC4: 迁移和回滚策略

| ID           | 级别   | 优先级 | 测试场景                           | 理由                      | 缓解风险    |
|--------------|--------|--------|------------------------------------|---------------------------|-------------|
| 1.1-E2E-002  | E2E    | P0     | 完整迁移流程验证                   | 关键业务流程，需端到端    | TECH-001 (关键) |
| 1.1-INT-005  | 集成   | P0     | 迁移事务管理测试                   | 涉及DB事务和错误处理      | DATA-002    |
| 1.1-UNIT-004 | 单元   | P1     | 迁移版本比较逻辑                   | 纯逻辑计算，无外部依赖    | -           |

**测试覆盖**: 完整迁移流程✅、事务管理✅、版本跟踪✅

### AC5: 兼容性保证

| ID           | 级别   | 优先级 | 测试场景                           | 理由                      | 缓解风险    |
|--------------|--------|--------|------------------------------------|---------------------------|-------------|
| 1.1-INT-006  | 集成   | P0     | 认证系统兼容性测试                 | 需验证多系统集成兼容性    | BUS-002     |
| 1.1-E2E-003  | E2E    | P0     | 零停机升级验证                     | 需真实环境验证用户体验    | OPS-002     |

**测试覆盖**: 认证兼容性✅、零停机升级✅、Schema版本管理(迁移测试覆盖)✅

### AC6: 扩展性和监控

| ID           | 级别   | 优先级 | 测试场景                           | 理由                      | 缓解风险    |
|--------------|--------|--------|------------------------------------|---------------------------|-------------|
| 1.1-INT-007  | 集成   | P1     | 健康检查端点测试                   | 涉及API端点和DB状态查询   | OPS-001     |
| 1.1-UNIT-005 | 单元   | P1     | 性能指标计算验证                   | 纯计算逻辑，可独立验证    | -           |
| 1.1-INT-008  | 集成   | P2     | 告警机制集成测试                   | 涉及监控和通知组件交互    | OPS-001     |

**测试覆盖**: 健康检查✅、性能监控✅、告警机制✅

### 安全和数据质量测试

| ID           | 级别   | 优先级 | 测试场景                           | 理由                      | 缓解风险    |
|--------------|--------|--------|------------------------------------|---------------------------|-------------|
| 1.1-INT-009  | 集成   | P0     | API访问控制验证                    | 涉及API和认证系统集成     | SEC-001     |
| 1.1-E2E-004  | E2E    | P0     | 渗透测试场景                       | 需完整环境模拟真实攻击    | SEC-001, SEC-002 |
| 1.1-INT-010  | 集成   | P0     | 种子数据导入测试                   | 涉及大数据量操作和DB写入  | DATA-001    |

## 风险覆盖映射

### 关键风险 (评分≥9)
- ✅ **TECH-001** (迁移复杂性): 1.1-E2E-002完整迁移流程测试

### 高风险 (评分=6) 
- ✅ **TECH-002** (连接池管理): 1.1-INT-001, 1.1-UNIT-001
- ✅ **SEC-001** (访问控制): 1.1-INT-009, 1.1-E2E-004  
- ✅ **PERF-001** (查询性能): 1.1-E2E-001
- ✅ **DATA-001** (种子数据): 1.1-INT-010
- ✅ **DATA-002** (数据一致性): 1.1-INT-003, 1.1-INT-005
- ✅ **BUS-001** (数据质量): 1.1-UNIT-002

### 中等风险 (评分=4)
- ✅ **TECH-003** (Schema复杂性): 1.1-INT-002
- ✅ **OPS-001** (监控系统): 1.1-INT-007, 1.1-INT-008
- ✅ **OPS-002** (零停机): 1.1-E2E-003

## 详细测试场景

### P0关键测试 (必须通过)

#### 1.1-E2E-002: 完整迁移流程验证
**需求**: AC4 - 迁移和回滚策略  
**场景**: 
1. 从现有Schema版本执行完整迁移到v1.1
2. 验证所有新表正确创建，数据完整性保持
3. 模拟迁移失败场景(如磁盘空间不足)
4. 验证自动回滚机制在3次失败后触发
5. 确认回滚后系统状态与迁移前完全一致

**验收条件**:
- 迁移成功率>95%
- 回滚时间<5分钟  
- 数据完整性100%保持
- 迁移日志完整记录每个步骤

#### 1.1-INT-001: 连接池管理验证
**需求**: AC1 - SQLite架构优化  
**场景**:
1. 启动应用，验证连接池初始化为10个连接
2. 模拟并发请求消耗所有连接
3. 验证连接获取排队机制
4. 测试连接释放和复用
5. 验证连接泄漏检测和告警

**验收条件**:
- 连接池大小恒定为10
- 连接获取平均时间<10ms
- 无连接泄漏
- 连接利用率监控正确

#### 1.1-INT-002: Schema创建和关系验证
**需求**: AC2 - 扩展Drizzle Schema  
**场景**:
1. 执行Schema迁移，创建stocks、stock_daily、user_stock_favorites表
2. 验证所有表结构与设计一致
3. 测试外键关系: user→favorites、stocks→daily、stocks→favorites  
4. 验证索引创建和复合索引性能
5. 测试Drizzle ORM关系查询

**验收条件**:
- 所有表成功创建
- 外键约束生效
- 索引策略优化查询性能>50%
- ORM关系查询无错误

#### 1.1-E2E-001: 百人并发性能测试
**需求**: AC1 - 百人级并发访问，查询<200ms  
**场景**:
1. 预加载测试数据(1000只股票，10万条日线数据)
2. 启动100个并发用户模拟股票查询
3. 每用户执行混合查询(基础信息、历史数据、收藏)
4. 持续测试10分钟，监控响应时间
5. 验证系统稳定性和资源使用

**验收条件**:
- 95%查询响应时间<200ms
- 99%查询响应时间<500ms  
- 错误率<1%
- CPU使用率<80%，内存稳定

#### 1.1-INT-009: API访问控制验证
**需求**: 新增股票API端点安全控制  
**场景**:
1. 测试未认证用户访问限制(公开查询OK，收藏操作拒绝)
2. 验证输入参数严格验证(股票代码格式、SQL注入防护)
3. 测试用户权限隔离(只能操作自己的收藏)
4. 验证API调用频率限制
5. 测试错误信息安全(不泄露敏感信息)

**验收条件**:
- 未授权访问100%阻止
- 输入验证无绕过
- 用户数据完全隔离  
- 频率限制生效

### P1核心测试 (应当通过)

#### 1.1-INT-007: 健康检查端点测试  
**需求**: AC6 - 数据库健康检查端点
**场景**:
1. 正常状态下健康检查返回200和详细状态
2. 数据库连接异常时返回503和错误信息
3. 连接池耗尽时返回警告状态
4. 慢查询过多时返回性能警告
5. 验证健康检查自身性能<50ms

**验收条件**:
- 状态判断准确性100%
- 响应时间<50ms
- 错误信息有用且安全
- 支持监控系统集成

## 测试数据策略

### Mock数据规范
```typescript
// 股票基础数据
const mockStocks = {
  count: 100,  // 单元测试用少量数据
  sectors: ['银行', '科技', '制造业', '医药'],
  markets: ['主板', '创业板', '科创板'],
  formats: ['沪市60开头', '深市00/30开头']
}

// 日线数据  
const mockDailyData = {
  daysPerStock: 30,
  priceRange: [5.0, 200.0],
  volumeRange: [100000, 10000000],
  validationRules: ['开盘≤最高', '收盘≤最高', '最低≤收盘']
}

// 用户收藏数据
const mockFavorites = {
  usersCount: 10,
  favoritesPerUser: [5, 20],  // 5-20只股票
  scenarios: ['空收藏', '单股票', '满收藏']
}
```

### 测试数据管理
- **隔离原则**: 每个测试用例使用独立数据集
- **清理策略**: 测试前后自动清理，避免数据污染
- **性能数据**: E2E测试使用生产规模数据(4000股票)
- **边缘数据**: 包含异常格式、边界值、空值测试

## 测试环境配置

### 单元测试环境
```yaml
database: ':memory:'  # SQLite内存数据库
mocking: vitest/jest
coverage: '@vitest/coverage-v8'
target: '>90% for database operations'
```

### 集成测试环境  
```yaml
database: 'test.db'  # 独立测试数据库文件
containers: docker-compose.test.yml
isolation: 每个测试套件独立数据库实例
performance: 查询操作<100ms
```

### E2E测试环境
```yaml
environment: staging
database: 完整Turso实例或本地SQLite
monitoring: 完整监控栈
load_testing: k6或Artillery
browser: Playwright (如需UI测试)
```

## 质量门控集成

### 必须通过的测试检查
- ✅ **P0测试通过率**: 100% (11个关键测试)
- ✅ **代码覆盖率**: >90% (数据库操作层)  
- ✅ **性能测试达标**: 查询<200ms, 并发100用户
- ✅ **安全测试通过**: 渗透测试无高危漏洞
- ✅ **迁移测试成功**: 完整流程验证通过

### 可接受的风险
- P1测试部分失败(非阻塞性功能)
- P2测试跳过(时间不足时)
- 性能偶尔超标(99%分位数可放宽到500ms)

## 测试执行时间估算

| 测试类型     | 场景数 | 单个耗时 | 总计时间 | 并行度 | 实际耗时 |
|--------------|--------|----------|----------|--------|----------|
| 单元测试     | 5      | 10s      | 50s      | 全部   | <1分钟   |
| 集成测试     | 8      | 2分钟    | 16分钟   | 4并发  | 4分钟    |
| E2E测试      | 3      | 10分钟   | 30分钟   | 串行   | 30分钟   |
| **总计**     | **16** | -        | -        | -      | **35分钟** |

## 风险基础的执行建议

### 高风险场景优先
1. **立即执行**: 1.1-E2E-002 (TECH-001关键风险)
2. **第二优先**: 1.1-INT-001, 1.1-E2E-001 (性能风险)
3. **第三优先**: 1.1-INT-009, 1.1-E2E-004 (安全风险)

### 失败处理策略
- **P0测试失败**: 立即停止，修复后重新执行全套P0测试
- **集成测试失败**: 检查环境配置，重新执行该类测试  
- **E2E测试失败**: 分析日志，可能需要环境重置

### 回归测试触发
- 代码变更影响数据库层: 执行所有数据库相关测试
- 性能优化: 执行所有性能测试
- 安全修复: 执行所有安全测试
- 任何Schema变更: 执行完整迁移测试

---

**测试设计方法**: 基于风险的测试分层策略  
**覆盖原则**: 每个AC至少一个测试，关键路径多级验证  
**下次更新**: 实施完成后或需求变更时