# 前端性能优化策略

## 1. 代码分割 (Code Splitting) 策略

### 1.1 路由级代码分割
```typescript
// apps/web/src/routes/stocks/index.tsx
import { lazy } from 'react'

// 懒加载股票相关组件
const StockChart = lazy(() => import('../../components/stock-chart'))
const BacktestResults = lazy(() => import('../../components/backtest-results'))
const StrategyBuilder = lazy(() => import('../../components/strategy-builder'))

// 使用 Suspense 包装
<Suspense fallback={<div className="flex justify-center p-4">
  <div className="animate-spin h-6 w-6 border-b-2 border-primary"></div>
</div>}>
  <StockChart />
</Suspense>
```

### 1.2 图表组件分割策略
```typescript
// apps/web/src/components/charts/index.ts
export const KLineChart = lazy(() => import('./k-line-chart'))
export const TechnicalIndicators = lazy(() => import('./technical-indicators'))
export const VolumeChart = lazy(() => import('./volume-chart'))

// 按需加载图表库
export const ChartLibrary = lazy(async () => {
  const [lightweightCharts] = await Promise.all([
    import('lightweight-charts'),
  ])
  return { default: lightweightCharts }
})
```

### 1.3 Bundle 分析和优化
```json
// package.json
{
  "scripts": {
    "analyze": "npx vite-bundle-analyzer",
    "build:analyze": "ANALYZE=true bun run build"
  }
}
```

## 2. 懒加载 (Lazy Loading) 实施

### 2.1 图像懒加载
```typescript
// apps/web/src/components/ui/lazy-image.tsx
import { useState, useRef, useEffect } from 'react'

interface LazyImageProps {
  src: string
  alt: string
  className?: string
  placeholder?: string
}

export const LazyImage = ({ src, alt, className, placeholder }: LazyImageProps) => {
  const [isLoaded, setIsLoaded] = useState(false)
  const [isInView, setIsInView] = useState(false)
  const imgRef = useRef<HTMLImageElement>(null)

  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          setIsInView(true)
          observer.disconnect()
        }
      },
      { threshold: 0.1 }
    )

    if (imgRef.current) {
      observer.observe(imgRef.current)
    }

    return () => observer.disconnect()
  }, [])

  return (
    <div ref={imgRef} className={className}>
      {isInView && (
        <img
          src={src}
          alt={alt}
          onLoad={() => setIsLoaded(true)}
          className={`transition-opacity duration-300 ${
            isLoaded ? 'opacity-100' : 'opacity-0'
          }`}
        />
      )}
      {!isLoaded && placeholder && (
        <div className="bg-muted animate-pulse rounded">{placeholder}</div>
      )}
    </div>
  )
}
```

### 2.2 数据懒加载
```typescript
// apps/web/src/hooks/use-infinite-stocks.ts
import { useInfiniteQuery } from '@tanstack/react-query'
import { trpc } from '../utils/trpc'

export const useInfiniteStocks = () => {
  return useInfiniteQuery({
    queryKey: ['stocks', 'infinite'],
    queryFn: ({ pageParam = 0 }) => 
      trpc.stocks.list.query({ 
        cursor: pageParam,
        limit: 50 
      }),
    getNextPageParam: (lastPage) => lastPage.nextCursor,
    staleTime: 5 * 60 * 1000, // 5分钟缓存
  })
}
```

## 3. 图像优化策略

### 3.1 图像格式优化
```typescript
// apps/web/src/utils/image-optimization.ts
export const optimizeImageUrl = (url: string, options: {
  width?: number
  height?: number
  quality?: number
  format?: 'webp' | 'avif' | 'jpeg'
}) => {
  const { width, height, quality = 80, format = 'webp' } = options
  
  // 使用现代图像格式
  const params = new URLSearchParams()
  if (width) params.append('w', width.toString())
  if (height) params.append('h', height.toString())
  params.append('q', quality.toString())
  params.append('f', format)
  
  return `${url}?${params.toString()}`
}

// 响应式图像尺寸
export const getResponsiveImageSizes = () => ({
  mobile: { width: 375, height: 200 },
  tablet: { width: 768, height: 400 },
  desktop: { width: 1200, height: 600 },
})
```

### 3.2 SVG图标优化
```typescript
// apps/web/src/components/ui/icon.tsx
import { type LucideIcon } from 'lucide-react'

interface IconProps {
  icon: LucideIcon
  size?: number
  className?: string
}

export const Icon = ({ icon: IconComponent, size = 20, className }: IconProps) => {
  return (
    <IconComponent 
      size={size} 
      className={className}
      aria-hidden="true"
    />
  )
}
```

## 4. 缓存策略

### 4.1 浏览器缓存配置
```typescript
// apps/web/vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          ui: ['@radix-ui/react-dialog', '@radix-ui/react-dropdown-menu'],
          charts: ['lightweight-charts'],
          utils: ['date-fns', 'clsx', 'tailwind-merge']
        }
      }
    }
  },
  server: {
    headers: {
      'Cache-Control': 'public, max-age=31536000, immutable'
    }
  }
})
```

### 4.2 Service Worker缓存
```typescript
// apps/web/public/sw.js
const CACHE_NAME = 'neostock-v1'
const STATIC_RESOURCES = [
  '/',
  '/manifest.json',
  // 股票静态数据
  '/api/stocks/metadata'
]

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME).then((cache) => {
      return cache.addAll(STATIC_RESOURCES)
    })
  )
})
```

## 5. 性能监控指标

### 5.1 关键性能指标
```typescript
// apps/web/src/utils/performance-monitoring.ts
export const trackPerformanceMetrics = () => {
  // Core Web Vitals
  const observer = new PerformanceObserver((list) => {
    list.getEntries().forEach((entry) => {
      switch (entry.entryType) {
        case 'largest-contentful-paint':
          console.log('LCP:', entry.startTime)
          break
        case 'first-input':
          console.log('FID:', entry.processingStart - entry.startTime)
          break
        case 'layout-shift':
          if (!entry.hadRecentInput) {
            console.log('CLS:', entry.value)
          }
          break
      }
    })
  })

  observer.observe({ entryTypes: ['largest-contentful-paint', 'first-input', 'layout-shift'] })
}
```

## 6. 性能预算 (Performance Budget)

### 6.1 Bundle大小限制
```json
// apps/web/performance-budget.json
{
  "budget": {
    "initial": "300kb",
    "overall": "1mb",
    "chunks": {
      "vendor": "200kb",
      "charts": "150kb",
      "ui": "100kb"
    }
  },
  "thresholds": {
    "FCP": "2s",
    "LCP": "3s",
    "FID": "100ms",
    "CLS": "0.1"
  }
}
```

## 7. 移动端优化

### 7.1 触屏优化
```css
/* apps/web/src/styles/mobile-optimizations.css */
.touch-optimized {
  /* 增加触摸目标大小 */
  min-height: 44px;
  min-width: 44px;
  
  /* 优化触摸反馈 */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

/* 股票图表触摸优化 */
.chart-container {
  touch-action: pan-x pan-y;
  user-select: none;
}
```

### 7.2 网络优化
```typescript
// apps/web/src/hooks/use-network-status.ts
export const useNetworkStatus = () => {
  const [isOnline, setIsOnline] = useState(navigator.onLine)
  const [connectionType, setConnectionType] = useState<string>()

  useEffect(() => {
    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)
    
    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)
    
    // 检测连接类型
    if ('connection' in navigator) {
      const connection = (navigator as any).connection
      setConnectionType(connection.effectiveType)
    }

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  return { isOnline, connectionType }
}
```

## 8. 实施检查清单

### 开发阶段
- [ ] 实施路由级代码分割
- [ ] 配置图表组件懒加载  
- [ ] 实现图像懒加载组件
- [ ] 配置Vite bundle分析
- [ ] 实施缓存策略

### 测试阶段
- [ ] 性能基准测试
- [ ] 移动端性能测试
- [ ] 网络条件模拟测试
- [ ] Core Web Vitals测试
- [ ] Bundle大小检查

### 部署阶段
- [ ] 配置CDN缓存头
- [ ] 启用Gzip/Brotli压缩
- [ ] 配置Service Worker
- [ ] 性能监控集成
- [ ] 持续性能监控设置

## 9. 性能目标

| 指标 | 目标值 | 当前值 | 状态 |
|------|--------|--------|------|
| FCP (First Contentful Paint) | < 2s | TBD | 🟡 |
| LCP (Largest Contentful Paint) | < 3s | TBD | 🟡 |
| FID (First Input Delay) | < 100ms | TBD | 🟡 |
| CLS (Cumulative Layout Shift) | < 0.1 | TBD | 🟡 |
| Bundle Size (Initial) | < 300kb | TBD | 🟡 |
| Bundle Size (Overall) | < 1mb | TBD | 🟡 |