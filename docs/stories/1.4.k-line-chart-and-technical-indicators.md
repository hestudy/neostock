# Story 1.4: K 线图表和技术指标可视化

## Status

Approved

## Story

**As a** 个人投资者，  
**I want** 能够查看股票的 K 线图和技术指标，  
**so that** 我可以进行技术分析和判断买卖时机。

## Acceptance Criteria

1. **集成轻量级图表库实现 K 线图展示** - 选择并集成适合的轻量级图表库，实现蜡烛图（K线）基础展示功能，支持开高低收价格数据可视化，确保图表渲染性能良好，包体积控制在合理范围内
2. **支持多种技术指标叠加显示（MA、MACD、RSI 等）** - 实现移动平均线（MA5、MA10、MA20、MA60）技术指标，支持 MACD 指标（DIF、DEA、柱状图）叠加显示，集成 RSI 相对强弱指标，提供技术指标的显示/隐藏切换功能
3. **实现图表的缩放、平移等交互功能** - 支持鼠标滚轮缩放时间轴，实现图表水平拖拽平移查看历史数据，提供十字光标显示精确价格和时间信息，支持双击重置视图到默认状态
4. **优化移动端图表显示和触屏操作体验** - 适配移动端屏幕尺寸，实现触摸手势支持（缩放、平移），优化图表在移动设备上的性能表现，确保移动端操作流畅不卡顿
5. **保持与现有 UI 主题和颜色系统的一致性** - 图表颜色与现有深色/浅色主题自动同步，保持与 shadcn/ui 组件的设计风格一致，支持用户主题切换时图表颜色自动更新

## Tasks / Subtasks

**⚠️ 执行顺序说明：任务按序号顺序执行，任务间存在依赖关系，必须严格遵守执行顺序**

### Phase 1: 图表库选择和基础架构 (依赖：Story 1.3 股票数据系统完成)

- [ ] **Task 1**: 图表库评估和选型 (AC: 1)
  - [ ] 1.1 评估 lightweight-charts、echarts、chart.js 等轻量级图表库
  - [ ] 1.2 基于 bundle 大小、性能、功能完整性进行对比分析
  - [ ] 1.3 确定最终图表库选择并完成依赖安装
  - [ ] 1.4 创建图表库的 TypeScript 类型定义集成

- [ ] **Task 2**: 图表组件架构设计 (AC: 1, 5) **[依赖: Task 1 完成]**
  - [ ] 2.1 设计可复用的图表基础组件架构
  - [ ] 2.2 实现图表主题系统集成（深色/浅色模式）
  - [ ] 2.3 创建图表数据格式转换器和验证器
  - [ ] 2.4 建立图表组件的性能监控和错误处理机制

### Phase 2: K 线图核心功能实现 (依赖：Phase 1 完成)

- [ ] **Task 3**: K 线图基础组件开发 (AC: 1) **[依赖: Task 2 完成]**
  - [ ] 3.1 实现蜡烛图（K线）基础渲染组件
  - [ ] 3.2 集成股票日线数据到图表显示
  - [ ] 3.3 添加成交量显示功能
  - [ ] 3.4 实现图表时间轴和价格轴格式化

- [ ] **Task 4**: 技术指标计算引擎 (AC: 2) **[依赖: Task 3 完成]**
  - [ ] 4.1 实现 MA 移动平均线计算算法
  - [ ] 4.2 开发 MACD 指标计算逻辑
  - [ ] 4.3 集成 RSI 相对强弱指标计算
  - [ ] 4.4 创建技术指标数据缓存机制

### Phase 3: 交互功能和移动端优化 (依赖：Phase 2 完成)

- [ ] **Task 5**: 图表交互功能实现 (AC: 3) **[依赖: Task 4 完成]**
  - [ ] 5.1 实现鼠标滚轮缩放功能
  - [ ] 5.2 开发图表拖拽平移功能
  - [ ] 5.3 添加十字光标和价格时间提示
  - [ ] 5.4 实现双击重置视图功能

- [ ] **Task 6**: 移动端适配和优化 (AC: 4) **[依赖: Task 5 完成]**
  - [ ] 6.1 实现触摸手势支持（缩放、平移）
  - [ ] 6.2 优化移动端图表渲染性能
  - [ ] 6.3 适配不同屏幕尺寸的响应式布局
  - [ ] 6.4 解决移动端图表操作与页面导航冲突

### Phase 4: 集成测试和性能优化 (依赖：Phase 3 完成)

- [ ] **Task 7**: 技术指标叠加功能 (AC: 2) **[依赖: Task 6 完成]**
  - [ ] 7.1 实现技术指标的显示/隐藏切换
  - [ ] 7.2 开发多指标同时叠加显示功能
  - [ ] 7.3 优化多指标显示的性能表现
  - [ ] 7.4 创建技术指标参数配置界面

- [ ] **Task 8**: 全面测试和性能验证 (AC: 1, 3, 4) **[依赖: Task 7 完成]**
  - [ ] 8.1 验证图表渲染性能（<100ms）
  - [ ] 8.2 测试大量数据下的图表流畅度
  - [ ] 8.3 验证移动端触摸操作体验
  - [ ] 8.4 执行图表功能的端到端测试

### 关键依赖关系说明

- **Phase 1 → Phase 2**: 必须先建立图表基础架构，才能实现K线图功能
- **Task 3 → Task 4**: K线基础显示完成后，才能计算和显示技术指标
- **Task 5 → Task 6**: 桌面端交互功能完成后，才能进行移动端适配
- **关键阻塞点**: 如果 Task 1 (图表库选型) 失败，后续所有图表功能都会被阻塞

## Dev Notes

### 前一个故事的洞察

基于 Story 1.3 的完成记录，股票搜索和详情页面系统已经建立，具备：

- 完整的股票数据获取 API (4000只A股数据)
- 高性能搜索系统（<100ms响应）
- 实时数据更新机制
- 响应式设计和移动端优化
- 完整的测试覆盖和质量保证

### 数据模型

当前可用的数据结构 [Source: docs/stories/1.3.stock-search-and-detail-pages.md#数据模型]：

```typescript
// 股票基础信息 - 已在 Story 1.1/1.2/1.3 中建立
interface StockBasicInfo {
  ts_code: string; // 股票代码 (如: "000001.SZ")
  symbol: string; // 股票符号
  name: string; // 股票名称
  area: string; // 地域
  industry: string; // 所属行业
  market: string; // 市场类型 (主板/创业板)
  list_date: string; // 上市日期 (YYYYMMDD格式)
  is_hs: string; // 是否沪深港通标的
}

// 日线数据 - 已在 Story 1.1/1.2 中建立，Story 1.3 完善了实时更新
interface StockDailyData {
  id: number;
  ts_code: string; // 股票代码，外键关联 stocks.ts_code
  trade_date: string; // 交易日期 (YYYYMMDD格式)
  open: number; // 开盘价
  high: number; // 最高价
  low: number; // 最低价
  close: number; // 收盘价
  vol: number; // 成交量
  amount: number; // 成交额
}

// 技术指标计算结果 - 新增接口
interface TechnicalIndicators {
  ts_code: string;
  trade_date: string;
  ma5?: number; // 5日移动平均线
  ma10?: number; // 10日移动平均线
  ma20?: number; // 20日移动平均线
  ma60?: number; // 60日移动平均线
  macd_dif?: number; // MACD DIF线
  macd_dea?: number; // MACD DEA线
  macd_hist?: number; // MACD柱状图
  rsi_6?: number; // 6日RSI
  rsi_12?: number; // 12日RSI
  rsi_24?: number; // 24日RSI
}
```

### API 规范

需要扩展的前端 API 调用 [Source: docs/stories/1.3.stock-search-and-detail-pages.md#API规范]：

```typescript
// 基于现有 tRPC 客户端架构
// apps/web/src/utils/trpc.ts 中的客户端调用

// 图表数据相关 - 新增
- trpc.stocks.getStockChartData.query({
    ts_code: string,
    start_date?: string,
    end_date?: string,
    indicators?: string[] // ['ma', 'macd', 'rsi']
  })
- trpc.stocks.getTechnicalIndicators.query({
    ts_code: string,
    indicator_type: string,
    period?: number
  })

// 现有API复用 - 已在 Story 1.3 中实现
- trpc.stocks.getStockDetail.query({ ts_code: string }) // 获取股票基本信息
- trpc.stocks.getStockDailyData.query({ ts_code: string, start_date?: string, end_date?: string }) // 获取历史数据
```

### 组件规范

基于现有 shadcn/ui 组件系统 [Source: docs/architecture/源码树和模块组织.md#前端架构]：

#### 图表组件架构

```typescript
// apps/web/src/components/charts/ - 新增图表组件目录
(-k -
  line -
  chart.tsx - // K线图主组件
  technical -
  indicators.tsx - // 技术指标组件
  chart -
  toolbar.tsx - // 图表工具栏
  chart -
  tooltip.tsx - // 图表提示框
  chart -
  cursor.tsx - // 十字光标组件
  // apps/web/src/components/ui/ - 基础 UI 组件（已存在）
  Button,
  Card,
  Badge,
  Skeleton,
  DropdownMenu - // 复用现有组件
    Select,
  Switch - // 用于指标配置
    // apps/web/src/lib/ - 图表工具库
    chart -
    utils.ts - // 图表数据处理工具
    technical -
    indicators -
    calculator.ts - // 技术指标计算引擎
    chart -
    theme.ts); // 图表主题配置
```

### 文件位置

基于项目结构 [Source: docs/architecture/源码树和模块组织.md#项目结构实际]：

#### 前端图表组件

- K线图组件: `apps/web/src/components/charts/k-line-chart.tsx`
- 技术指标组件: `apps/web/src/components/charts/technical-indicators.tsx`
- 图表工具栏: `apps/web/src/components/charts/chart-toolbar.tsx`
- 图表工具库: `apps/web/src/lib/chart-utils.ts`
- 技术指标计算: `apps/web/src/lib/technical-indicators-calculator.ts`

#### 股票详情页集成

- 股票详情页增强: `apps/web/src/routes/stocks/$symbol.tsx` (修改)
- 股票页面Hook: `apps/web/src/hooks/use-stock-chart.ts` (新增)

#### 后端API扩展

- 图表数据API: `apps/server/src/routers/stocks.ts` (扩展)
- 技术指标计算: `apps/server/src/lib/technical-indicators.ts` (新增)

#### 样式和类型

- 图表样式: `apps/web/src/styles/charts.css` (新增)
- 图表类型: `apps/web/src/types/charts.ts` (新增)

### 技术约束

[Source: docs/architecture/高级架构.md#实际技术栈来自-packagejson]

- **前端框架**: React 19.0.0
- **路由**: TanStack Router 1.114.25
- **状态管理**: TanStack Query 5.80.5
- **UI 组件**: shadcn/ui + Radix UI + TailwindCSS 4.0.15
- **构建工具**: Vite 6.2.2
- **图表库**: 待评估选择 (lightweight-charts/echarts/chart.js)
- **Bundle大小**: 图表库<150KB，整体前端包增长<20%
- **性能要求**: 图表渲染<100ms，交互响应<50ms

### 图表库选择策略

[Source: docs/architecture/前端性能优化策略.md#代码分割策略]

#### 评估标准

- **Bundle大小**: <150KB (gzipped)
- **性能**: 大数据量(1000+数据点)渲染<100ms
- **功能**: 支持K线、技术指标、交互操作
- **移动端**: 支持触摸手势和响应式
- **TypeScript**: 完整类型定义
- **维护性**: 活跃维护和社区支持

#### 候选图表库对比

1. **lightweight-charts** (TradingView)
   - 优点: 轻量(~100KB)，性能优秀，专为金融图表设计
   - 缺点: 功能相对基础，定制化要求高

2. **echarts**
   - 优点: 功能丰富，中文文档好，社区活跃
   - 缺点: 包体积较大(~300KB)，学习曲线陡峭

3. **chart.js**
   - 优点: 易于使用，插件生态丰富
   - 缺点: 金融图表功能较弱，需要大量定制

#### 推荐选择

基于性能和Bundle大小要求，**推荐选择 lightweight-charts**，通过自定义扩展实现技术指标功能。

### 性能优化策略

[Source: docs/architecture/前端性能优化策略.md]

#### 图表组件懒加载

```typescript
// 路由级懒加载
const KLineChart = lazy(() => import("../../components/charts/k-line-chart"));
const TechnicalIndicators = lazy(
  () => import("../../components/charts/technical-indicators")
);

// 图表库按需加载
export const ChartLibrary = lazy(async () => {
  const [lightweightCharts] = await Promise.all([import("lightweight-charts")]);
  return { default: lightweightCharts };
});
```

#### 数据缓存策略

```typescript
// 使用 TanStack Query 缓存图表数据
const { data: chartData } = useQuery({
  queryKey: ["stocks", "chart", symbol, startDate, endDate],
  queryFn: () =>
    trpc.stocks.getStockChartData.query({
      ts_code: symbol,
      start_date: startDate,
      end_date: endDate,
    }),
  staleTime: 5 * 60 * 1000, // 5分钟缓存
  cacheTime: 30 * 60 * 1000, // 30分钟保持
});
```

#### 移动端优化

```css
/* 触摸优化 */
.chart-container {
  touch-action: pan-x pan-y;
  user-select: none;
  -webkit-touch-callout: none;
}

/* 防止双击缩放 */
.chart-container * {
  touch-action: manipulation;
}
```

### 主题系统集成

[Source: docs/architecture/前端性能优化策略.md#移动端优化]

#### 图表主题配置

```typescript
// apps/web/src/lib/chart-theme.ts
export const getChartTheme = (mode: "light" | "dark") => ({
  background: mode === "dark" ? "#1a1a1a" : "#ffffff",
  grid: {
    color: mode === "dark" ? "#2a2a2a" : "#e0e0e0",
  },
  candle: {
    upColor: "#26a69a",
    downColor: "#ef5350",
    borderUpColor: "#26a69a",
    borderDownColor: "#ef5350",
  },
  // ... 更多主题配置
});
```

#### 主题切换集成

```typescript
// 监听主题变化
const { theme } = useTheme();
const chartTheme = getChartTheme(theme);

// 图表配置中使用主题
const chartOptions = {
  ...chartTheme,
  // 其他图表配置
};
```

### Testing

#### 测试框架和位置

**测试技术栈** [Source: docs/architecture/测试策略.md]：

- **前端测试**: Vitest + Testing Library
- **E2E 测试**: Playwright
- **性能测试**: Lighthouse + Web Vitals
- **覆盖率要求**: 组件测试 >85%，图表功能 >90%

**测试文件位置**：

- **图表组件测试**: `apps/web/src/components/charts/__tests__/`
- **图表工具测试**: `apps/web/src/lib/__tests__/`
- **页面集成测试**: `apps/web/src/routes/__tests__/`
- **E2E 测试**: `tests/e2e/charts/` (图表功能流程)
- **性能测试**: `tests/performance/charts/` (图表渲染性能)

#### 核心测试要求

**图表功能测试**

- 验证K线图正确渲染开高低收数据
- 测试技术指标计算准确性 (MA、MACD、RSI)
- 验证图表缩放、平移交互功能
- 测试十字光标和价格提示功能

**性能测试**

- 验证图表渲染性能 (<100ms)
- 测试大数据量下的流畅度 (1000+数据点)
- 验证移动端触摸操作响应时间 (<50ms)
- 测试内存使用情况，防止内存泄漏

**移动端测试**

- 验证触摸手势识别准确性
- 测试不同屏幕尺寸的适配
- 验证移动端图表渲染性能
- 测试与现有页面导航的兼容性

**主题切换测试**

- 验证深色/浅色主题切换时图表颜色同步
- 测试自定义主题配置的正确应用
- 验证主题切换时的性能表现

**集成测试**

- 验证图表组件与股票详情页的集成
- 测试实时数据更新时图表的响应
- 验证技术指标的显示/隐藏切换功能
- 测试图表工具栏的操作流程

## Change Log

| Date       | Version | Description                                             | Author             |
| ---------- | ------- | ------------------------------------------------------- | ------------------ |
| 2025-09-02 | 1.0     | 初始故事创建，基于 Epic 1 验收标准和 Story 1.3 完成洞察 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-20250514

### Debug Log References

### Completion Notes List

### File List

#### 新增文件

#### 修改文件

## QA Results

### Review Date
2025-09-02

### Reviewed By
Quinn (Test Architect)

### Code Quality Assessment
**Critical Issue**: Complete lack of test coverage for all chart functionality

### Refactoring Performed
N/A - No code to review due to missing implementation

### Compliance Check
❌ **FAIL** - 0% test coverage, does not meet project quality standards

### Improvements Checklist
- [ ] Create K-line chart component tests
- [ ] Implement technical indicator calculation tests
- [ ] Add chart interaction functionality tests
- [ ] Create mobile adaptation tests
- [ ] Implement theme system integration tests
- [ ] Add performance benchmark tests
- [ ] Establish E2E user journey tests

### Security Review
N/A - No implementation to review

### Performance Considerations
- No performance tests exist
- Critical requirement: <100ms rendering time unverified
- Bundle size constraints not validated
- Mobile performance not tested

### Files Modified During Review
- Created: `docs/qa/assessments/1.4-trace-20250902.md`
- Created: `docs/qa/gates/1.4-k-line-chart-and-technical-indicators-FAIL.yaml`

### Gate Status
❌ **FAIL** - Complete lack of test coverage

### Recommended Status
**BLOCKED** - Must implement minimum test suite before proceeding

### Trace Analysis Summary
- **Total Requirements**: 5
- **Fully Covered**: 0 (0%)
- **Partially Covered**: 0 (0%)
- **Not Covered**: 5 (100%)
- **Critical Risk**: High - Core financial functionality untested
