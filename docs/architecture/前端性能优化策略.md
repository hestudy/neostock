# å‰ç«¯æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

## 1. ä»£ç åˆ†å‰² (Code Splitting) ç­–ç•¥

### 1.1 è·¯ç”±çº§ä»£ç åˆ†å‰²
```typescript
// apps/web/src/routes/stocks/index.tsx
import { lazy } from 'react'

// æ‡’åŠ è½½è‚¡ç¥¨ç›¸å…³ç»„ä»¶
const StockChart = lazy(() => import('../../components/stock-chart'))
const BacktestResults = lazy(() => import('../../components/backtest-results'))
const StrategyBuilder = lazy(() => import('../../components/strategy-builder'))

// ä½¿ç”¨ Suspense åŒ…è£…
<Suspense fallback={<div className="flex justify-center p-4">
  <div className="animate-spin h-6 w-6 border-b-2 border-primary"></div>
</div>}>
  <StockChart />
</Suspense>
```

### 1.2 å›¾è¡¨ç»„ä»¶åˆ†å‰²ç­–ç•¥
```typescript
// apps/web/src/components/charts/index.ts
export const KLineChart = lazy(() => import('./k-line-chart'))
export const TechnicalIndicators = lazy(() => import('./technical-indicators'))
export const VolumeChart = lazy(() => import('./volume-chart'))

// æŒ‰éœ€åŠ è½½å›¾è¡¨åº“
export const ChartLibrary = lazy(async () => {
  const [lightweightCharts] = await Promise.all([
    import('lightweight-charts'),
  ])
  return { default: lightweightCharts }
})
```

### 1.3 Bundle åˆ†æå’Œä¼˜åŒ–
```json
// package.json
{
  "scripts": {
    "analyze": "npx vite-bundle-analyzer",
    "build:analyze": "ANALYZE=true bun run build"
  }
}
```

## 2. æ‡’åŠ è½½ (Lazy Loading) å®æ–½

### 2.1 å›¾åƒæ‡’åŠ è½½
```typescript
// apps/web/src/components/ui/lazy-image.tsx
import { useState, useRef, useEffect } from 'react'

interface LazyImageProps {
  src: string
  alt: string
  className?: string
  placeholder?: string
}

export const LazyImage = ({ src, alt, className, placeholder }: LazyImageProps) => {
  const [isLoaded, setIsLoaded] = useState(false)
  const [isInView, setIsInView] = useState(false)
  const imgRef = useRef<HTMLImageElement>(null)

  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          setIsInView(true)
          observer.disconnect()
        }
      },
      { threshold: 0.1 }
    )

    if (imgRef.current) {
      observer.observe(imgRef.current)
    }

    return () => observer.disconnect()
  }, [])

  return (
    <div ref={imgRef} className={className}>
      {isInView && (
        <img
          src={src}
          alt={alt}
          onLoad={() => setIsLoaded(true)}
          className={`transition-opacity duration-300 ${
            isLoaded ? 'opacity-100' : 'opacity-0'
          }`}
        />
      )}
      {!isLoaded && placeholder && (
        <div className="bg-muted animate-pulse rounded">{placeholder}</div>
      )}
    </div>
  )
}
```

### 2.2 æ•°æ®æ‡’åŠ è½½
```typescript
// apps/web/src/hooks/use-infinite-stocks.ts
import { useInfiniteQuery } from '@tanstack/react-query'
import { trpc } from '../utils/trpc'

export const useInfiniteStocks = () => {
  return useInfiniteQuery({
    queryKey: ['stocks', 'infinite'],
    queryFn: ({ pageParam = 0 }) => 
      trpc.stocks.list.query({ 
        cursor: pageParam,
        limit: 50 
      }),
    getNextPageParam: (lastPage) => lastPage.nextCursor,
    staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿç¼“å­˜
  })
}
```

## 3. å›¾åƒä¼˜åŒ–ç­–ç•¥

### 3.1 å›¾åƒæ ¼å¼ä¼˜åŒ–
```typescript
// apps/web/src/utils/image-optimization.ts
export const optimizeImageUrl = (url: string, options: {
  width?: number
  height?: number
  quality?: number
  format?: 'webp' | 'avif' | 'jpeg'
}) => {
  const { width, height, quality = 80, format = 'webp' } = options
  
  // ä½¿ç”¨ç°ä»£å›¾åƒæ ¼å¼
  const params = new URLSearchParams()
  if (width) params.append('w', width.toString())
  if (height) params.append('h', height.toString())
  params.append('q', quality.toString())
  params.append('f', format)
  
  return `${url}?${params.toString()}`
}

// å“åº”å¼å›¾åƒå°ºå¯¸
export const getResponsiveImageSizes = () => ({
  mobile: { width: 375, height: 200 },
  tablet: { width: 768, height: 400 },
  desktop: { width: 1200, height: 600 },
})
```

### 3.2 SVGå›¾æ ‡ä¼˜åŒ–
```typescript
// apps/web/src/components/ui/icon.tsx
import { type LucideIcon } from 'lucide-react'

interface IconProps {
  icon: LucideIcon
  size?: number
  className?: string
}

export const Icon = ({ icon: IconComponent, size = 20, className }: IconProps) => {
  return (
    <IconComponent 
      size={size} 
      className={className}
      aria-hidden="true"
    />
  )
}
```

## 4. ç¼“å­˜ç­–ç•¥

### 4.1 æµè§ˆå™¨ç¼“å­˜é…ç½®
```typescript
// apps/web/vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          ui: ['@radix-ui/react-dialog', '@radix-ui/react-dropdown-menu'],
          charts: ['lightweight-charts'],
          utils: ['date-fns', 'clsx', 'tailwind-merge']
        }
      }
    }
  },
  server: {
    headers: {
      'Cache-Control': 'public, max-age=31536000, immutable'
    }
  }
})
```

### 4.2 Service Workerç¼“å­˜
```typescript
// apps/web/public/sw.js
const CACHE_NAME = 'neostock-v1'
const STATIC_RESOURCES = [
  '/',
  '/manifest.json',
  // è‚¡ç¥¨é™æ€æ•°æ®
  '/api/stocks/metadata'
]

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME).then((cache) => {
      return cache.addAll(STATIC_RESOURCES)
    })
  )
})
```

## 5. æ€§èƒ½ç›‘æ§æŒ‡æ ‡

### 5.1 å…³é”®æ€§èƒ½æŒ‡æ ‡
```typescript
// apps/web/src/utils/performance-monitoring.ts
export const trackPerformanceMetrics = () => {
  // Core Web Vitals
  const observer = new PerformanceObserver((list) => {
    list.getEntries().forEach((entry) => {
      switch (entry.entryType) {
        case 'largest-contentful-paint':
          console.log('LCP:', entry.startTime)
          break
        case 'first-input':
          console.log('FID:', entry.processingStart - entry.startTime)
          break
        case 'layout-shift':
          if (!entry.hadRecentInput) {
            console.log('CLS:', entry.value)
          }
          break
      }
    })
  })

  observer.observe({ entryTypes: ['largest-contentful-paint', 'first-input', 'layout-shift'] })
}
```

## 6. æ€§èƒ½é¢„ç®— (Performance Budget)

### 6.1 Bundleå¤§å°é™åˆ¶
```json
// apps/web/performance-budget.json
{
  "budget": {
    "initial": "300kb",
    "overall": "1mb",
    "chunks": {
      "vendor": "200kb",
      "charts": "150kb",
      "ui": "100kb"
    }
  },
  "thresholds": {
    "FCP": "2s",
    "LCP": "3s",
    "FID": "100ms",
    "CLS": "0.1"
  }
}
```

## 7. ç§»åŠ¨ç«¯ä¼˜åŒ–

### 7.1 è§¦å±ä¼˜åŒ–
```css
/* apps/web/src/styles/mobile-optimizations.css */
.touch-optimized {
  /* å¢åŠ è§¦æ‘¸ç›®æ ‡å¤§å° */
  min-height: 44px;
  min-width: 44px;
  
  /* ä¼˜åŒ–è§¦æ‘¸åé¦ˆ */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

/* è‚¡ç¥¨å›¾è¡¨è§¦æ‘¸ä¼˜åŒ– */
.chart-container {
  touch-action: pan-x pan-y;
  user-select: none;
}
```

### 7.2 ç½‘ç»œä¼˜åŒ–
```typescript
// apps/web/src/hooks/use-network-status.ts
export const useNetworkStatus = () => {
  const [isOnline, setIsOnline] = useState(navigator.onLine)
  const [connectionType, setConnectionType] = useState<string>()

  useEffect(() => {
    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)
    
    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)
    
    // æ£€æµ‹è¿æ¥ç±»å‹
    if ('connection' in navigator) {
      const connection = (navigator as any).connection
      setConnectionType(connection.effectiveType)
    }

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  return { isOnline, connectionType }
}
```

## 8. å®æ–½æ£€æŸ¥æ¸…å•

### å¼€å‘é˜¶æ®µ
- [ ] å®æ–½è·¯ç”±çº§ä»£ç åˆ†å‰²
- [ ] é…ç½®å›¾è¡¨ç»„ä»¶æ‡’åŠ è½½  
- [ ] å®ç°å›¾åƒæ‡’åŠ è½½ç»„ä»¶
- [ ] é…ç½®Vite bundleåˆ†æ
- [ ] å®æ–½ç¼“å­˜ç­–ç•¥

### æµ‹è¯•é˜¶æ®µ
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] ç§»åŠ¨ç«¯æ€§èƒ½æµ‹è¯•
- [ ] ç½‘ç»œæ¡ä»¶æ¨¡æ‹Ÿæµ‹è¯•
- [ ] Core Web Vitalsæµ‹è¯•
- [ ] Bundleå¤§å°æ£€æŸ¥

### éƒ¨ç½²é˜¶æ®µ
- [ ] é…ç½®CDNç¼“å­˜å¤´
- [ ] å¯ç”¨Gzip/Brotliå‹ç¼©
- [ ] é…ç½®Service Worker
- [ ] æ€§èƒ½ç›‘æ§é›†æˆ
- [ ] æŒç»­æ€§èƒ½ç›‘æ§è®¾ç½®

## 9. æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| FCP (First Contentful Paint) | < 2s | TBD | ğŸŸ¡ |
| LCP (Largest Contentful Paint) | < 3s | TBD | ğŸŸ¡ |
| FID (First Input Delay) | < 100ms | TBD | ğŸŸ¡ |
| CLS (Cumulative Layout Shift) | < 0.1 | TBD | ğŸŸ¡ |
| Bundle Size (Initial) | < 300kb | TBD | ğŸŸ¡ |
| Bundle Size (Overall) | < 1mb | TBD | ğŸŸ¡ |