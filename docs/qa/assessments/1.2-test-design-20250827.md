# Test Design: Story 1.2 - Tushare 数据源集成和定时数据拉取

Date: 2025-08-27
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 42
- Unit tests: 18 (43%)
- Integration tests: 17 (40%)
- E2E tests: 7 (17%)
- Priority distribution: P0: 25, P1: 12, P2: 4, P3: 1

## Test Scenarios by Acceptance Criteria

### AC1: 主数据源安全集成
*集成 tushare pro API，实现股票基础信息和日线数据获取，创建定时任务，每日下午 5 点自动拉取当日数据，实现 API 密钥加密存储和轮换机制*

#### Scenarios

| ID            | Level       | Priority | Test                                    | Justification                  |
| ------------- | ----------- | -------- | --------------------------------------- | ------------------------------ |
| 1.2-UNIT-001  | Unit        | P0       | Validate Tushare API request format    | 纯逻辑验证，输入格式检查       |
| 1.2-UNIT-002  | Unit        | P0       | Test API response data parsing         | 数据转换逻辑，算法复杂度高     |
| 1.2-UNIT-003  | Unit        | P1       | Validate stock code format conversion  | 业务逻辑，股票代码标准化       |
| 1.2-INT-001   | Integration | P0       | Tushare API connectivity test          | 外部系统集成，网络调用         |
| 1.2-INT-002   | Integration | P0       | Stock basic info data fetch            | 数据库写入操作，持久化验证     |
| 1.2-INT-003   | Integration | P0       | Daily data fetch with pagination       | 分页处理，大批量数据处理       |
| 1.2-INT-004   | Integration | P1       | Scheduler triggers data sync at 17:00  | 定时任务组件交互               |
| 1.2-E2E-001   | E2E         | P0       | Complete daily data sync workflow      | 关键用户场景，端到端数据流     |

### AC2: 备用数据源策略  
*集成至少一个免费备用数据源 API，实现主备数据源自动切换机制，建立数据源健康检查和故障检测，配置数据源优先级和负载均衡*

#### Scenarios

| ID            | Level       | Priority | Test                                    | Justification                  |
| ------------- | ----------- | -------- | --------------------------------------- | ------------------------------ |
| 1.2-UNIT-004  | Unit        | P1       | Data source priority ranking logic     | 算法逻辑，优先级计算           |
| 1.2-UNIT-005  | Unit        | P0       | Failover decision making algorithm      | 关键业务逻辑，故障切换算法     |
| 1.2-UNIT-006  | Unit        | P1       | Health check scoring calculation       | 健康状态评分算法               |
| 1.2-INT-005   | Integration | P0       | Sina Finance API connectivity          | 备用数据源集成                 |
| 1.2-INT-006   | Integration | P0       | Auto-failover between data sources     | 多组件交互，故障切换机制       |
| 1.2-INT-007   | Integration | P1       | Data source health monitoring          | 监控系统集成                   |
| 1.2-INT-008   | Integration | P1       | Load balancing between sources         | 负载均衡策略                   |
| 1.2-E2E-002   | E2E         | P0       | Primary source fails, switches to backup | 关键故障恢复场景             |

### AC3: 数据质量保证增强
*实现多层数据验证逻辑，建立数据清洗机制，处理异常数据和缺失值，实现跨数据源一致性验证，建立数据质量评分系统*

#### Scenarios

| ID            | Level       | Priority | Test                                    | Justification                  |
| ------------- | ----------- | -------- | --------------------------------------- | ------------------------------ |
| 1.2-UNIT-007  | Unit        | P0       | Stock price range validation           | 数据完整性，价格合理性检查     |
| 1.2-UNIT-008  | Unit        | P0       | Date format validation                 | 输入验证，格式标准化           |
| 1.2-UNIT-009  | Unit        | P0       | Volume and amount logical consistency  | 复杂业务逻辑，数据一致性       |
| 1.2-UNIT-010  | Unit        | P1       | Data quality scoring algorithm         | 评分算法，复杂计算逻辑         |
| 1.2-UNIT-011  | Unit        | P1       | Missing data interpolation logic       | 数据清洗算法，缺失值处理       |
| 1.2-INT-009   | Integration | P0       | Cross-source data consistency check    | 多数据源对比验证               |
| 1.2-INT-010   | Integration | P0       | Data cleaning pipeline                 | 数据处理流水线                 |
| 1.2-E2E-003   | E2E         | P1       | Complete data quality validation flow  | 端到端数据质量保证             |

### AC4: 错误处理和重试优化
*实现智能重试机制，包含指数退避策略，建立错误分类和处理机制，实现数据拉取失败的通知和日志记录，配置错误恢复策略*

#### Scenarios

| ID            | Level       | Priority | Test                                    | Justification                  |
| ------------- | ----------- | -------- | --------------------------------------- | ------------------------------ |
| 1.2-UNIT-012  | Unit        | P0       | Exponential backoff calculation        | 算法复杂度，重试策略计算       |
| 1.2-UNIT-013  | Unit        | P0       | Error classification logic             | 错误处理业务逻辑               |
| 1.2-UNIT-014  | Unit        | P1       | Retry jitter randomization             | 随机化算法，防止惊群效应       |
| 1.2-INT-011   | Integration | P0       | Network timeout error handling         | 网络异常处理                   |
| 1.2-INT-012   | Integration | P0       | API rate limit error recovery          | API 限制处理                   |
| 1.2-INT-013   | Integration | P1       | Error notification system              | 通知系统集成                   |
| 1.2-INT-014   | Integration | P1       | Error logging and audit trail          | 审计日志系统                   |
| 1.2-E2E-004   | E2E         | P1       | Complete error recovery workflow       | 错误恢复用户场景               |

### AC5: 缓存和性能优化
*实现本地数据缓存机制，建立增量数据更新策略，优化数据拉取批次大小和频率，实现缓存失效和更新策略*

#### Scenarios

| ID            | Level       | Priority | Test                                    | Justification                  |
| ------------- | ----------- | -------- | --------------------------------------- | ------------------------------ |
| 1.2-UNIT-015  | Unit        | P1       | Cache key generation algorithm         | 缓存键生成逻辑                 |
| 1.2-UNIT-016  | Unit        | P1       | Cache invalidation logic               | 缓存失效策略算法               |
| 1.2-UNIT-017  | Unit        | P2       | Batch size optimization calculation    | 批处理优化算法                 |
| 1.2-INT-015   | Integration | P0       | Cache hit performance test             | 缓存性能，系统响应时间         |
| 1.2-INT-016   | Integration | P1       | Incremental data update mechanism      | 增量更新策略                   |
| 1.2-INT-017   | Integration | P1       | Memory cache vs database performance   | 性能对比测试                   |
| 1.2-E2E-005   | E2E         | P0       | 4000 stocks data fetch <10min target  | 性能需求验证，关键指标         |

### AC6: 安全 API 扩展
*扩展 tRPC router 添加数据管理相关 API 端点，实现数据源状态查询和手动触发接口，添加 API 访问权限控制和审计日志，实现 API 调用频率限制*

#### Scenarios

| ID            | Level       | Priority | Test                                    | Justification                  |
| ------------- | ----------- | -------- | --------------------------------------- | ------------------------------ |
| 1.2-UNIT-018  | Unit        | P1       | API rate limiting algorithm            | 频率限制算法                   |
| 1.2-INT-018   | Integration | P0       | tRPC router endpoint contracts         | API 合约验证                   |
| 1.2-INT-019   | Integration | P0       | Authentication middleware integration  | 认证系统集成                   |
| 1.2-INT-020   | Integration | P1       | API audit logging                      | 审计日志记录                   |
| 1.2-E2E-006   | E2E         | P1       | Admin user manages data sources        | 管理员工作流                   |
| 1.2-E2E-007   | E2E         | P2       | Regular user query restrictions        | 权限控制用户场景               |

### AC7: 凭据安全管理
*实现 tushare API token 安全存储，建立 API 密钥泄露检测机制，配置密钥访问审计日志，实现密钥定期轮换(90天周期)*

#### Scenarios

| ID            | Level       | Priority | Test                                    | Justification                  |
| ------------- | ----------- | -------- | --------------------------------------- | ------------------------------ |
| 1.2-INT-021   | Integration | P0       | API key encryption storage             | 安全存储，加密机制             |
| 1.2-INT-022   | Integration | P0       | Key rotation mechanism (90-day cycle)  | 密钥轮换策略                   |
| 1.2-INT-023   | Integration | P0       | Key leak detection alerts              | 安全检测系统                   |
| 1.2-INT-024   | Integration | P2       | Key access audit logging               | 审计日志功能                   |

## Risk Coverage

基于故事复杂性和业务影响的风险识别：

### High Risk (P0 Tests)
- **RISK-001**: Tushare API 连接失败导致数据更新中断 → 1.2-INT-001, 1.2-E2E-001
- **RISK-002**: 数据质量问题影响投资决策准确性 → 1.2-UNIT-007~009, 1.2-INT-009~010
- **RISK-003**: API 密钥泄露造成安全风险 → 1.2-INT-021~023
- **RISK-004**: 系统性能不满足4000股票<10分钟要求 → 1.2-E2E-005, 1.2-INT-015

### Medium Risk (P1 Tests)  
- **RISK-005**: 备用数据源切换机制故障 → 1.2-INT-006~008
- **RISK-006**: 错误处理不当导致数据丢失 → 1.2-INT-011~014

## Recommended Execution Order

### Phase 1: 基础功能验证 (P0 Unit + Integration)
1. 1.2-UNIT-001~003, 1.2-UNIT-007~009, 1.2-UNIT-012~013 (快速反馈核心逻辑)
2. 1.2-INT-001~003, 1.2-INT-009~012, 1.2-INT-015, 1.2-INT-018~019, 1.2-INT-021~023

### Phase 2: 关键用户场景 (P0 E2E)
3. 1.2-E2E-001, 1.2-E2E-002, 1.2-E2E-005 (关键路径验证)

### Phase 3: 高价值功能 (P1 Tests)
4. P1 Unit tests: 1.2-UNIT-004~006, 1.2-UNIT-010~011, 1.2-UNIT-014~016
5. P1 Integration tests: 1.2-INT-004~008, 1.2-INT-013~014, 1.2-INT-016~017, 1.2-INT-020
6. P1 E2E tests: 1.2-E2E-003~004, 1.2-E2E-006

### Phase 4: 补充验证 (P2-P3 Tests)
7. 所有 P2 和 P3 测试 (时间允许时)

## Quality Checklist

验证完成情况：

- [x] 每个 AC 都有测试覆盖 (7个AC，42个测试场景)
- [x] 测试级别分配合理 (Unit:43%, Integration:40%, E2E:17%)
- [x] 没有跨级别重复覆盖 (每个场景测试不同方面)
- [x] 优先级与业务风险对齐 (25个P0覆盖关键风险)
- [x] 测试ID遵循命名约定 (1.2-{LEVEL}-{SEQ}格式)
- [x] 场景原子化且独立 (每个测试场景可独立执行)

## Key Principles Applied

- **Shift left**: 43% 单元测试优先覆盖核心逻辑
- **Risk-based**: P0 测试优先覆盖数据完整性、安全性和性能风险  
- **Efficient coverage**: 避免重复，单元测试算法逻辑，集成测试组件交互，E2E测试关键路径
- **Maintainability**: 测试场景原子化，便于维护和调试
- **Fast feedback**: P0 单元测试优先执行，快速发现问题

## Test Environment Requirements

### Unit Tests
- Mock Tushare API responses
- In-memory database for data validation tests
- Isolated test environment (no external dependencies)

### Integration Tests  
- Test database instance (SQLite)
- Mock external APIs with realistic delay/error simulation
- Isolated scheduler for timing tests

### E2E Tests
- Full staging environment
- Real API endpoints (with test accounts)
- Performance monitoring tools for timing verification

## Success Criteria

- **Coverage Target**: Unit >90%, Integration >80%, E2E coverage for all critical paths
- **Performance Target**: 4000股票数据拉取 <10分钟
- **Quality Target**: 所有P0测试通过，P1测试通过率 >95%
- **Security Target**: 凭据安全和API访问控制测试100%通过