# 4. 技术约束和集成要求 🔧

## 现有技术栈

**语言**: TypeScript (100% 类型安全)
**前端框架**: React 18 + TanStack Router (文件路由)
**UI 组件**: shadcn/ui + TailwindCSS (响应式设计)
**后端框架**: Hono (轻量级，高性能)
**API 层**: tRPC (端到端类型安全)
**数据库**: SQLite + Drizzle ORM (TypeScript-first)
**运行时**: Bun (高性能 JavaScript 运行时)
**构建工具**: Turborepo (monorepo 管理)
**认证**: Better Auth (邮箱密码认证)

## 集成方法

**数据库集成策略**:

- 保持 SQLite 架构，实现连接池和查询优化以支持百人级并发
- 扩展现有 Drizzle schema，添加股票数据表（stocks、daily_data、indicators、strategies、backtests）
- 保持现有用户认证表结构不变，通过外键关联用户和投资组合数据
- 建立索引策略，优化股票数据和用户查询性能
- 实现数据压缩和清理策略，管理历史数据存储
- 集成 SQLite FTS5 全文搜索，支持股票代码和名称快速搜索
- 为未来扩展预留数据库迁移接口

**API 集成策略**:

- 扩展现有 tRPC router，添加股票数据、回测等新路由（AI 分析路由推迟到 Phase 2）
- 保持端到端类型安全，为所有金融数据定义 TypeScript 接口
- 实现 tushare pro API 和备用数据源的 TypeScript 包装器，统一数据格式
- 实现主备数据源自动切换和健康检查机制
- 添加定时任务支持，每日下午 5 点自动拉取数据
- 建立错误处理和重试机制，提高数据获取可靠性

**前端集成策略**:

- 扩展现有 TanStack Router 路由，添加股票分析相关页面
- 复用现有 shadcn/ui 组件，新增金融专用组件（K 线图、指标图表）
- 集成轻量级图表库（如 Lightweight Charts），保持包体积合理
- 实现响应式设计，确保移动端和桌面端一致体验

**测试集成策略**:

- 扩展现有测试框架，添加金融计算逻辑单元测试
- 实现回测算法的基准测试，确保计算准确性
- 添加 tushare API 的模拟测试，避免在测试中调用真实 API
- 集成端到端测试，验证完整的用户操作流程

## 代码组织和标准

**文件结构方法**:

```
apps/
├── server/
│   ├── src/
│   │   ├── lib/
│   │   │   ├── auth.ts (现有)
│   │   │   ├── stock-data.ts (新增)
│   │   │   ├── backtest-engine.ts (新增)
│   │   │   └── ai-analysis.ts (新增)
│   │   ├── routers/
│   │   │   ├── index.ts (现有)
│   │   │   ├── stocks.ts (新增)
│   │   │   ├── backtest.ts (新增)
│   │   │   └── ai.ts (新增)
│   │   └── db/schema/
│   │       ├── auth.ts (现有)
│   │       ├── stocks.ts (新增)
│   │       └── finance.ts (新增)
├── web/
│   ├── src/
│   │   ├── components/
│   │   │   ├── ui/ (现有)
│   │   │   ├── stock-chart.tsx (新增)
│   │   │   ├── strategy-builder.tsx (新增)
│   │   │   └── backtest-results.tsx (新增)
│   │   ├── routes/
│   │   │   ├── __root.tsx (现有)
│   │   │   ├── dashboard.tsx (扩展)
│   │   │   ├── stocks/ (新增目录)
│   │   │   └── backtest/ (新增目录)
```

**命名约定**:

- 股票相关文件以 `stock-` 前缀命名
- 回测相关文件以 `backtest-` 前缀命名
- AI 分析相关文件以 `ai-` 前缀命名
- 保持现有的 kebab-case 文件命名风格

**编码标准**:

- 严格遵循现有的 TypeScript 配置和 ESLint 规则
- 所有金融计算函数必须有完整的 JSDoc 注释
- 使用 Zod 验证所有外部数据（tushare API 响应）
- 实现统一的错误处理和日志记录机制

## 部署和运营

**构建过程集成**:

- 保持现有的 Turborepo 构建配置
- 添加金融数据模型的类型检查步骤
- 集成回测算法的性能基准测试到 CI 流程
- 实现数据库迁移脚本的自动化执行

**部署策略**:

- 保持现有的部署流程，添加数据库迁移步骤
- 实现定时任务的部署和监控（数据拉取任务）
- 配置环境变量管理（tushare API 密钥等）
- 设置数据备份和恢复策略

**监控和日志**:

- 扩展现有日志系统，添加金融数据处理日志
- 实现数据质量监控（缺失数据、异常值检测）
- 添加回测性能监控和用户行为分析
- 集成支付和订阅状态监控

## 风险评估和缓解

**技术风险**:

- **数据依赖风险**: tushare API 限制和稳定性 → 实现免费 API 备份和本地缓存机制
- **计算性能风险**: 回测计算在百人级负载下的性能 → 实现异步队列和结果缓存
- **数据准确性风险**: 金融数据错误可能导致投资损失 → 实施数据验证和质量检查

**集成风险**:

- **认证系统兼容**: 付费功能集成保持向后兼容
- **移动端性能**: 优化数据传输和懒加载策略
- **扩展性准备**: 为未来数据库迁移建立抽象层

**部署风险**:

- **数据迁移风险**: SQLite 迁移相对简单，风险可控
- **定时任务风险**: 数据拉取任务失败可能影响整体功能 → 重试机制和监控告警
- **扩展性风险**: 当前百人级需求下 SQLite 性能充足，为未来扩展保留迁移路径

---
