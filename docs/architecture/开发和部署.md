# 开发和部署

## 本地开发设置

### 前置要求
- Bun >= 1.2.18
- Node.js >= 18.0.0
- Git

### 快速开始

```bash
# 1. 克隆项目
git clone <repository-url>
cd neostock

# 2. 安装依赖
bun install

# 3. 设置环境变量
cp apps/server/.env.example apps/server/.env.local
# 编辑 .env.local 文件，设置必要的环境变量

# 4. 初始化数据库
cd apps/server
bun db:local &  # 启动本地SQLite
bun db:push     # 推送schema
bun db:generate # 生成迁移文件

# 5. 启动开发服务器
cd ../..
bun dev
```

### 开发工作流

```bash
# 开发时运行的常用命令
bun dev                    # 启动所有服务
bun test                   # 运行测试
bun test:coverage         # 运行测试并生成覆盖率报告
bun lint                  # 代码检查
bun check-types          # TypeScript 类型检查

# 数据库操作
bun db:studio            # 数据库可视化管理
bun db:migrate          # 执行迁移
bun db:push             # 推送 schema 变更

# 质量门控（在 apps/server 目录下执行）
bun run docs:validate    # 验证文档一致性
bun run docs:check-changes # 检查API变更
bun run quality:gate     # 运行质量门控检查
bun run security:gate    # 运行安全门控检查
bun run pre-deploy       # 部署前验证
```

## 质量保证流程

### 代码提交前检查
```bash
# 完整的提交前检查流程
bun lint                 # 代码风格检查
bun check-types         # TypeScript类型检查
bun test                # 单元测试
bun test:coverage       # 测试覆盖率检查
cd apps/server && bun run security:gate  # 安全检查
```

### 部署前验证
```bash
cd apps/server
bun run pre-deploy      # 自动化部署前检查
bun run quality:gate    # 质量门控
bun run docs:validate   # 文档验证
```

## 构建和部署

### 本地构建
```bash
bun build              # 构建所有应用
```

### 环境变量要求

#### 开发环境 (.env.local)
```env
# 数据库配置
DATABASE_URL="file:./local.db"

# 认证配置  
BETTER_AUTH_SECRET="your-dev-secret-key"
BETTER_AUTH_URL="http://localhost:3000"

# 外部API（可选，用于测试）
TUSHARE_API_TOKEN="your-tushare-token"
```

#### 生产环境
```env
# 数据库配置
DATABASE_URL="your-production-database-url"

# 认证配置
BETTER_AUTH_SECRET="your-production-secret-key"
BETTER_AUTH_URL="https://your-domain.com"

# 外部API
TUSHARE_API_TOKEN="your-production-tushare-token"

# 监控配置
MONITORING_ENABLED="true"
ALERT_CHANNELS="email,slack"

# 安全配置
SECURITY_SCAN_ENABLED="true"
API_RATE_LIMIT="1000"
```