# Test Design: Story 1.4

Date: 2025-09-02
Designer: Quinn (Test Architect)
Story: K 线图表和技术指标可视化

## Test Strategy Overview

- **Total test scenarios**: 32
- **Unit tests**: 12 (38%)
- **Integration tests**: 14 (44%)
- **E2E tests**: 6 (18%)
- **Priority distribution**: P0: 8, P1: 16, P2: 8

## Test Scenarios by Acceptance Criteria

### AC1: 集成轻量级图表库实现 K 线图展示

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.4-UNIT-001 | Unit | P0 | 验证 K 线数据格式转换器 | 纯数据转换逻辑，需要快速反馈 |
| 1.4-UNIT-002 | Unit | P0 | 验证图表配置参数验证 | 输入验证逻辑，防止运行时错误 |
| 1.4-INT-001 | Integration | P0 | 图表库集成基础功能测试 | 关键组件集成验证 |
| 1.4-INT-002 | Integration | P1 | 图表与主题系统集成测试 | 跨组件集成测试 |
| 1.4-INT-003 | Integration | P1 | 图表数据加载性能测试 | 性能关键路径测试 |
| 1.4-E2E-001 | E2E | P1 | 用户查看 K 线图完整流程 | 核心用户旅程验证 |

### AC2: 支持多种技术指标叠加显示（MA、MACD、RSI 等）

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.4-UNIT-003 | Unit | P0 | MA 移动平均线计算算法验证 | 金融计算精度关键 |
| 1.4-UNIT-004 | Unit | P0 | MACD 指标计算算法验证 | 金融计算精度关键 |
| 1.4-UNIT-005 | Unit | P0 | RSI 相对强弱指标计算验证 | 金融计算精度关键 |
| 1.4-UNIT-006 | Unit | P1 | 技术指标数据缓存逻辑 | 缓存策略逻辑测试 |
| 1.4-INT-004 | Integration | P0 | 技术指标与图表叠加集成 | 核心功能集成测试 |
| 1.4-INT-005 | Integration | P1 | 多指标同时显示性能测试 | 性能集成测试 |
| 1.4-INT-006 | Integration | P1 | 指标显示/隐藏切换功能 | 用户交互集成测试 |
| 1.4-E2E-002 | E2E | P0 | 用户配置并查看技术指标 | 核心投资决策流程 |

### AC3: 实现图表的缩放、平移等交互功能

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.4-UNIT-007 | Unit | P1 | 图表交互事件处理逻辑 | 事件处理逻辑测试 |
| 1.4-INT-007 | Integration | P1 | 鼠标滚轮缩放功能测试 | 桌面端关键交互测试 |
| 1.4-INT-008 | Integration | P1 | 图表拖拽平移功能测试 | 桌面端关键交互测试 |
| 1.4-INT-009 | Integration | P1 | 十字光标显示功能测试 | 用户辅助功能测试 |
| 1.4-INT-010 | Integration | P1 | 双击重置视图功能测试 | 用户体验功能测试 |
| 1.4-E2E-003 | E2E | P1 | 用户完整交互体验流程 | 完整用户交互旅程 |

### AC4: 优化移动端图表显示和触屏操作体验

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.4-UNIT-008 | Unit | P1 | 触摸手势识别算法 | 手势处理逻辑测试 |
| 1.4-INT-011 | Integration | P0 | 移动端触摸缩放功能测试 | 移动端核心功能测试 |
| 1.4-INT-012 | Integration | P0 | 移动端触摸平移功能测试 | 移动端核心功能测试 |
| 1.4-INT-013 | Integration | P1 | 移动端屏幕适配测试 | 响应式设计测试 |
| 1.4-INT-014 | Integration | P1 | 移动端性能优化测试 | 移动端性能关键测试 |
| 1.4-E2E-004 | E2E | P0 | 移动端用户完整操作流程 | 移动端核心用户旅程 |

### AC5: 保持与现有 UI 主题和颜色系统的一致性

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.4-UNIT-009 | Unit | P1 | 主题颜色转换逻辑 | 颜色处理逻辑测试 |
| 1.4-UNIT-010 | Unit | P1 | 图表主题配置验证 | 配置验证逻辑测试 |
| 1.4-INT-015 | Integration | P1 | 深色主题集成测试 | 主题系统集成测试 |
| 1.4-INT-016 | Integration | P1 | 浅色主题集成测试 | 主题系统集成测试 |
| 1.4-INT-017 | Integration | P2 | 主题切换动态更新测试 | 动态主题切换测试 |
| 1.4-E2E-005 | E2E | P2 | 用户主题切换体验测试 | 用户体验测试 |

## 风险覆盖分析

### 关键风险缓解测试

| 风险ID | 风险描述 | 缓解测试场景 |
|--------|----------|-------------|
| PERF-001 | 图表库选型失败风险 | 1.4-INT-001, 1.4-INT-003, 1.4-E2E-001 |
| TECH-001 | 技术指标计算准确性风险 | 1.4-UNIT-003, 1.4-UNIT-004, 1.4-UNIT-005 |
| PERF-002 | 大数据量渲染性能风险 | 1.4-INT-003, 1.4-INT-005, 1.4-INT-014 |
| TECH-002 | 移动端触摸手势冲突风险 | 1.4-UNIT-008, 1.4-INT-011, 1.4-INT-012 |
| DATA-001 | 实时数据更新同步风险 | 1.4-INT-004, 1.4-E2E-002, 1.4-E2E-004 |

## 测试数据设计

### 单元测试数据

```typescript
// K线数据测试用例
const kLineData = [
  { open: 10.5, high: 11.2, low: 10.3, close: 11.0, volume: 1000000 },
  { open: 11.0, high: 11.5, low: 10.8, close: 11.2, volume: 1200000 },
  // 更多测试数据...
];

// 技术指标计算测试用例
const maTestData = [10.1, 10.5, 10.3, 10.8, 11.0, 11.2, 11.1, 11.3];
const expectedMA5 = 10.88; // 预期的5日移动平均值
```

### 集成测试数据

```typescript
// 大数据量性能测试
const largeDataSet = Array.from({ length: 1000 }, (_, i) => ({
  open: 10 + Math.random() * 2,
  high: 10 + Math.random() * 2.5,
  low: 10 + Math.random() * 1.5,
  close: 10 + Math.random() * 2,
  volume: Math.floor(Math.random() * 1000000) + 500000
}));

// 移动端触摸测试数据
const touchEvents = [
  { type: 'touchstart', x: 100, y: 200 },
  { type: 'touchmove', x: 150, y: 200 },
  { type: 'touchend', x: 150, y: 200 }
];
```

### E2E测试场景

```typescript
// 用户旅程测试
const userJourneys = [
  {
    name: '查看股票K线图',
    steps: [
      '搜索股票',
      '进入详情页',
      '查看K线图',
      '验证数据显示'
    ]
  },
  {
    name: '配置技术指标',
    steps: [
      '打开股票详情',
      '添加MA指标',
      '添加MACD指标',
      '验证指标显示'
    ]
  }
];
```

## 性能测试要求

### 渲染性能测试

| 测试场景 | 数据量 | 预期时间 | 测试级别 |
|----------|--------|----------|----------|
| 基础K线图 | 100数据点 | <50ms | Integration |
| 中等数据量 | 500数据点 | <80ms | Integration |
| 大数据量 | 1000数据点 | <100ms | Integration |
| 多指标叠加 | 1000数据点+3指标 | <150ms | Integration |

### 移动端性能测试

| 测试场景 | 设备类型 | 预期响应时间 | 测试级别 |
|----------|----------|---------------|----------|
| 触摸缩放 | 高端手机 | <30ms | Integration |
| 触摸平移 | 中端手机 | <50ms | Integration |
| 图表渲染 | 低端手机 | <100ms | E2E |

## 测试环境配置

### 单元测试环境

```typescript
// vitest.config.ts
export default {
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: ['./src/test/setup.ts']
  }
}
```

### 集成测试环境

```typescript
// 使用测试数据库和模拟API
const testConfig = {
  database: ':memory:',
  apiBaseUrl: 'http://localhost:3000',
  mockData: true
};
```

### E2E测试环境

```typescript
// playwright.config.ts
export default {
  projects: [
    {
      name: 'desktop-chrome',
      use: { viewport: { width: 1280, height: 720 } }
    },
    {
      name: 'mobile-safari',
      use: { 
        viewport: { width: 375, height: 667 },
        isMobile: true,
        hasTouch: true
      }
    }
  ]
};
```

## 推荐执行顺序

### 第一阶段：P0测试（快速失败）
1. **单元测试** (1.4-UNIT-001 到 1.4-UNIT-006)
2. **集成测试** (1.4-INT-001, 1.4-INT-004, 1.4-INT-011, 1.4-INT-012)
3. **E2E测试** (1.4-E2E-002, 1.4-E2E-004)

### 第二阶段：P1测试（核心功能）
1. **单元测试** (1.4-UNIT-007, 1.4-UNIT-008, 1.4-UNIT-009, 1.4-UNIT-010)
2. **集成测试** (剩余P1集成测试)
3. **E2E测试** (1.4-E2E-001, 1.4-E2E-003, 1.4-E2E-005)

### 第三阶段：P2测试（完整覆盖）
1. **集成测试** (剩余P2集成测试)
2. **性能测试** (所有性能相关测试)

## 测试覆盖率目标

| 测试类型 | 覆盖率目标 | 重点覆盖内容 |
|----------|------------|--------------|
| 单元测试 | >85% | 技术指标计算、数据处理逻辑 |
| 集成测试 | >75% | 图表库集成、移动端交互 |
| E2E测试 | >60% | 核心用户旅程、关键流程 |

## 测试自动化策略

### CI/CD集成

```yaml
# .github/workflows/test.yml
name: Test Suite
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run unit tests
        run: npm test:unit
      - name: Run integration tests
        run: npm test:integration
      - name: Run E2E tests
        run: npm test:e2e
```

### 测试报告

```typescript
// 测试结果报告
const testReport = {
  totalTests: 32,
  passed: 30,
  failed: 2,
  coverage: {
    unit: 87,
    integration: 78,
    e2e: 65
  },
  performance: {
    averageRenderTime: 65,
    mobileResponseTime: 42
  }
};
```

## 质量检查清单

- [x] 每个验收标准都有对应的测试场景
- [x] 测试级别分配合理（避免重复测试）
- [x] 优先级基于业务风险和用户影响
- [x] 关键风险都有相应的缓解测试
- [x] 测试数据设计全面覆盖各种情况
- [x] 性能测试要求明确且可衡量
- [x] 移动端测试场景充分考虑
- [x] 测试环境配置清晰完整

## 风险缓解验证

### 技术风险缓解
- ✅ 图表库选型风险通过集成测试验证
- ✅ 技术指标计算准确性通过单元测试确保
- ✅ 移动端手势冲突通过专门测试识别

### 性能风险缓解
- ✅ 大数据量渲染通过性能测试监控
- ✅ 移动端性能通过设备特定测试验证
- ✅ Bundle大小影响通过构建分析控制

### 业务风险缓解
- ✅ 核心用户旅程通过E2E测试验证
- ✅ 用户体验通过交互测试保证
- ✅ 数据准确性通过算法测试确保

## 后续改进建议

1. **测试数据管理**: 建立统一的测试数据管理机制
2. **性能基准**: 建立性能基准测试和回归检测
3. **移动端设备矩阵**: 扩展移动端测试设备覆盖
4. **可视化测试**: 集成可视化回归测试工具
5. **测试并行化**: 优化测试执行速度

---

**Test Design Complete**: 32 test scenarios designed with comprehensive coverage across all acceptance criteria and risk mitigation.

**Gate YAML Block:**
```yaml
test_design:
  scenarios_total: 32
  by_level:
    unit: 12
    integration: 14
    e2e: 6
  by_priority:
    p0: 8
    p1: 16
    p2: 8
  coverage_gaps: []
```