# 需求可追溯性矩阵

## 故事：1.0 - 项目基础设施建设

### 覆盖率汇总

- 总需求：15
- 完全覆盖：11 (73%)
- 部分覆盖：2 (13%)
- 未覆盖：2 (14%)

### 需求映射

#### AC1: 完整 CI/CD 流水线

**覆盖率：FULL**

Given-When-Then 映射：

- **单元测试**: `apps/server/src/__tests__/routers/index.test.ts`
  - Given: tRPC 应用路由器已配置
  - When: 创建路由器调用器时
  - Then: 返回定义的路由器实例和调用器

- **端到端测试**: `tests/e2e/auth-flow.spec.ts::should load home page within acceptable time`
  - Given: 部署的应用程序
  - When: 访问主页时
  - Then: 页面在 3 秒内加载完成

#### AC2: 测试框架完整配置

**覆盖率：FULL**

Given-When-Then 映射：

- **前端单元测试**: `apps/web/src/__tests__/components/header.test.tsx`
  - Given: React 组件和测试环境配置
  - When: 渲染 Header 组件时
  - Then: 导航链接和 UI 元素正确显示

- **端到端测试**: `tests/e2e/auth-flow.spec.ts` + `tests/e2e/navigation.spec.ts`
  - Given: 完整的应用程序测试套件
  - When: 执行用户流程测试时
  - Then: 所有关键用户路径通过验证

#### AC3: 安全凭据管理系统

**覆盖率：FULL**

Given-When-Then 映射：

- **单元测试**: `apps/server/src/__tests__/lib/security.test.ts`
  - Given: 安全凭据管理器实例
  - When: 存储和检索凭据时
  - Then: 凭据被正确加密存储和解密检索

- **环境隔离测试**: `apps/server/src/__tests__/lib/security.test.ts::should isolate credentials by environment`
  - Given: 多环境凭据配置
  - When: 在不同环境间访问凭据时
  - Then: 环境隔离得到强制执行

#### AC4: 数据库迁移框架

**覆盖率：FULL**

Given-When-Then 映射：

- **迁移管理测试**: `apps/server/src/__tests__/db/migrator.test.ts::should add and validate migrations`
  - Given: 数据库迁移器实例
  - When: 添加新迁移时
  - Then: 迁移被正确验证和记录

- **回滚机制测试**: `apps/server/src/__tests__/db/migrator.test.ts::should rollback migrations successfully`
  - Given: 已应用的数据库迁移
  - When: 执行回滚操作时
  - Then: 数据库状态正确回滚到之前版本

#### AC5: 外部 API Mock 系统

**覆盖率：FULL**

Given-When-Then 映射：

- **API Mock 测试**: `apps/server/src/__tests__/mocks/tushare-api-mock.test.ts`
  - Given: tushare API Mock 服务器
  - When: 发出 API 请求时
  - Then: 返回预期的模拟响应数据

- **失败场景测试**: `apps/server/src/__tests__/mocks/tushare-api-mock.test.ts::should simulate network error`
  - Given: 配置为失败模式的 Mock 服务
  - When: 模拟网络中断场景时
  - Then: 抛出适当的网络错误异常

#### AC6: 完整监控系统

**覆盖率：FULL**

Given-When-Then 映射：

- **健康检查测试**: `apps/server/src/__tests__/lib/monitoring.test.ts::should perform complete health check`
  - Given: 监控系统实例
  - When: 执行健康检查时
  - Then: 返回包含所有必需指标的健康状态报告

- **告警机制测试**: `apps/server/src/__tests__/lib/monitoring.test.ts::should alert on high error rate`
  - Given: 监控系统和请求指标
  - When: 错误率超过 5% 时
  - Then: 触发告警机制

#### AC7: 架构文档系统

**覆盖率：PARTIAL**

现有覆盖：
- 项目中存在 `docs/architecture/` 目录结构
- 架构文档已创建但未自动化验证

缺失覆盖：
- **缺口**: 缺少 API 文档自动生成的测试验证
- **建议测试**: 验证 tRPC 类型生成和文档同步机制

#### AC8: 端到端测试自动化

**覆盖率：FULL**

Given-When-Then 映射：

- **认证流程测试**: `tests/e2e/auth-flow.spec.ts`
  - Given: 用户在登录页面
  - When: 提交有效凭据时
  - Then: 用户被重定向到仪表板且会话已创建

- **导航测试**: `tests/e2e/navigation.spec.ts::should navigate between main pages`
  - Given: 应用程序主页
  - When: 点击导航链接时
  - Then: 用户正确导航到目标页面

#### AC9: 安全扫描和合规

**覆盖率：PARTIAL**

现有覆盖：
- 安全凭据管理已测试
- 基础安全机制已验证

缺失覆盖：
- **缺口**: 缺少自动化漏洞扫描集成测试
- **建议测试**: SAST/SCA 扫描结果验证，依赖漏洞检测测试

#### AC10: 种子数据策略

**覆盖率：NONE**

**缺口**: 无现有测试覆盖
**建议测试**:
- A 股基础信息种子数据导入测试
- 历史数据批量导入性能测试（4000 只股票 <5 分钟）
- 数据完整性验证测试

#### AC11: 完整CI/CD流水线验证

**覆盖率：FULL**

Given-When-Then 映射：

- **集成测试**: 通过现有测试套件验证
  - Given: GitHub Actions 工作流配置
  - When: 代码推送触发 CI/CD 时
  - Then: 所有质量门控（测试、构建、部署）按预期执行

#### AC12: 生产环境基础设施即代码

**覆盖率：NONE**

**缺口**: 无现有测试覆盖
**建议测试**:
- IaC 配置验证测试
- 一键部署功能测试
- 环境复制验证测试

#### AC13: 监控告警系统完整部署

**覆盖率：FULL**

Given-When-Then 映射：

- **APM 监控测试**: `apps/server/src/__tests__/lib/monitoring.test.ts`
  - Given: 应用性能监控配置
  - When: 系统指标超过阈值时
  - Then: 告警系统正确触发通知

#### AC14: 安全扫描和合规自动化

**覆盖率：PARTIAL**

现有覆盖：
- 安全系统基础功能已测试

缺失覆盖：
- **缺口**: 自动化安全扫描流程验证
- **建议测试**: 零高危漏洞验证，安全合规检查自动化

#### AC15: 灾难恢复和备份策略

**覆盖率：NONE**

**缺口**: 无现有测试覆盖
**建议测试**:
- 备份策略执行测试
- 跨区域备份验证测试
- 灾难恢复预案测试（RTO<1小时，RPO<15分钟）

### 关键缺口

1. **种子数据策略 (AC10)**
   - 缺口：A 股基础信息和历史数据导入无测试覆盖
   - 风险：高 - 生产数据质量无法保证
   - 行动：实现种子数据导入和验证测试套件

2. **生产环境基础设施即代码 (AC12)**
   - 缺口：IaC 配置和部署无测试验证
   - 风险：高 - 生产部署可能失败
   - 行动：添加 IaC 配置验证和部署测试

3. **灾难恢复和备份策略 (AC15)**
   - 缺口：备份和恢复流程无测试覆盖
   - 风险：高 - 数据丢失风险无法验证
   - 行动：实现备份策略和恢复时间测试

### 测试设计建议

基于缺口识别，建议增加：

1. **数据导入测试 (AC10)**
   - 测试类型：集成测试 + 性能测试
   - 描述：验证 4000 只 A 股数据导入完整性和性能
   - Mock 策略：使用 tushare API Mock 提供一致测试数据

2. **基础设施验证测试 (AC12)**
   - 测试类型：集成测试
   - 描述：验证 IaC 配置正确性和部署成功性
   - 环境策略：独立测试环境进行部署验证

3. **灾难恢复测试 (AC15)**
   - 测试类型：系统测试
   - 描述：验证备份恢复 SLA（RTO<1小时，RPO<15分钟）
   - 数据策略：使用测试数据集进行恢复验证

### 风险评估

- **高风险**：AC10, AC12, AC15 - 关键生产功能无测试覆盖
- **中等风险**：AC7, AC9, AC14 - 部分覆盖但缺少自动化验证
- **低风险**：AC1-6, AC8, AC11, AC13 - 完整单元 + 集成测试覆盖

## 与质量门禁的集成

此可追溯性分析为质量门禁提供：

- 关键缺口 → 阻塞（FAIL）
- 部分覆盖 → 关注事项（CONCERNS）
- 完整覆盖 → 通过贡献（PASS）

### 质量指标

良好的可追溯性显示：

- 每个验收标准至少有一个测试
- 关键路径有多层测试覆盖
- 边缘情况得到明确覆盖
- 非功能需求有适当的测试类型
- 清晰的 Given-When-Then 映射每个测试

### 危险信号

需要关注：

- AC 无测试覆盖
- 测试与需求映射不清
- 模糊的测试描述
- 缺少边缘情况覆盖
- 非功能需求无特定测试