# 增强 IDE 开发工作流

这是一个简单的分步指南，帮助您使用 BMad 方法高效管理开发工作流。该工作流在整个开发生命周期中集成了测试架构师（QA 代理）以确保质量、防止回归并维持高标准。有关此处未涵盖的任何场景，请参阅 **[<ins>用户指南</ins>](user-guide.md)**。

## 创建新分支

1. **启动新分支**

## 故事创建（Scrum Master）

1. **启动新聊天/对话**
2. **加载 SM 代理**
3. **执行**：`*draft`（运行 create-next-story 任务）
4. **审查生成的故事** 在 `docs/stories/` 中
5. **更新状态**：从"Draft"更改为"Approved"

## 故事实现（开发人员）

1. **启动新聊天/对话**
2. **加载 Dev 代理**
3. **执行**：`*develop-story {selected-story}`（运行 execute-checklist 任务）
4. **审查生成的报告** 在 `{selected-story}` 中

## 整个工作流的测试架构师集成

测试架构师（Quinn）在整个开发生命周期中提供全面的质量保证。以下是如何在正确的时间利用每个功能。

**命令别名：** 文档使用简短形式（`*risk`、`*design`、`*nfr`、`*trace`）表示完整命令（`*risk-profile`、`*test-design`、`*nfr-assess`、`*trace-requirements`）。

### 快速命令参考

| **阶段**                | **命令** | **目的**                             | **输出**                                                      | **优先级**                |
| ------------------------ | ----------- | --------------------------------------- | --------------------------------------------------------------- | --------------------------- |
| **故事批准后** | `*risk`     | 识别集成和回归风险 | `docs/qa/assessments/{epic}.{story}-risk-{YYYYMMDD}.md`         | 复杂/棕地高优先级 |
|                          | `*design`   | 为开发创建测试策略            | `docs/qa/assessments/{epic}.{story}-test-design-{YYYYMMDD}.md`  | 新功能高优先级       |
| **开发期间**   | `*trace`    | 验证测试覆盖率                    | `docs/qa/assessments/{epic}.{story}-trace-{YYYYMMDD}.md`        | 中等优先级                      |
|                          | `*nfr`      | 验证质量属性             | `docs/qa/assessments/{epic}.{story}-nfr-{YYYYMMDD}.md`          | 关键功能高优先级  |
| **开发后**    | `*review`   | 全面评估                | 故事中的 QA 结果 + `docs/qa/gates/{epic}.{story}-{slug}.yml` | **必需**                |
| **审查后**          | `*gate`     | 更新质量决定                 | 更新的 `docs/qa/gates/{epic}.{story}-{slug}.yml`               | 根据需要                   |

### 阶段 1：故事创建后（开发开始前）

**推荐 - 为开发人员成功做准备：**

```bash
# 1. 风险评估（对复杂故事首先运行）
@qa *risk {approved-story}
# 识别：
#   - 技术债务影响
#   - 集成复杂性
#   - 回归潜力（1-9 评分）
#   - 缓解策略
# 关键用于：棕地、API 更改、数据迁移

# 2. 测试设计（第二步运行以指导实施）
@qa *design {approved-story}
# 提供：
#   - 每个验收标准的测试场景
#   - 测试级别建议（单元/集成/E2E）
#   - 基于风险的优先级（P0/P1/P2）
#   - 测试数据要求
# 与开发分享：包含在故事评论中或附加到工单
```

### 阶段 2：开发期间（中期实施检查点）

**开发人员自助质量检查：**

```bash
# 3. 需求跟踪（开发中期验证覆盖率）
@qa *trace {story-in-progress}
# 验证：
#   - 所有验收标准都有测试
#   - 没有遗漏的测试场景
#   - 适当的测试级别
#   - Given-When-Then 文档清晰
# 何时运行：编写初始测试后

# 4. NFR 验证（检查质量属性）
@qa *nfr {story-in-progress}
# 评估：
#   - 安全性：认证、授权、数据保护
#   - 性能：响应时间、资源使用
#   - 可靠性：错误处理、恢复
#   - 可维护性：代码质量、文档
# 何时运行：标记为"待审查"之前
```

### 阶段 3：故事审查（质量门禁评估）

**必需 - 全面测试架构审查：**

**先决条件：** 所有测试在本地通过；lint 和类型检查通过。

```bash
# 5. 完整审查（标准审查流程）
@qa *review {completed-story}
```

**审查期间发生的事情：**

1. **深度代码分析**
   - 架构模式合规性
   - 代码质量和可维护性
   - 安全漏洞扫描
   - 性能瓶颈检测

2. **主动重构**
   - 在安全时直接改进代码
   - 立即修复明显问题
   - 为开发人员建议复杂重构

3. **测试验证**
   - 所有级别的覆盖率（单元/集成/E2E）
   - 测试质量（无不稳定测试，适当的断言）
   - 回归测试充分性

4. **门禁决定**
   - 创建：`docs/qa/gates/{epic}.{story}-{slug}.yml`
   - 添加：故事文件中的 QA 结果部分
   - 状态：PASS/CONCERNS/FAIL/WAIVED

### 阶段 4：审查后（解决问题后）

**修复后更新门禁状态：**

```bash
# 6. 门禁更新（记录最终决定）
@qa *gate {reviewed-story}
# 更新：新状态的质量门禁
# 用途：解决审查反馈后
# 记录：修复了什么，豁免了什么
```

### 理解门禁决定

| **状态**   | **含义**                                  | **需要的行动**     | **可以继续吗？** |
| ------------ | -------------------------------------------- | ----------------------- | ---------------- |
| **PASS**     | 满足所有关键需求                | 无                    | ✅ 是           |
| **CONCERNS** | 发现非关键问题                    | 建议团队审查 | ⚠️ 谨慎进行  |
| **FAIL**     | 关键问题（安全性，缺少 P0 测试） | 必须修复                | ❌ 否            |
| **WAIVED**   | 问题已确认并接受             | 记录理由      | ✅ 获得批准 |

### 基于风险的测试策略

测试架构师使用风险评分来确定测试优先级：

| **风险评分** | **计算**                | **测试优先级**      | **门禁影响**          |
| -------------- | ------------------------------ | ------------------------- | ------------------------ |
| **9**          | 高概率 × 高影响 | P0 - 必须彻底测试 | 未测试则 FAIL         |
| **6**          | 中高组合       | P1 - 应该好好测试     | 有差距则 CONCERNS         |
| **4**          | 中等组合            | P1 - 应该测试          | 有明显差距则 CONCERNS |
| **2-3**        | 中低组合        | P2 - 最好有         | 在审查中记录           |
| **1**          | 最小风险                   | P2 - 最少              | 在审查中记录           |

### 特殊情况和最佳实践

#### 高风险或棕地故事

```bash
# 始终运行此序列：
@qa *risk {story}    # 首先 - 识别危险
@qa *design {story}  # 其次 - 计划防御
# 然后在开发期间：
@qa *trace {story}   # 验证回归覆盖率
@qa *nfr {story}     # 检查性能影响
# 最后：
@qa *review {story}  # 深度集成分析
```

#### 复杂集成

- 在开发期间多次运行 `*trace`
- 关注集成测试覆盖率
- 使用 `*nfr` 验证跨系统性能
- 审查时特别注意 API 契约

#### 性能关键功能

- 早期且经常运行 `*nfr`（不仅在审查时）
- 在更改前建立性能基线
- 记录可接受的性能降级
- 在 `*design` 中考虑负载测试需求

### 强制执行的测试质量标准

Quinn 确保所有测试符合这些标准：

- **无不稳定测试**：适当的异步处理，明确等待
- **无硬等待**：仅动态策略（轮询、事件）
- **无状态**：测试独立并行运行
- **自清理**：测试管理自己的测试数据
- **适当级别**：单元测试逻辑，集成测试交互，E2E 测试旅程
- **清晰断言**：将断言保留在测试中，不要埋在助手中

### 文档和审计跟踪

所有测试架构师活动创建永久记录：

- **评估报告**：`docs/qa/assessments/` 中的时间戳分析
- **门禁文件**：`docs/qa/gates/` 中的决定记录
- **故事更新**：故事文件中的 QA 结果部分
- **可追溯性**：维护需求到测试的映射

## 提交更改并推送

1. **提交更改**
2. **推送到远程**

## 完整开发周期流程

### 包含测试架构师的完整工作流

1. **SM**：创建下一个故事 → 审查 → 批准
2. **QA（可选）**：风险评估（`*risk`）→ 测试设计（`*design`）
3. **Dev**：实现故事 → 编写测试 → 完成
4. **QA（可选）**：开发中检查（`*trace`、`*nfr`）
5. **Dev**：标记为待审查
6. **QA（必需）**：审查故事（`*review`）→ 门禁决定
7. **Dev（如需要）**：解决问题
8. **QA（如需要）**：更新门禁（`*gate`）
9. **提交**：所有更改
10. **推送**：到远程
11. **继续**：直到所有功能实现

### 快速决策指南

**我应该运行测试架构师命令吗？**

| **场景**             | **开发前**                  | **开发期间**               | **开发后**                |
| ------------------------ | ------------------------------- | ---------------------------- | ---------------------------- |
| **简单错误修复**       | 可选                        | 可选                     | 必需 `*review`           |
| **新功能**          | 推荐 `*risk`、`*design`  | 可选 `*trace`            | 必需 `*review`           |
| **棕地更改**    | **必需** `*risk`、`*design` | 推荐 `*trace`、`*nfr` | 必需 `*review`           |
| **API 修改**     | **必需** `*risk`、`*design` | **必需** `*trace`        | 必需 `*review`           |
| **性能关键** | 推荐 `*design`           | **必需** `*nfr`          | 必需 `*review`           |
| **数据迁移**       | **必需** `*risk`、`*design` | **必需** `*trace`        | 必需 `*review` + `*gate` |

### 成功指标

测试架构师帮助实现：

- 生产中**零回归缺陷**
- 测试**100% 需求覆盖率**
- 进行/不进行决定的**明确质量门禁**
- 技术债务的**记录风险接受**
- 团队间**一致的测试质量**
- 通过早期风险识别**左移测试**