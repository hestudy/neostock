# 路由保护和导航规范

## 1. 路由架构和保护策略

### 1.1 路由保护级别
```typescript
// apps/web/src/lib/route-protection.ts
export enum RouteProtectionLevel {
  PUBLIC = 'public',           // 公开路由：登录、注册、公共页面
  AUTHENTICATED = 'authenticated', // 需要登录：仪表板、个人设置
  SUBSCRIPTION = 'subscription',   // 需要订阅：高级功能
  ADMIN = 'admin'             // 管理员：系统管理
}

export interface RouteConfig {
  path: string
  protectionLevel: RouteProtectionLevel
  requiredPermissions?: string[]
  subscriptionTier?: SubscriptionTier
  component: string
  title: string
  description: string
  seoMetadata?: SEOMetadata
}

export enum SubscriptionTier {
  FREE = 'free',
  BASIC = 'basic', 
  PREMIUM = 'premium',
  ENTERPRISE = 'enterprise'
}

// 完整路由映射表
export const ROUTE_DEFINITIONS: RouteConfig[] = [
  // 公开路由
  {
    path: '/',
    protectionLevel: RouteProtectionLevel.PUBLIC,
    component: 'IndexPage',
    title: 'neostock - 中国股票分析平台',
    description: '专业的A股分析和策略回测平台'
  },
  {
    path: '/login',
    protectionLevel: RouteProtectionLevel.PUBLIC,
    component: 'LoginPage',
    title: '登录 - neostock',
    description: '登录您的neostock账户'
  },
  {
    path: '/register', 
    protectionLevel: RouteProtectionLevel.PUBLIC,
    component: 'RegisterPage',
    title: '注册 - neostock',
    description: '创建您的neostock账户'
  },

  // 认证用户路由
  {
    path: '/dashboard',
    protectionLevel: RouteProtectionLevel.AUTHENTICATED,
    component: 'DashboardPage',
    title: '仪表板 - neostock',
    description: '您的投资概览和最新市场动态'
  },
  {
    path: '/stocks',
    protectionLevel: RouteProtectionLevel.AUTHENTICATED,
    component: 'StockListPage', 
    title: '股票列表 - neostock',
    description: 'A股市场股票搜索和基本信息'
  },
  {
    path: '/stocks/$symbol',
    protectionLevel: RouteProtectionLevel.AUTHENTICATED,
    component: 'StockDetailPage',
    title: '$symbol 股票详情 - neostock',
    description: '查看 $symbol 的详细信息、图表和技术分析'
  },
  {
    path: '/portfolio',
    protectionLevel: RouteProtectionLevel.AUTHENTICATED,
    component: 'PortfolioPage',
    title: '我的投资组合 - neostock',
    description: '管理和跟踪您的投资组合表现'
  },

  // 订阅用户路由
  {
    path: '/strategies',
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionTier: SubscriptionTier.BASIC,
    component: 'StrategyListPage',
    title: '交易策略 - neostock',
    description: '创建和管理您的交易策略'
  },
  {
    path: '/strategies/create',
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionTier: SubscriptionTier.BASIC,
    component: 'StrategyBuilderPage',
    title: '策略构建器 - neostock',
    description: '使用可视化工具构建您的交易策略'
  },
  {
    path: '/backtest',
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionTier: SubscriptionTier.BASIC,
    component: 'BacktestPage',
    title: '策略回测 - neostock',
    description: '测试您的策略在历史数据上的表现'
  },
  {
    path: '/backtest/$id',
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionTier: SubscriptionTier.BASIC,
    component: 'BacktestResultPage',
    title: '回测结果 - neostock',
    description: '查看详细的回测结果和性能分析'
  },
  {
    path: '/ai-analysis',
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionTier: SubscriptionTier.PREMIUM,
    component: 'AIAnalysisPage',
    title: 'AI分析 - neostock',
    description: 'AI驱动的股票分析和投资建议'
  },

  // 用户设置和账户管理
  {
    path: '/settings',
    protectionLevel: RouteProtectionLevel.AUTHENTICATED,
    component: 'SettingsPage',
    title: '设置 - neostock',
    description: '管理您的账户设置和偏好'
  },
  {
    path: '/subscription',
    protectionLevel: RouteProtectionLevel.AUTHENTICATED,
    component: 'SubscriptionPage',
    title: '订阅管理 - neostock',
    description: '管理您的订阅计划和付费功能'
  },

  // 管理员路由
  {
    path: '/admin',
    protectionLevel: RouteProtectionLevel.ADMIN,
    requiredPermissions: ['admin.access'],
    component: 'AdminDashboardPage',
    title: '管理后台 - neostock',
    description: '系统管理和用户管理'
  }
]
```

### 1.2 路由保护实现
```typescript
// apps/web/src/components/route-protection.tsx
import { useAuth } from '@/hooks/use-auth'
import { useSubscription } from '@/hooks/use-subscription'
import { Navigate, useLocation } from '@tanstack/react-router'
import { RouteProtectionLevel, SubscriptionTier, type RouteConfig } from '@/lib/route-protection'

interface RouteProtectionProps {
  config: RouteConfig
  children: React.ReactNode
}

export const RouteProtection = ({ config, children }: RouteProtectionProps) => {
  const { user, isLoading: authLoading } = useAuth()
  const { subscription, isLoading: subLoading } = useSubscription()
  const location = useLocation()

  // 认证加载中
  if (authLoading || subLoading) {
    return <div className="flex justify-center items-center min-h-screen">
      <div className="animate-spin h-8 w-8 border-b-2 border-primary rounded-full"></div>
    </div>
  }

  // 公开路由直接放行
  if (config.protectionLevel === RouteProtectionLevel.PUBLIC) {
    return <>{children}</>
  }

  // 需要认证但未登录
  if (!user && config.protectionLevel !== RouteProtectionLevel.PUBLIC) {
    return <Navigate 
      to="/login" 
      search={{ redirect: location.pathname }}
      replace
    />
  }

  // 需要订阅但未订阅
  if (config.protectionLevel === RouteProtectionLevel.SUBSCRIPTION) {
    if (!subscription || !hasRequiredSubscription(subscription.tier, config.subscriptionTier)) {
      return <Navigate to="/subscription" replace />
    }
  }

  // 需要管理员权限但不是管理员
  if (config.protectionLevel === RouteProtectionLevel.ADMIN) {
    if (!user?.isAdmin || !hasRequiredPermissions(user.permissions, config.requiredPermissions)) {
      return <Navigate to="/dashboard" replace />
    }
  }

  return <>{children}</>
}

// 检查订阅级别
const hasRequiredSubscription = (
  userTier: SubscriptionTier | undefined, 
  requiredTier: SubscriptionTier | undefined
): boolean => {
  if (!requiredTier) return true
  if (!userTier) return false

  const tierHierarchy = {
    [SubscriptionTier.FREE]: 0,
    [SubscriptionTier.BASIC]: 1,
    [SubscriptionTier.PREMIUM]: 2,
    [SubscriptionTier.ENTERPRISE]: 3
  }

  return tierHierarchy[userTier] >= tierHierarchy[requiredTier]
}

// 检查权限
const hasRequiredPermissions = (
  userPermissions: string[] | undefined,
  requiredPermissions: string[] | undefined
): boolean => {
  if (!requiredPermissions || requiredPermissions.length === 0) return true
  if (!userPermissions || userPermissions.length === 0) return false

  return requiredPermissions.every(permission => 
    userPermissions.includes(permission)
  )
}
```

## 2. 导航系统和一致性

### 2.1 导航组件架构
```typescript
// apps/web/src/components/navigation/main-nav.tsx
import { Link, useRouter } from '@tanstack/react-router'
import { useAuth } from '@/hooks/use-auth'
import { useSubscription } from '@/hooks/use-subscription'
import { ROUTE_DEFINITIONS, RouteProtectionLevel } from '@/lib/route-protection'

interface NavItem {
  label: string
  path: string
  icon?: React.ComponentType<{ className?: string }>
  protectionLevel: RouteProtectionLevel
  subscriptionRequired?: boolean
  children?: NavItem[]
}

export const NAVIGATION_CONFIG: NavItem[] = [
  {
    label: '首页',
    path: '/',
    icon: HomeIcon,
    protectionLevel: RouteProtectionLevel.PUBLIC
  },
  {
    label: '仪表板',
    path: '/dashboard',
    icon: DashboardIcon,
    protectionLevel: RouteProtectionLevel.AUTHENTICATED
  },
  {
    label: '股票',
    path: '/stocks',
    icon: TrendingUpIcon,
    protectionLevel: RouteProtectionLevel.AUTHENTICATED
  },
  {
    label: '投资组合',
    path: '/portfolio',
    icon: PieChartIcon,
    protectionLevel: RouteProtectionLevel.AUTHENTICATED
  },
  {
    label: '策略',
    path: '/strategies',
    icon: TargetIcon,
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionRequired: true,
    children: [
      {
        label: '我的策略',
        path: '/strategies',
        protectionLevel: RouteProtectionLevel.SUBSCRIPTION
      },
      {
        label: '策略构建器',
        path: '/strategies/create',
        protectionLevel: RouteProtectionLevel.SUBSCRIPTION
      },
      {
        label: '回测分析',
        path: '/backtest',
        protectionLevel: RouteProtectionLevel.SUBSCRIPTION
      }
    ]
  },
  {
    label: 'AI分析',
    path: '/ai-analysis',
    icon: BrainIcon,
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionRequired: true
  }
]

export const MainNavigation = () => {
  const { user } = useAuth()
  const { subscription } = useSubscription()
  const router = useRouter()

  const isNavItemAccessible = (item: NavItem): boolean => {
    // 公开项目始终可访问
    if (item.protectionLevel === RouteProtectionLevel.PUBLIC) {
      return true
    }

    // 需要认证但未登录
    if (item.protectionLevel === RouteProtectionLevel.AUTHENTICATED && !user) {
      return false
    }

    // 需要订阅但未订阅
    if (item.subscriptionRequired && (!subscription || subscription.tier === 'free')) {
      return false
    }

    // 需要管理员权限
    if (item.protectionLevel === RouteProtectionLevel.ADMIN && !user?.isAdmin) {
      return false
    }

    return true
  }

  const renderNavItem = (item: NavItem, level: number = 0) => {
    if (!isNavItemAccessible(item)) {
      return null
    }

    const isActive = router.state.location.pathname === item.path
    const hasChildren = item.children && item.children.length > 0

    return (
      <div key={item.path} className={`nav-item-level-${level}`}>
        <Link
          to={item.path}
          className={`
            flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors
            ${isActive 
              ? 'bg-primary text-primary-foreground' 
              : 'text-muted-foreground hover:text-foreground hover:bg-muted'
            }
            ${level > 0 ? 'ml-4' : ''}
          `}
        >
          {item.icon && <item.icon className="mr-3 h-4 w-4" />}
          {item.label}
          {item.subscriptionRequired && !subscription && (
            <span className="ml-2 px-1.5 py-0.5 text-xs bg-amber-100 text-amber-800 rounded">
              Premium
            </span>
          )}
        </Link>
        
        {hasChildren && (
          <div className="mt-1">
            {item.children!.map(child => renderNavItem(child, level + 1))}
          </div>
        )}
      </div>
    )
  }

  return (
    <nav className="space-y-1" role="navigation" aria-label="主导航">
      {NAVIGATION_CONFIG.map(item => renderNavItem(item))}
    </nav>
  )
}
```

### 2.2 面包屑导航
```typescript
// apps/web/src/components/navigation/breadcrumb.tsx
import { Link, useMatches } from '@tanstack/react-router'
import { ChevronRightIcon, HomeIcon } from 'lucide-react'
import { ROUTE_DEFINITIONS } from '@/lib/route-protection'

interface BreadcrumbItem {
  label: string
  path: string
  isCurrentPage: boolean
}

export const Breadcrumb = () => {
  const matches = useMatches()
  const currentPath = matches[matches.length - 1]?.pathname || '/'

  const generateBreadcrumbs = (): BreadcrumbItem[] => {
    const breadcrumbs: BreadcrumbItem[] = []
    const pathSegments = currentPath.split('/').filter(Boolean)

    // 始终包含首页
    breadcrumbs.push({
      label: '首页',
      path: '/',
      isCurrentPage: currentPath === '/'
    })

    // 为每个路径段生成面包屑
    let currentFullPath = ''
    pathSegments.forEach((segment, index) => {
      currentFullPath += `/${segment}`
      
      // 查找路由配置
      const routeConfig = ROUTE_DEFINITIONS.find(route => 
        route.path === currentFullPath || 
        route.path.replace(/\$\w+/g, segment) === currentFullPath
      )

      if (routeConfig) {
        let label = routeConfig.title.split(' - ')[0] // 提取标题的第一部分
        
        // 处理动态路由参数
        if (routeConfig.path.includes('$')) {
          label = label.replace(/\$\w+/g, segment.toUpperCase())
        }

        breadcrumbs.push({
          label,
          path: currentFullPath,
          isCurrentPage: index === pathSegments.length - 1
        })
      }
    })

    return breadcrumbs
  }

  const breadcrumbs = generateBreadcrumbs()

  if (breadcrumbs.length <= 1) {
    return null // 在首页时不显示面包屑
  }

  return (
    <nav aria-label="面包屑导航" className="mb-4">
      <ol className="flex items-center space-x-2 text-sm text-muted-foreground">
        {breadcrumbs.map((crumb, index) => (
          <li key={crumb.path} className="flex items-center">
            {index > 0 && (
              <ChevronRightIcon className="h-4 w-4 mx-2 text-muted-foreground/50" />
            )}
            
            {crumb.isCurrentPage ? (
              <span className="font-medium text-foreground" aria-current="page">
                {index === 0 ? <HomeIcon className="h-4 w-4" /> : crumb.label}
              </span>
            ) : (
              <Link
                to={crumb.path}
                className="hover:text-foreground transition-colors"
              >
                {index === 0 ? <HomeIcon className="h-4 w-4" /> : crumb.label}
              </Link>
            )}
          </li>
        ))}
      </ol>
    </nav>
  )
}
```

### 2.3 用户菜单和权限显示
```typescript
// apps/web/src/components/navigation/user-menu.tsx
import { useState } from 'react'
import { Link } from '@tanstack/react-router'
import { useAuth } from '@/hooks/use-auth'
import { useSubscription } from '@/hooks/use-subscription'
import { 
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Button } from '@/components/ui/button'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'

export const UserMenu = () => {
  const { user, signOut } = useAuth()
  const { subscription } = useSubscription()

  if (!user) {
    return (
      <div className="flex items-center space-x-2">
        <Button variant="ghost" asChild>
          <Link to="/login">登录</Link>
        </Button>
        <Button asChild>
          <Link to="/register">注册</Link>
        </Button>
      </div>
    )
  }

  const getSubscriptionBadge = () => {
    if (!subscription) return null

    const badgeVariants = {
      free: { label: '免费版', variant: 'secondary' as const },
      basic: { label: '基础版', variant: 'default' as const },
      premium: { label: '高级版', variant: 'default' as const },
      enterprise: { label: '企业版', variant: 'default' as const }
    }

    const config = badgeVariants[subscription.tier as keyof typeof badgeVariants]
    return config ? <Badge variant={config.variant}>{config.label}</Badge> : null
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" className="relative h-10 w-10 rounded-full">
          <Avatar className="h-10 w-10">
            <AvatarImage src={user.image || undefined} alt={user.name || '用户头像'} />
            <AvatarFallback>
              {user.name?.charAt(0).toUpperCase() || user.email?.charAt(0).toUpperCase() || 'U'}
            </AvatarFallback>
          </Avatar>
        </Button>
      </DropdownMenuTrigger>
      
      <DropdownMenuContent className="w-56" align="end" forceMount>
        <DropdownMenuLabel className="font-normal">
          <div className="flex flex-col space-y-1">
            <p className="text-sm font-medium leading-none">
              {user.name || '未设置姓名'}
            </p>
            <p className="text-xs leading-none text-muted-foreground">
              {user.email}
            </p>
            <div className="mt-1">
              {getSubscriptionBadge()}
            </div>
          </div>
        </DropdownMenuLabel>
        
        <DropdownMenuSeparator />
        
        <DropdownMenuItem asChild>
          <Link to="/dashboard" className="w-full">
            仪表板
          </Link>
        </DropdownMenuItem>
        
        <DropdownMenuItem asChild>
          <Link to="/portfolio" className="w-full">
            我的投资组合
          </Link>
        </DropdownMenuItem>
        
        {subscription && subscription.tier !== 'free' && (
          <>
            <DropdownMenuItem asChild>
              <Link to="/strategies" className="w-full">
                我的策略
              </Link>
            </DropdownMenuItem>
            
            <DropdownMenuItem asChild>
              <Link to="/backtest" className="w-full">
                回测分析
              </Link>
            </DropdownMenuItem>
          </>
        )}
        
        <DropdownMenuSeparator />
        
        <DropdownMenuItem asChild>
          <Link to="/settings" className="w-full">
            设置
          </Link>
        </DropdownMenuItem>
        
        <DropdownMenuItem asChild>
          <Link to="/subscription" className="w-full">
            订阅管理
            {!subscription && (
              <Badge variant="outline" className="ml-2">升级</Badge>
            )}
          </Link>
        </DropdownMenuItem>
        
        {user.isAdmin && (
          <>
            <DropdownMenuSeparator />
            <DropdownMenuItem asChild>
              <Link to="/admin" className="w-full text-amber-600">
                管理后台
              </Link>
            </DropdownMenuItem>
          </>
        )}
        
        <DropdownMenuSeparator />
        
        <DropdownMenuItem 
          className="w-full text-red-600 focus:text-red-600"
          onClick={() => signOut()}
        >
          退出登录
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

## 3. 深度链接和SEO优化

### 3.1 SEO元数据管理
```typescript
// apps/web/src/lib/seo.ts
export interface SEOMetadata {
  title: string
  description: string
  keywords?: string[]
  ogImage?: string
  ogType?: 'website' | 'article'
  noIndex?: boolean
  canonicalUrl?: string
}

export const generateSEOMetadata = (
  route: RouteConfig, 
  params?: Record<string, string>
): SEOMetadata => {
  let title = route.title
  let description = route.description
  
  // 处理动态路由参数
  if (params) {
    Object.entries(params).forEach(([key, value]) => {
      title = title.replace(`$${key}`, value)
      description = description.replace(`$${key}`, value)
    })
  }

  return {
    title,
    description,
    keywords: generateKeywords(route),
    ogImage: `/og-images/${route.path.replace(/\//g, '-') || 'default'}.png`,
    ogType: 'website',
    canonicalUrl: `https://neostock.com${route.path}`
  }
}

const generateKeywords = (route: RouteConfig): string[] => {
  const baseKeywords = ['neostock', 'A股', '股票分析', '中国股市']
  
  const routeSpecificKeywords: Record<string, string[]> = {
    '/stocks': ['股票列表', '股票搜索', '股价查询'],
    '/strategies': ['交易策略', '投资策略', '策略回测'],
    '/backtest': ['回测分析', '历史回测', '策略验证'],
    '/ai-analysis': ['AI分析', '智能投顾', '量化分析'],
    '/portfolio': ['投资组合', '资产配置', '收益分析']
  }

  return [...baseKeywords, ...(routeSpecificKeywords[route.path] || [])]
}
```

### 3.2 链接预加载策略
```typescript
// apps/web/src/hooks/use-link-prefetch.ts
import { useEffect } from 'react'
import { useRouter } from '@tanstack/react-router'

interface PrefetchConfig {
  routes: string[]
  delay?: number
  onIdle?: boolean
}

export const useLinkPrefetch = (config: PrefetchConfig) => {
  const router = useRouter()

  useEffect(() => {
    const prefetchRoutes = () => {
      config.routes.forEach(route => {
        router.preloadRoute({ to: route })
      })
    }

    if (config.onIdle) {
      // 在浏览器空闲时预加载
      if ('requestIdleCallback' in window) {
        requestIdleCallback(prefetchRoutes)
      } else {
        // 降级到 setTimeout
        setTimeout(prefetchRoutes, config.delay || 100)
      }
    } else {
      const timer = setTimeout(prefetchRoutes, config.delay || 100)
      return () => clearTimeout(timer)
    }
  }, [config.routes, config.delay, config.onIdle, router])
}

// 智能预加载组件
export const SmartPrefetch = () => {
  const { user } = useAuth()
  const { subscription } = useSubscription()

  // 根据用户状态智能预加载相关路由
  const getRelevantRoutes = (): string[] => {
    if (!user) {
      return ['/login', '/register']
    }

    const baseRoutes = ['/dashboard', '/stocks', '/portfolio']
    
    if (subscription && subscription.tier !== 'free') {
      baseRoutes.push('/strategies', '/backtest')
    }

    if (subscription?.tier === 'premium') {
      baseRoutes.push('/ai-analysis')
    }

    return baseRoutes
  }

  useLinkPrefetch({
    routes: getRelevantRoutes(),
    delay: 2000,
    onIdle: true
  })

  return null
}
```

## 4. 错误处理和回退

### 4.1 路由错误边界
```typescript
// apps/web/src/components/route-error-boundary.tsx
import { ErrorBoundary, type FallbackProps } from 'react-error-boundary'
import { Button } from '@/components/ui/button'
import { AlertCircleIcon, HomeIcon, RefreshCwIcon } from 'lucide-react'

interface RouteErrorFallbackProps extends FallbackProps {
  routePath?: string
}

const RouteErrorFallback = ({ error, resetErrorBoundary, routePath }: RouteErrorFallbackProps) => {
  const getErrorMessage = () => {
    if (error?.message?.includes('404')) {
      return '页面不存在'
    }
    if (error?.message?.includes('403')) {
      return '您没有权限访问此页面'
    }
    if (error?.message?.includes('500')) {
      return '服务器内部错误'
    }
    return '页面加载出错'
  }

  const getErrorDescription = () => {
    if (error?.message?.includes('404')) {
      return '您访问的页面不存在，可能已被删除或移动。'
    }
    if (error?.message?.includes('403')) {
      return '此页面需要更高的权限或订阅级别才能访问。'
    }
    return '页面加载时发生了错误，请稍后重试。'
  }

  return (
    <div className="min-h-[50vh] flex items-center justify-center">
      <div className="text-center space-y-6 p-8">
        <div className="mx-auto w-12 h-12 bg-destructive/10 rounded-full flex items-center justify-center">
          <AlertCircleIcon className="w-6 h-6 text-destructive" />
        </div>
        
        <div className="space-y-2">
          <h1 className="text-2xl font-semibold text-foreground">
            {getErrorMessage()}
          </h1>
          <p className="text-muted-foreground max-w-md mx-auto">
            {getErrorDescription()}
          </p>
        </div>

        <div className="flex flex-col sm:flex-row gap-3 justify-center">
          <Button onClick={resetErrorBoundary} variant="default">
            <RefreshCwIcon className="w-4 h-4 mr-2" />
            重新加载
          </Button>
          
          <Button asChild variant="outline">
            <Link to="/">
              <HomeIcon className="w-4 h-4 mr-2" />
              返回首页
            </Link>
          </Button>
        </div>

        {process.env.NODE_ENV === 'development' && (
          <details className="mt-6 text-left">
            <summary className="cursor-pointer text-sm text-muted-foreground">
              错误详情 (开发模式)
            </summary>
            <pre className="mt-2 p-4 bg-muted rounded-md text-xs overflow-auto">
              {error?.stack || error?.message}
            </pre>
          </details>
        )}
      </div>
    </div>
  )
}

export const RouteErrorBoundary = ({ 
  children, 
  routePath 
}: { 
  children: React.ReactNode
  routePath?: string 
}) => {
  return (
    <ErrorBoundary 
      FallbackComponent={(props) => (
        <RouteErrorFallback {...props} routePath={routePath} />
      )}
      onError={(error, errorInfo) => {
        console.error('Route Error:', error, errorInfo)
        // 发送错误到监控服务
        // errorTracker.captureException(error, { extra: errorInfo })
      }}
    >
      {children}
    </ErrorBoundary>
  )
}
```

### 4.2 未找到路由处理
```typescript
// apps/web/src/routes/__root.tsx 中的 notFoundComponent
export const NotFoundPage = () => {
  const navigate = useNavigate()
  const location = useLocation()

  const getSuggestions = (): { label: string; path: string }[] => {
    const suggestions = [
      { label: '仪表板', path: '/dashboard' },
      { label: '股票列表', path: '/stocks' },
      { label: '投资组合', path: '/portfolio' }
    ]

    // 根据当前路径提供智能建议
    if (location.pathname.includes('stock')) {
      suggestions.unshift({ label: '股票搜索', path: '/stocks' })
    }
    if (location.pathname.includes('strategy')) {
      suggestions.unshift({ label: '交易策略', path: '/strategies' })
    }

    return suggestions.slice(0, 3) // 只显示前3个建议
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-background to-muted">
      <div className="text-center space-y-6 p-8 max-w-md">
        <div className="space-y-2">
          <h1 className="text-6xl font-bold text-muted-foreground">404</h1>
          <h2 className="text-2xl font-semibold">页面未找到</h2>
          <p className="text-muted-foreground">
            您访问的页面 <code className="bg-muted px-1 rounded">{location.pathname}</code> 不存在。
          </p>
        </div>

        <div className="space-y-3">
          <p className="text-sm text-muted-foreground">您可能在寻找：</p>
          <div className="space-y-2">
            {getSuggestions().map(suggestion => (
              <Button 
                key={suggestion.path}
                variant="outline" 
                className="w-full"
                asChild
              >
                <Link to={suggestion.path}>
                  {suggestion.label}
                </Link>
              </Button>
            ))}
          </div>
        </div>

        <div className="flex gap-3 justify-center">
          <Button onClick={() => navigate({ to: -1 })}>
            返回上一页
          </Button>
          <Button asChild variant="outline">
            <Link to="/">
              <HomeIcon className="w-4 h-4 mr-2" />
              返回首页
            </Link>
          </Button>
        </div>
      </div>
    </div>
  )
}
```

## 5. 导航性能优化

### 5.1 路由懒加载
```typescript
// apps/web/src/routes/index.ts
import { lazy } from 'react'

// 懒加载路由组件
export const routeComponents = {
  // 高频访问页面 - 预加载
  Dashboard: lazy(() => import('./dashboard')),
  StockList: lazy(() => import('./stocks/index')),
  
  // 中频访问页面 - 按需加载
  StockDetail: lazy(() => import('./stocks/$symbol')),
  Portfolio: lazy(() => import('./portfolio')),
  
  // 低频访问页面 - 延迟加载
  StrategyBuilder: lazy(() => import('./strategies/create')),
  BacktestResult: lazy(() => import('./backtest/$id')),
  
  // 管理页面 - 仅在需要时加载
  Admin: lazy(() => import('./admin'))
}

// 路由加载优先级配置
export const ROUTE_LOADING_PRIORITIES = {
  high: ['/dashboard', '/stocks', '/portfolio'],
  medium: ['/strategies', '/backtest', '/settings'],
  low: ['/admin', '/ai-analysis']
}
```

### 5.2 导航状态管理
```typescript
// apps/web/src/stores/navigation-store.ts
import { create } from 'zustand'

interface NavigationState {
  isNavigating: boolean
  previousPath: string | null
  navigationHistory: string[]
  breadcrumbs: BreadcrumbItem[]
  setNavigating: (isNavigating: boolean) => void
  addToHistory: (path: string) => void
  updateBreadcrumbs: (breadcrumbs: BreadcrumbItem[]) => void
}

export const useNavigationStore = create<NavigationState>((set, get) => ({
  isNavigating: false,
  previousPath: null,
  navigationHistory: [],
  breadcrumbs: [],
  
  setNavigating: (isNavigating) => set({ isNavigating }),
  
  addToHistory: (path) => set((state) => ({
    previousPath: state.navigationHistory[state.navigationHistory.length - 1] || null,
    navigationHistory: [...state.navigationHistory.slice(-9), path] // 保留最近10个路径
  })),
  
  updateBreadcrumbs: (breadcrumbs) => set({ breadcrumbs })
}))
```

## 6. 实施检查清单

### 6.1 开发阶段
- [ ] 实现路由保护组件
- [ ] 配置导航组件架构
- [ ] 建立面包屑系统
- [ ] 实现用户菜单和权限显示
- [ ] 配置SEO元数据管理

### 6.2 测试阶段
- [ ] 路由保护功能测试
- [ ] 导航一致性测试
- [ ] 深度链接测试
- [ ] 错误边界测试
- [ ] 性能和加载测试

### 6.3 部署阶段
- [ ] 生产环境路由配置
- [ ] SEO优化验证
- [ ] 错误监控配置
- [ ] 性能监控设置
- [ ] 用户体验测试

## 7. 导航规范总结

| 组件 | 功能 | 实施状态 | 优先级 |
|------|------|----------|--------|
| 路由保护 | 基于用户状态和权限的访问控制 | ✅ 已实施 | 🔴 高 |
| 主导航 | 一致的主菜单和权限显示 | ✅ 已实施 | 🔴 高 |
| 面包屑 | 层级导航和位置指示 | ✅ 已实施 | 🟡 中 |
| 用户菜单 | 个人设置和订阅状态显示 | ✅ 已实施 | 🔴 高 |
| 错误边界 | 优雅的错误处理和回退 | ✅ 已实施 | 🔴 高 |
| SEO优化 | 搜索引擎友好的路由结构 | ✅ 已实施 | 🟡 中 |