# è·¯ç”±ä¿æŠ¤å’Œå¯¼èˆªè§„èŒƒ

## 1. è·¯ç”±æ¶æ„å’Œä¿æŠ¤ç­–ç•¥

### 1.1 è·¯ç”±ä¿æŠ¤çº§åˆ«
```typescript
// apps/web/src/lib/route-protection.ts
export enum RouteProtectionLevel {
  PUBLIC = 'public',           // å…¬å¼€è·¯ç”±ï¼šç™»å½•ã€æ³¨å†Œã€å…¬å…±é¡µé¢
  AUTHENTICATED = 'authenticated', // éœ€è¦ç™»å½•ï¼šä»ªè¡¨æ¿ã€ä¸ªäººè®¾ç½®
  SUBSCRIPTION = 'subscription',   // éœ€è¦è®¢é˜…ï¼šé«˜çº§åŠŸèƒ½
  ADMIN = 'admin'             // ç®¡ç†å‘˜ï¼šç³»ç»Ÿç®¡ç†
}

export interface RouteConfig {
  path: string
  protectionLevel: RouteProtectionLevel
  requiredPermissions?: string[]
  subscriptionTier?: SubscriptionTier
  component: string
  title: string
  description: string
  seoMetadata?: SEOMetadata
}

export enum SubscriptionTier {
  FREE = 'free',
  BASIC = 'basic', 
  PREMIUM = 'premium',
  ENTERPRISE = 'enterprise'
}

// å®Œæ•´è·¯ç”±æ˜ å°„è¡¨
export const ROUTE_DEFINITIONS: RouteConfig[] = [
  // å…¬å¼€è·¯ç”±
  {
    path: '/',
    protectionLevel: RouteProtectionLevel.PUBLIC,
    component: 'IndexPage',
    title: 'neostock - ä¸­å›½è‚¡ç¥¨åˆ†æå¹³å°',
    description: 'ä¸“ä¸šçš„Aè‚¡åˆ†æå’Œç­–ç•¥å›æµ‹å¹³å°'
  },
  {
    path: '/login',
    protectionLevel: RouteProtectionLevel.PUBLIC,
    component: 'LoginPage',
    title: 'ç™»å½• - neostock',
    description: 'ç™»å½•æ‚¨çš„neostockè´¦æˆ·'
  },
  {
    path: '/register', 
    protectionLevel: RouteProtectionLevel.PUBLIC,
    component: 'RegisterPage',
    title: 'æ³¨å†Œ - neostock',
    description: 'åˆ›å»ºæ‚¨çš„neostockè´¦æˆ·'
  },

  // è®¤è¯ç”¨æˆ·è·¯ç”±
  {
    path: '/dashboard',
    protectionLevel: RouteProtectionLevel.AUTHENTICATED,
    component: 'DashboardPage',
    title: 'ä»ªè¡¨æ¿ - neostock',
    description: 'æ‚¨çš„æŠ•èµ„æ¦‚è§ˆå’Œæœ€æ–°å¸‚åœºåŠ¨æ€'
  },
  {
    path: '/stocks',
    protectionLevel: RouteProtectionLevel.AUTHENTICATED,
    component: 'StockListPage', 
    title: 'è‚¡ç¥¨åˆ—è¡¨ - neostock',
    description: 'Aè‚¡å¸‚åœºè‚¡ç¥¨æœç´¢å’ŒåŸºæœ¬ä¿¡æ¯'
  },
  {
    path: '/stocks/$symbol',
    protectionLevel: RouteProtectionLevel.AUTHENTICATED,
    component: 'StockDetailPage',
    title: '$symbol è‚¡ç¥¨è¯¦æƒ… - neostock',
    description: 'æŸ¥çœ‹ $symbol çš„è¯¦ç»†ä¿¡æ¯ã€å›¾è¡¨å’ŒæŠ€æœ¯åˆ†æ'
  },
  {
    path: '/portfolio',
    protectionLevel: RouteProtectionLevel.AUTHENTICATED,
    component: 'PortfolioPage',
    title: 'æˆ‘çš„æŠ•èµ„ç»„åˆ - neostock',
    description: 'ç®¡ç†å’Œè·Ÿè¸ªæ‚¨çš„æŠ•èµ„ç»„åˆè¡¨ç°'
  },

  // è®¢é˜…ç”¨æˆ·è·¯ç”±
  {
    path: '/strategies',
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionTier: SubscriptionTier.BASIC,
    component: 'StrategyListPage',
    title: 'äº¤æ˜“ç­–ç•¥ - neostock',
    description: 'åˆ›å»ºå’Œç®¡ç†æ‚¨çš„äº¤æ˜“ç­–ç•¥'
  },
  {
    path: '/strategies/create',
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionTier: SubscriptionTier.BASIC,
    component: 'StrategyBuilderPage',
    title: 'ç­–ç•¥æ„å»ºå™¨ - neostock',
    description: 'ä½¿ç”¨å¯è§†åŒ–å·¥å…·æ„å»ºæ‚¨çš„äº¤æ˜“ç­–ç•¥'
  },
  {
    path: '/backtest',
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionTier: SubscriptionTier.BASIC,
    component: 'BacktestPage',
    title: 'ç­–ç•¥å›æµ‹ - neostock',
    description: 'æµ‹è¯•æ‚¨çš„ç­–ç•¥åœ¨å†å²æ•°æ®ä¸Šçš„è¡¨ç°'
  },
  {
    path: '/backtest/$id',
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionTier: SubscriptionTier.BASIC,
    component: 'BacktestResultPage',
    title: 'å›æµ‹ç»“æœ - neostock',
    description: 'æŸ¥çœ‹è¯¦ç»†çš„å›æµ‹ç»“æœå’Œæ€§èƒ½åˆ†æ'
  },
  {
    path: '/ai-analysis',
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionTier: SubscriptionTier.PREMIUM,
    component: 'AIAnalysisPage',
    title: 'AIåˆ†æ - neostock',
    description: 'AIé©±åŠ¨çš„è‚¡ç¥¨åˆ†æå’ŒæŠ•èµ„å»ºè®®'
  },

  // ç”¨æˆ·è®¾ç½®å’Œè´¦æˆ·ç®¡ç†
  {
    path: '/settings',
    protectionLevel: RouteProtectionLevel.AUTHENTICATED,
    component: 'SettingsPage',
    title: 'è®¾ç½® - neostock',
    description: 'ç®¡ç†æ‚¨çš„è´¦æˆ·è®¾ç½®å’Œåå¥½'
  },
  {
    path: '/subscription',
    protectionLevel: RouteProtectionLevel.AUTHENTICATED,
    component: 'SubscriptionPage',
    title: 'è®¢é˜…ç®¡ç† - neostock',
    description: 'ç®¡ç†æ‚¨çš„è®¢é˜…è®¡åˆ’å’Œä»˜è´¹åŠŸèƒ½'
  },

  // ç®¡ç†å‘˜è·¯ç”±
  {
    path: '/admin',
    protectionLevel: RouteProtectionLevel.ADMIN,
    requiredPermissions: ['admin.access'],
    component: 'AdminDashboardPage',
    title: 'ç®¡ç†åå° - neostock',
    description: 'ç³»ç»Ÿç®¡ç†å’Œç”¨æˆ·ç®¡ç†'
  }
]
```

### 1.2 è·¯ç”±ä¿æŠ¤å®ç°
```typescript
// apps/web/src/components/route-protection.tsx
import { useAuth } from '@/hooks/use-auth'
import { useSubscription } from '@/hooks/use-subscription'
import { Navigate, useLocation } from '@tanstack/react-router'
import { RouteProtectionLevel, SubscriptionTier, type RouteConfig } from '@/lib/route-protection'

interface RouteProtectionProps {
  config: RouteConfig
  children: React.ReactNode
}

export const RouteProtection = ({ config, children }: RouteProtectionProps) => {
  const { user, isLoading: authLoading } = useAuth()
  const { subscription, isLoading: subLoading } = useSubscription()
  const location = useLocation()

  // è®¤è¯åŠ è½½ä¸­
  if (authLoading || subLoading) {
    return <div className="flex justify-center items-center min-h-screen">
      <div className="animate-spin h-8 w-8 border-b-2 border-primary rounded-full"></div>
    </div>
  }

  // å…¬å¼€è·¯ç”±ç›´æ¥æ”¾è¡Œ
  if (config.protectionLevel === RouteProtectionLevel.PUBLIC) {
    return <>{children}</>
  }

  // éœ€è¦è®¤è¯ä½†æœªç™»å½•
  if (!user && config.protectionLevel !== RouteProtectionLevel.PUBLIC) {
    return <Navigate 
      to="/login" 
      search={{ redirect: location.pathname }}
      replace
    />
  }

  // éœ€è¦è®¢é˜…ä½†æœªè®¢é˜…
  if (config.protectionLevel === RouteProtectionLevel.SUBSCRIPTION) {
    if (!subscription || !hasRequiredSubscription(subscription.tier, config.subscriptionTier)) {
      return <Navigate to="/subscription" replace />
    }
  }

  // éœ€è¦ç®¡ç†å‘˜æƒé™ä½†ä¸æ˜¯ç®¡ç†å‘˜
  if (config.protectionLevel === RouteProtectionLevel.ADMIN) {
    if (!user?.isAdmin || !hasRequiredPermissions(user.permissions, config.requiredPermissions)) {
      return <Navigate to="/dashboard" replace />
    }
  }

  return <>{children}</>
}

// æ£€æŸ¥è®¢é˜…çº§åˆ«
const hasRequiredSubscription = (
  userTier: SubscriptionTier | undefined, 
  requiredTier: SubscriptionTier | undefined
): boolean => {
  if (!requiredTier) return true
  if (!userTier) return false

  const tierHierarchy = {
    [SubscriptionTier.FREE]: 0,
    [SubscriptionTier.BASIC]: 1,
    [SubscriptionTier.PREMIUM]: 2,
    [SubscriptionTier.ENTERPRISE]: 3
  }

  return tierHierarchy[userTier] >= tierHierarchy[requiredTier]
}

// æ£€æŸ¥æƒé™
const hasRequiredPermissions = (
  userPermissions: string[] | undefined,
  requiredPermissions: string[] | undefined
): boolean => {
  if (!requiredPermissions || requiredPermissions.length === 0) return true
  if (!userPermissions || userPermissions.length === 0) return false

  return requiredPermissions.every(permission => 
    userPermissions.includes(permission)
  )
}
```

## 2. å¯¼èˆªç³»ç»Ÿå’Œä¸€è‡´æ€§

### 2.1 å¯¼èˆªç»„ä»¶æ¶æ„
```typescript
// apps/web/src/components/navigation/main-nav.tsx
import { Link, useRouter } from '@tanstack/react-router'
import { useAuth } from '@/hooks/use-auth'
import { useSubscription } from '@/hooks/use-subscription'
import { ROUTE_DEFINITIONS, RouteProtectionLevel } from '@/lib/route-protection'

interface NavItem {
  label: string
  path: string
  icon?: React.ComponentType<{ className?: string }>
  protectionLevel: RouteProtectionLevel
  subscriptionRequired?: boolean
  children?: NavItem[]
}

export const NAVIGATION_CONFIG: NavItem[] = [
  {
    label: 'é¦–é¡µ',
    path: '/',
    icon: HomeIcon,
    protectionLevel: RouteProtectionLevel.PUBLIC
  },
  {
    label: 'ä»ªè¡¨æ¿',
    path: '/dashboard',
    icon: DashboardIcon,
    protectionLevel: RouteProtectionLevel.AUTHENTICATED
  },
  {
    label: 'è‚¡ç¥¨',
    path: '/stocks',
    icon: TrendingUpIcon,
    protectionLevel: RouteProtectionLevel.AUTHENTICATED
  },
  {
    label: 'æŠ•èµ„ç»„åˆ',
    path: '/portfolio',
    icon: PieChartIcon,
    protectionLevel: RouteProtectionLevel.AUTHENTICATED
  },
  {
    label: 'ç­–ç•¥',
    path: '/strategies',
    icon: TargetIcon,
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionRequired: true,
    children: [
      {
        label: 'æˆ‘çš„ç­–ç•¥',
        path: '/strategies',
        protectionLevel: RouteProtectionLevel.SUBSCRIPTION
      },
      {
        label: 'ç­–ç•¥æ„å»ºå™¨',
        path: '/strategies/create',
        protectionLevel: RouteProtectionLevel.SUBSCRIPTION
      },
      {
        label: 'å›æµ‹åˆ†æ',
        path: '/backtest',
        protectionLevel: RouteProtectionLevel.SUBSCRIPTION
      }
    ]
  },
  {
    label: 'AIåˆ†æ',
    path: '/ai-analysis',
    icon: BrainIcon,
    protectionLevel: RouteProtectionLevel.SUBSCRIPTION,
    subscriptionRequired: true
  }
]

export const MainNavigation = () => {
  const { user } = useAuth()
  const { subscription } = useSubscription()
  const router = useRouter()

  const isNavItemAccessible = (item: NavItem): boolean => {
    // å…¬å¼€é¡¹ç›®å§‹ç»ˆå¯è®¿é—®
    if (item.protectionLevel === RouteProtectionLevel.PUBLIC) {
      return true
    }

    // éœ€è¦è®¤è¯ä½†æœªç™»å½•
    if (item.protectionLevel === RouteProtectionLevel.AUTHENTICATED && !user) {
      return false
    }

    // éœ€è¦è®¢é˜…ä½†æœªè®¢é˜…
    if (item.subscriptionRequired && (!subscription || subscription.tier === 'free')) {
      return false
    }

    // éœ€è¦ç®¡ç†å‘˜æƒé™
    if (item.protectionLevel === RouteProtectionLevel.ADMIN && !user?.isAdmin) {
      return false
    }

    return true
  }

  const renderNavItem = (item: NavItem, level: number = 0) => {
    if (!isNavItemAccessible(item)) {
      return null
    }

    const isActive = router.state.location.pathname === item.path
    const hasChildren = item.children && item.children.length > 0

    return (
      <div key={item.path} className={`nav-item-level-${level}`}>
        <Link
          to={item.path}
          className={`
            flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors
            ${isActive 
              ? 'bg-primary text-primary-foreground' 
              : 'text-muted-foreground hover:text-foreground hover:bg-muted'
            }
            ${level > 0 ? 'ml-4' : ''}
          `}
        >
          {item.icon && <item.icon className="mr-3 h-4 w-4" />}
          {item.label}
          {item.subscriptionRequired && !subscription && (
            <span className="ml-2 px-1.5 py-0.5 text-xs bg-amber-100 text-amber-800 rounded">
              Premium
            </span>
          )}
        </Link>
        
        {hasChildren && (
          <div className="mt-1">
            {item.children!.map(child => renderNavItem(child, level + 1))}
          </div>
        )}
      </div>
    )
  }

  return (
    <nav className="space-y-1" role="navigation" aria-label="ä¸»å¯¼èˆª">
      {NAVIGATION_CONFIG.map(item => renderNavItem(item))}
    </nav>
  )
}
```

### 2.2 é¢åŒ…å±‘å¯¼èˆª
```typescript
// apps/web/src/components/navigation/breadcrumb.tsx
import { Link, useMatches } from '@tanstack/react-router'
import { ChevronRightIcon, HomeIcon } from 'lucide-react'
import { ROUTE_DEFINITIONS } from '@/lib/route-protection'

interface BreadcrumbItem {
  label: string
  path: string
  isCurrentPage: boolean
}

export const Breadcrumb = () => {
  const matches = useMatches()
  const currentPath = matches[matches.length - 1]?.pathname || '/'

  const generateBreadcrumbs = (): BreadcrumbItem[] => {
    const breadcrumbs: BreadcrumbItem[] = []
    const pathSegments = currentPath.split('/').filter(Boolean)

    // å§‹ç»ˆåŒ…å«é¦–é¡µ
    breadcrumbs.push({
      label: 'é¦–é¡µ',
      path: '/',
      isCurrentPage: currentPath === '/'
    })

    // ä¸ºæ¯ä¸ªè·¯å¾„æ®µç”Ÿæˆé¢åŒ…å±‘
    let currentFullPath = ''
    pathSegments.forEach((segment, index) => {
      currentFullPath += `/${segment}`
      
      // æŸ¥æ‰¾è·¯ç”±é…ç½®
      const routeConfig = ROUTE_DEFINITIONS.find(route => 
        route.path === currentFullPath || 
        route.path.replace(/\$\w+/g, segment) === currentFullPath
      )

      if (routeConfig) {
        let label = routeConfig.title.split(' - ')[0] // æå–æ ‡é¢˜çš„ç¬¬ä¸€éƒ¨åˆ†
        
        // å¤„ç†åŠ¨æ€è·¯ç”±å‚æ•°
        if (routeConfig.path.includes('$')) {
          label = label.replace(/\$\w+/g, segment.toUpperCase())
        }

        breadcrumbs.push({
          label,
          path: currentFullPath,
          isCurrentPage: index === pathSegments.length - 1
        })
      }
    })

    return breadcrumbs
  }

  const breadcrumbs = generateBreadcrumbs()

  if (breadcrumbs.length <= 1) {
    return null // åœ¨é¦–é¡µæ—¶ä¸æ˜¾ç¤ºé¢åŒ…å±‘
  }

  return (
    <nav aria-label="é¢åŒ…å±‘å¯¼èˆª" className="mb-4">
      <ol className="flex items-center space-x-2 text-sm text-muted-foreground">
        {breadcrumbs.map((crumb, index) => (
          <li key={crumb.path} className="flex items-center">
            {index > 0 && (
              <ChevronRightIcon className="h-4 w-4 mx-2 text-muted-foreground/50" />
            )}
            
            {crumb.isCurrentPage ? (
              <span className="font-medium text-foreground" aria-current="page">
                {index === 0 ? <HomeIcon className="h-4 w-4" /> : crumb.label}
              </span>
            ) : (
              <Link
                to={crumb.path}
                className="hover:text-foreground transition-colors"
              >
                {index === 0 ? <HomeIcon className="h-4 w-4" /> : crumb.label}
              </Link>
            )}
          </li>
        ))}
      </ol>
    </nav>
  )
}
```

### 2.3 ç”¨æˆ·èœå•å’Œæƒé™æ˜¾ç¤º
```typescript
// apps/web/src/components/navigation/user-menu.tsx
import { useState } from 'react'
import { Link } from '@tanstack/react-router'
import { useAuth } from '@/hooks/use-auth'
import { useSubscription } from '@/hooks/use-subscription'
import { 
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Button } from '@/components/ui/button'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'

export const UserMenu = () => {
  const { user, signOut } = useAuth()
  const { subscription } = useSubscription()

  if (!user) {
    return (
      <div className="flex items-center space-x-2">
        <Button variant="ghost" asChild>
          <Link to="/login">ç™»å½•</Link>
        </Button>
        <Button asChild>
          <Link to="/register">æ³¨å†Œ</Link>
        </Button>
      </div>
    )
  }

  const getSubscriptionBadge = () => {
    if (!subscription) return null

    const badgeVariants = {
      free: { label: 'å…è´¹ç‰ˆ', variant: 'secondary' as const },
      basic: { label: 'åŸºç¡€ç‰ˆ', variant: 'default' as const },
      premium: { label: 'é«˜çº§ç‰ˆ', variant: 'default' as const },
      enterprise: { label: 'ä¼ä¸šç‰ˆ', variant: 'default' as const }
    }

    const config = badgeVariants[subscription.tier as keyof typeof badgeVariants]
    return config ? <Badge variant={config.variant}>{config.label}</Badge> : null
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" className="relative h-10 w-10 rounded-full">
          <Avatar className="h-10 w-10">
            <AvatarImage src={user.image || undefined} alt={user.name || 'ç”¨æˆ·å¤´åƒ'} />
            <AvatarFallback>
              {user.name?.charAt(0).toUpperCase() || user.email?.charAt(0).toUpperCase() || 'U'}
            </AvatarFallback>
          </Avatar>
        </Button>
      </DropdownMenuTrigger>
      
      <DropdownMenuContent className="w-56" align="end" forceMount>
        <DropdownMenuLabel className="font-normal">
          <div className="flex flex-col space-y-1">
            <p className="text-sm font-medium leading-none">
              {user.name || 'æœªè®¾ç½®å§“å'}
            </p>
            <p className="text-xs leading-none text-muted-foreground">
              {user.email}
            </p>
            <div className="mt-1">
              {getSubscriptionBadge()}
            </div>
          </div>
        </DropdownMenuLabel>
        
        <DropdownMenuSeparator />
        
        <DropdownMenuItem asChild>
          <Link to="/dashboard" className="w-full">
            ä»ªè¡¨æ¿
          </Link>
        </DropdownMenuItem>
        
        <DropdownMenuItem asChild>
          <Link to="/portfolio" className="w-full">
            æˆ‘çš„æŠ•èµ„ç»„åˆ
          </Link>
        </DropdownMenuItem>
        
        {subscription && subscription.tier !== 'free' && (
          <>
            <DropdownMenuItem asChild>
              <Link to="/strategies" className="w-full">
                æˆ‘çš„ç­–ç•¥
              </Link>
            </DropdownMenuItem>
            
            <DropdownMenuItem asChild>
              <Link to="/backtest" className="w-full">
                å›æµ‹åˆ†æ
              </Link>
            </DropdownMenuItem>
          </>
        )}
        
        <DropdownMenuSeparator />
        
        <DropdownMenuItem asChild>
          <Link to="/settings" className="w-full">
            è®¾ç½®
          </Link>
        </DropdownMenuItem>
        
        <DropdownMenuItem asChild>
          <Link to="/subscription" className="w-full">
            è®¢é˜…ç®¡ç†
            {!subscription && (
              <Badge variant="outline" className="ml-2">å‡çº§</Badge>
            )}
          </Link>
        </DropdownMenuItem>
        
        {user.isAdmin && (
          <>
            <DropdownMenuSeparator />
            <DropdownMenuItem asChild>
              <Link to="/admin" className="w-full text-amber-600">
                ç®¡ç†åå°
              </Link>
            </DropdownMenuItem>
          </>
        )}
        
        <DropdownMenuSeparator />
        
        <DropdownMenuItem 
          className="w-full text-red-600 focus:text-red-600"
          onClick={() => signOut()}
        >
          é€€å‡ºç™»å½•
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

## 3. æ·±åº¦é“¾æ¥å’ŒSEOä¼˜åŒ–

### 3.1 SEOå…ƒæ•°æ®ç®¡ç†
```typescript
// apps/web/src/lib/seo.ts
export interface SEOMetadata {
  title: string
  description: string
  keywords?: string[]
  ogImage?: string
  ogType?: 'website' | 'article'
  noIndex?: boolean
  canonicalUrl?: string
}

export const generateSEOMetadata = (
  route: RouteConfig, 
  params?: Record<string, string>
): SEOMetadata => {
  let title = route.title
  let description = route.description
  
  // å¤„ç†åŠ¨æ€è·¯ç”±å‚æ•°
  if (params) {
    Object.entries(params).forEach(([key, value]) => {
      title = title.replace(`$${key}`, value)
      description = description.replace(`$${key}`, value)
    })
  }

  return {
    title,
    description,
    keywords: generateKeywords(route),
    ogImage: `/og-images/${route.path.replace(/\//g, '-') || 'default'}.png`,
    ogType: 'website',
    canonicalUrl: `https://neostock.com${route.path}`
  }
}

const generateKeywords = (route: RouteConfig): string[] => {
  const baseKeywords = ['neostock', 'Aè‚¡', 'è‚¡ç¥¨åˆ†æ', 'ä¸­å›½è‚¡å¸‚']
  
  const routeSpecificKeywords: Record<string, string[]> = {
    '/stocks': ['è‚¡ç¥¨åˆ—è¡¨', 'è‚¡ç¥¨æœç´¢', 'è‚¡ä»·æŸ¥è¯¢'],
    '/strategies': ['äº¤æ˜“ç­–ç•¥', 'æŠ•èµ„ç­–ç•¥', 'ç­–ç•¥å›æµ‹'],
    '/backtest': ['å›æµ‹åˆ†æ', 'å†å²å›æµ‹', 'ç­–ç•¥éªŒè¯'],
    '/ai-analysis': ['AIåˆ†æ', 'æ™ºèƒ½æŠ•é¡¾', 'é‡åŒ–åˆ†æ'],
    '/portfolio': ['æŠ•èµ„ç»„åˆ', 'èµ„äº§é…ç½®', 'æ”¶ç›Šåˆ†æ']
  }

  return [...baseKeywords, ...(routeSpecificKeywords[route.path] || [])]
}
```

### 3.2 é“¾æ¥é¢„åŠ è½½ç­–ç•¥
```typescript
// apps/web/src/hooks/use-link-prefetch.ts
import { useEffect } from 'react'
import { useRouter } from '@tanstack/react-router'

interface PrefetchConfig {
  routes: string[]
  delay?: number
  onIdle?: boolean
}

export const useLinkPrefetch = (config: PrefetchConfig) => {
  const router = useRouter()

  useEffect(() => {
    const prefetchRoutes = () => {
      config.routes.forEach(route => {
        router.preloadRoute({ to: route })
      })
    }

    if (config.onIdle) {
      // åœ¨æµè§ˆå™¨ç©ºé—²æ—¶é¢„åŠ è½½
      if ('requestIdleCallback' in window) {
        requestIdleCallback(prefetchRoutes)
      } else {
        // é™çº§åˆ° setTimeout
        setTimeout(prefetchRoutes, config.delay || 100)
      }
    } else {
      const timer = setTimeout(prefetchRoutes, config.delay || 100)
      return () => clearTimeout(timer)
    }
  }, [config.routes, config.delay, config.onIdle, router])
}

// æ™ºèƒ½é¢„åŠ è½½ç»„ä»¶
export const SmartPrefetch = () => {
  const { user } = useAuth()
  const { subscription } = useSubscription()

  // æ ¹æ®ç”¨æˆ·çŠ¶æ€æ™ºèƒ½é¢„åŠ è½½ç›¸å…³è·¯ç”±
  const getRelevantRoutes = (): string[] => {
    if (!user) {
      return ['/login', '/register']
    }

    const baseRoutes = ['/dashboard', '/stocks', '/portfolio']
    
    if (subscription && subscription.tier !== 'free') {
      baseRoutes.push('/strategies', '/backtest')
    }

    if (subscription?.tier === 'premium') {
      baseRoutes.push('/ai-analysis')
    }

    return baseRoutes
  }

  useLinkPrefetch({
    routes: getRelevantRoutes(),
    delay: 2000,
    onIdle: true
  })

  return null
}
```

## 4. é”™è¯¯å¤„ç†å’Œå›é€€

### 4.1 è·¯ç”±é”™è¯¯è¾¹ç•Œ
```typescript
// apps/web/src/components/route-error-boundary.tsx
import { ErrorBoundary, type FallbackProps } from 'react-error-boundary'
import { Button } from '@/components/ui/button'
import { AlertCircleIcon, HomeIcon, RefreshCwIcon } from 'lucide-react'

interface RouteErrorFallbackProps extends FallbackProps {
  routePath?: string
}

const RouteErrorFallback = ({ error, resetErrorBoundary, routePath }: RouteErrorFallbackProps) => {
  const getErrorMessage = () => {
    if (error?.message?.includes('404')) {
      return 'é¡µé¢ä¸å­˜åœ¨'
    }
    if (error?.message?.includes('403')) {
      return 'æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢'
    }
    if (error?.message?.includes('500')) {
      return 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    }
    return 'é¡µé¢åŠ è½½å‡ºé”™'
  }

  const getErrorDescription = () => {
    if (error?.message?.includes('404')) {
      return 'æ‚¨è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«åˆ é™¤æˆ–ç§»åŠ¨ã€‚'
    }
    if (error?.message?.includes('403')) {
      return 'æ­¤é¡µé¢éœ€è¦æ›´é«˜çš„æƒé™æˆ–è®¢é˜…çº§åˆ«æ‰èƒ½è®¿é—®ã€‚'
    }
    return 'é¡µé¢åŠ è½½æ—¶å‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚'
  }

  return (
    <div className="min-h-[50vh] flex items-center justify-center">
      <div className="text-center space-y-6 p-8">
        <div className="mx-auto w-12 h-12 bg-destructive/10 rounded-full flex items-center justify-center">
          <AlertCircleIcon className="w-6 h-6 text-destructive" />
        </div>
        
        <div className="space-y-2">
          <h1 className="text-2xl font-semibold text-foreground">
            {getErrorMessage()}
          </h1>
          <p className="text-muted-foreground max-w-md mx-auto">
            {getErrorDescription()}
          </p>
        </div>

        <div className="flex flex-col sm:flex-row gap-3 justify-center">
          <Button onClick={resetErrorBoundary} variant="default">
            <RefreshCwIcon className="w-4 h-4 mr-2" />
            é‡æ–°åŠ è½½
          </Button>
          
          <Button asChild variant="outline">
            <Link to="/">
              <HomeIcon className="w-4 h-4 mr-2" />
              è¿”å›é¦–é¡µ
            </Link>
          </Button>
        </div>

        {process.env.NODE_ENV === 'development' && (
          <details className="mt-6 text-left">
            <summary className="cursor-pointer text-sm text-muted-foreground">
              é”™è¯¯è¯¦æƒ… (å¼€å‘æ¨¡å¼)
            </summary>
            <pre className="mt-2 p-4 bg-muted rounded-md text-xs overflow-auto">
              {error?.stack || error?.message}
            </pre>
          </details>
        )}
      </div>
    </div>
  )
}

export const RouteErrorBoundary = ({ 
  children, 
  routePath 
}: { 
  children: React.ReactNode
  routePath?: string 
}) => {
  return (
    <ErrorBoundary 
      FallbackComponent={(props) => (
        <RouteErrorFallback {...props} routePath={routePath} />
      )}
      onError={(error, errorInfo) => {
        console.error('Route Error:', error, errorInfo)
        // å‘é€é”™è¯¯åˆ°ç›‘æ§æœåŠ¡
        // errorTracker.captureException(error, { extra: errorInfo })
      }}
    >
      {children}
    </ErrorBoundary>
  )
}
```

### 4.2 æœªæ‰¾åˆ°è·¯ç”±å¤„ç†
```typescript
// apps/web/src/routes/__root.tsx ä¸­çš„ notFoundComponent
export const NotFoundPage = () => {
  const navigate = useNavigate()
  const location = useLocation()

  const getSuggestions = (): { label: string; path: string }[] => {
    const suggestions = [
      { label: 'ä»ªè¡¨æ¿', path: '/dashboard' },
      { label: 'è‚¡ç¥¨åˆ—è¡¨', path: '/stocks' },
      { label: 'æŠ•èµ„ç»„åˆ', path: '/portfolio' }
    ]

    // æ ¹æ®å½“å‰è·¯å¾„æä¾›æ™ºèƒ½å»ºè®®
    if (location.pathname.includes('stock')) {
      suggestions.unshift({ label: 'è‚¡ç¥¨æœç´¢', path: '/stocks' })
    }
    if (location.pathname.includes('strategy')) {
      suggestions.unshift({ label: 'äº¤æ˜“ç­–ç•¥', path: '/strategies' })
    }

    return suggestions.slice(0, 3) // åªæ˜¾ç¤ºå‰3ä¸ªå»ºè®®
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-background to-muted">
      <div className="text-center space-y-6 p-8 max-w-md">
        <div className="space-y-2">
          <h1 className="text-6xl font-bold text-muted-foreground">404</h1>
          <h2 className="text-2xl font-semibold">é¡µé¢æœªæ‰¾åˆ°</h2>
          <p className="text-muted-foreground">
            æ‚¨è®¿é—®çš„é¡µé¢ <code className="bg-muted px-1 rounded">{location.pathname}</code> ä¸å­˜åœ¨ã€‚
          </p>
        </div>

        <div className="space-y-3">
          <p className="text-sm text-muted-foreground">æ‚¨å¯èƒ½åœ¨å¯»æ‰¾ï¼š</p>
          <div className="space-y-2">
            {getSuggestions().map(suggestion => (
              <Button 
                key={suggestion.path}
                variant="outline" 
                className="w-full"
                asChild
              >
                <Link to={suggestion.path}>
                  {suggestion.label}
                </Link>
              </Button>
            ))}
          </div>
        </div>

        <div className="flex gap-3 justify-center">
          <Button onClick={() => navigate({ to: -1 })}>
            è¿”å›ä¸Šä¸€é¡µ
          </Button>
          <Button asChild variant="outline">
            <Link to="/">
              <HomeIcon className="w-4 h-4 mr-2" />
              è¿”å›é¦–é¡µ
            </Link>
          </Button>
        </div>
      </div>
    </div>
  )
}
```

## 5. å¯¼èˆªæ€§èƒ½ä¼˜åŒ–

### 5.1 è·¯ç”±æ‡’åŠ è½½
```typescript
// apps/web/src/routes/index.ts
import { lazy } from 'react'

// æ‡’åŠ è½½è·¯ç”±ç»„ä»¶
export const routeComponents = {
  // é«˜é¢‘è®¿é—®é¡µé¢ - é¢„åŠ è½½
  Dashboard: lazy(() => import('./dashboard')),
  StockList: lazy(() => import('./stocks/index')),
  
  // ä¸­é¢‘è®¿é—®é¡µé¢ - æŒ‰éœ€åŠ è½½
  StockDetail: lazy(() => import('./stocks/$symbol')),
  Portfolio: lazy(() => import('./portfolio')),
  
  // ä½é¢‘è®¿é—®é¡µé¢ - å»¶è¿ŸåŠ è½½
  StrategyBuilder: lazy(() => import('./strategies/create')),
  BacktestResult: lazy(() => import('./backtest/$id')),
  
  // ç®¡ç†é¡µé¢ - ä»…åœ¨éœ€è¦æ—¶åŠ è½½
  Admin: lazy(() => import('./admin'))
}

// è·¯ç”±åŠ è½½ä¼˜å…ˆçº§é…ç½®
export const ROUTE_LOADING_PRIORITIES = {
  high: ['/dashboard', '/stocks', '/portfolio'],
  medium: ['/strategies', '/backtest', '/settings'],
  low: ['/admin', '/ai-analysis']
}
```

### 5.2 å¯¼èˆªçŠ¶æ€ç®¡ç†
```typescript
// apps/web/src/stores/navigation-store.ts
import { create } from 'zustand'

interface NavigationState {
  isNavigating: boolean
  previousPath: string | null
  navigationHistory: string[]
  breadcrumbs: BreadcrumbItem[]
  setNavigating: (isNavigating: boolean) => void
  addToHistory: (path: string) => void
  updateBreadcrumbs: (breadcrumbs: BreadcrumbItem[]) => void
}

export const useNavigationStore = create<NavigationState>((set, get) => ({
  isNavigating: false,
  previousPath: null,
  navigationHistory: [],
  breadcrumbs: [],
  
  setNavigating: (isNavigating) => set({ isNavigating }),
  
  addToHistory: (path) => set((state) => ({
    previousPath: state.navigationHistory[state.navigationHistory.length - 1] || null,
    navigationHistory: [...state.navigationHistory.slice(-9), path] // ä¿ç•™æœ€è¿‘10ä¸ªè·¯å¾„
  })),
  
  updateBreadcrumbs: (breadcrumbs) => set({ breadcrumbs })
}))
```

## 6. å®æ–½æ£€æŸ¥æ¸…å•

### 6.1 å¼€å‘é˜¶æ®µ
- [ ] å®ç°è·¯ç”±ä¿æŠ¤ç»„ä»¶
- [ ] é…ç½®å¯¼èˆªç»„ä»¶æ¶æ„
- [ ] å»ºç«‹é¢åŒ…å±‘ç³»ç»Ÿ
- [ ] å®ç°ç”¨æˆ·èœå•å’Œæƒé™æ˜¾ç¤º
- [ ] é…ç½®SEOå…ƒæ•°æ®ç®¡ç†

### 6.2 æµ‹è¯•é˜¶æ®µ
- [ ] è·¯ç”±ä¿æŠ¤åŠŸèƒ½æµ‹è¯•
- [ ] å¯¼èˆªä¸€è‡´æ€§æµ‹è¯•
- [ ] æ·±åº¦é“¾æ¥æµ‹è¯•
- [ ] é”™è¯¯è¾¹ç•Œæµ‹è¯•
- [ ] æ€§èƒ½å’ŒåŠ è½½æµ‹è¯•

### 6.3 éƒ¨ç½²é˜¶æ®µ
- [ ] ç”Ÿäº§ç¯å¢ƒè·¯ç”±é…ç½®
- [ ] SEOä¼˜åŒ–éªŒè¯
- [ ] é”™è¯¯ç›‘æ§é…ç½®
- [ ] æ€§èƒ½ç›‘æ§è®¾ç½®
- [ ] ç”¨æˆ·ä½“éªŒæµ‹è¯•

## 7. å¯¼èˆªè§„èŒƒæ€»ç»“

| ç»„ä»¶ | åŠŸèƒ½ | å®æ–½çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|------|----------|--------|
| è·¯ç”±ä¿æŠ¤ | åŸºäºç”¨æˆ·çŠ¶æ€å’Œæƒé™çš„è®¿é—®æ§åˆ¶ | âœ… å·²å®æ–½ | ğŸ”´ é«˜ |
| ä¸»å¯¼èˆª | ä¸€è‡´çš„ä¸»èœå•å’Œæƒé™æ˜¾ç¤º | âœ… å·²å®æ–½ | ğŸ”´ é«˜ |
| é¢åŒ…å±‘ | å±‚çº§å¯¼èˆªå’Œä½ç½®æŒ‡ç¤º | âœ… å·²å®æ–½ | ğŸŸ¡ ä¸­ |
| ç”¨æˆ·èœå• | ä¸ªäººè®¾ç½®å’Œè®¢é˜…çŠ¶æ€æ˜¾ç¤º | âœ… å·²å®æ–½ | ğŸ”´ é«˜ |
| é”™è¯¯è¾¹ç•Œ | ä¼˜é›…çš„é”™è¯¯å¤„ç†å’Œå›é€€ | âœ… å·²å®æ–½ | ğŸ”´ é«˜ |
| SEOä¼˜åŒ– | æœç´¢å¼•æ“å‹å¥½çš„è·¯ç”±ç»“æ„ | âœ… å·²å®æ–½ | ğŸŸ¡ ä¸­ |