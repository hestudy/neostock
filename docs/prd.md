# neostock Brownfield Enhancement PRD

## 变更日志

| 变更 | 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|------|
| 初始创建 | 2025-08-21 | v1.0 | 创建中国股票分析平台PRD | John (PM Agent) |

---

## 1. 项目分析和背景 📊

### 现有项目概览

**分析来源**: IDE-based fresh analysis - 直接分析当前加载的项目

**当前项目状态**: 
neostock 是一个现代化的全栈 TypeScript 应用程序，基于 Better-T-Stack 构建。项目目前包含一个完整的认证系统，使用 React + TanStack Router 作为前端，Hono + tRPC 作为后端 API，SQLite/Drizzle 作为数据库层。这是一个 monorepo 结构，具备基础的用户认证功能。

### 可用文档分析

**可用文档**:
- [x] Tech Stack 文档（来自 README.md）
- [ ] Source Tree/架构文档
- [ ] 编码标准文档
- [ ] API 文档
- [ ] 外部 API 文档  
- [ ] UX/UI 指导原则
- [ ] 技术债务文档

### 增强范围定义

**增强类型**: ✅ 新功能添加 - 将基础认证框架转换为完整的股票分析平台

**增强描述**: 在现有的 neostock 认证框架基础上，开发一个完整的中国股票分析平台，包含策略回测引擎、AI 驱动的股票分析、数据可视化和用户投资组合管理功能。

**影响评估**: ✅ 主要影响（需要架构更改）- 需要添加金融数据处理、实时数据流、复杂算法计算等核心功能

### 目标和背景上下文

**目标**:
- 为中国股票市场提供专业的分析和回测工具
- 集成 AI 技术进行智能投资建议和市场分析
- 提供用户友好的策略构建和回测界面
- 支持移动端友好的数据分析和历史数据回溯
- 建立安全可靠的付费订阅和用户权限管理系统

**背景上下文**: 
中国股票市场具有独特性，需要专门的分析工具来处理 A股市场的数据。现有的国外分析工具往往不适用于中国市场的特殊规则和数据格式。基于已有的 Better-T-Stack 认证框架，我们可以快速构建一个安全、现代化的股票分析平台，利用 TypeScript 的类型安全和 tRPC 的端到端类型安全来处理复杂的金融数据。

---

## 2. 需求分析 📋

### 功能需求

**FR1**: 系统应支持中国A股数据通过tushare pro或免费API获取，每日下午5点自动拉取并存储延时数据
**FR2**: 用户可以创建、编辑多种交易策略（技术指标策略、基本面策略、量化算法策略），支持全套技术指标（MA、MACD、RSI、KDJ、布林带、CCI、威廉指标等）
**FR3**: 策略回测引擎基于1年历史数据异步处理，生成完整性能报告（夏普比率、最大回撤、年化收益率、胜率、盈亏比等全套指标）
**FR4**: AI大语言模型分析提供日内交易、短线和中线建议，基于价格数据、财务报表、新闻舆情、宏观经济数据进行买卖信号、价格预测、风险评估、板块推荐
**FR5**: 移动端友好的数据可视化组件，为个人投资者提供简单易用的股价图表和分析结果展示
**FR6**: 分层用户权限系统，支持免费功能和付费订阅功能，管理用户访问级别
**FR7**: 用户投资组合管理和模拟交易系统，支持策略验证和风险控制

### 非功能需求

**NFR1**: 系统必须支持万人级并发用户，维持现有认证系统安全性，日数据处理能力不少于4000只A股
**NFR2**: 回测计算采用异步处理，1年数据回测完成时间不超过5分钟
**NFR3**: 数据存储稳定安全，支持移动端访问，系统可用性达到99.5%
**NFR4**: 付费订阅系统集成，支持不同权限级别的功能访问控制
**NFR5**: 符合个人投资者使用习惯，界面简单易用，学习成本不超过30分钟

### 兼容性需求

**CR1**: 必须与现有Better Auth认证系统完全兼容，扩展支持付费订阅用户管理
**CR2**: 数据库schema扩展支持大量金融时序数据存储，不影响现有用户认证结构
**CR3**: 移动端UI必须与现有shadcn/ui设计系统保持一致，适配手机屏幕尺寸
**CR4**: API设计遵循现有tRPC模式，支持数据拉取任务的异步处理架构

---

## 3. 用户界面增强目标 📱

### 与现有UI的集成

**现有设计系统集成**: 
新的股票分析功能将完全集成现有的 shadcn/ui 组件库，扩展现有的深色模式支持。利用现有的 Button、Card、Input 等组件构建金融数据展示界面，确保视觉一致性。新增专门的金融图表组件（K线图、技术指标图表）将采用相同的颜色主题和交互模式。

**响应式设计原则**:
- 桌面端：多列布局，同时展示股票列表、图表和分析结果
- 移动端：单列堆叠布局，支持左右滑动切换不同分析视图
- 统一的导航模式，保持与现有认证页面的一致性

### 修改/新增的屏幕和视图

**新增核心屏幕**:
1. **股票搜索和选择页面** - 支持代码和名称搜索，显示基本信息
2. **股票详情和图表页面** - K线图、技术指标叠加显示
3. **策略构建器页面** - 拖拽式策略配置，参数设置界面  
4. **回测结果页面** - 收益曲线、关键指标展示、交易记录
5. **AI分析中心** - 智能推荐、市场洞察、风险提醒
6. **投资组合管理** - 持仓概览、收益分析、资产配置
7. **用户设置和订阅管理** - 会员等级、功能权限、支付管理

**修改现有屏幕**:
- **Dashboard页面** - 扩展为股票分析主控制面板，集成市场概览
- **用户菜单** - 添加订阅状态显示和快速功能入口

### UI一致性要求

**视觉一致性**:
- 延续现有的简洁设计风格，避免过度复杂的金融界面
- 保持现有的色彩体系，为股票数据添加专用的红绿色彩（涨跌）
- 统一的卡片式布局，确保信息层级清晰
- 保持现有的字体系统和间距规范

**交互一致性**:
- 统一的加载状态和错误处理方式
- 保持现有的表单交互模式
- 统一的导航和面包屑模式
- 一致的手势操作（移动端滑动、点击反馈）

**个人投资者友好设计**:
- 关键信息优先级显示，避免信息过载
- 提供新手引导和帮助提示
- 简化复杂的金融术语，提供易懂的解释
- 一键操作的快捷功能，减少学习成本

---

## 4. 技术约束和集成要求 🔧

### 现有技术栈

**语言**: TypeScript (100% 类型安全)
**前端框架**: React 18 + TanStack Router (文件路由)
**UI组件**: shadcn/ui + TailwindCSS (响应式设计)
**后端框架**: Hono (轻量级，高性能)
**API层**: tRPC (端到端类型安全)
**数据库**: SQLite + Drizzle ORM (TypeScript-first)
**运行时**: Bun (高性能 JavaScript 运行时)
**构建工具**: Turborepo (monorepo 管理)
**认证**: Better Auth (邮箱密码认证)

### 集成方法

**数据库集成策略**:
- 扩展现有 Drizzle schema，添加股票数据表（stocks、daily_data、indicators、strategies、backtests）
- 保持现有用户认证表结构不变，通过外键关联用户和投资组合数据
- 实现数据分区策略，按时间范围存储历史数据，优化查询性能
- 集成 SQLite FTS5 全文搜索，支持股票代码和名称快速搜索

**API集成策略**:
- 扩展现有 tRPC router，添加股票数据、回测、AI分析等新路由
- 保持端到端类型安全，为所有金融数据定义 TypeScript 接口
- 实现 tushare pro API 的 TypeScript 包装器，统一数据格式
- 添加定时任务支持，每日下午5点自动拉取数据

**前端集成策略**:
- 扩展现有 TanStack Router 路由，添加股票分析相关页面
- 复用现有 shadcn/ui 组件，新增金融专用组件（K线图、指标图表）
- 集成轻量级图表库（如 Lightweight Charts），保持包体积合理
- 实现响应式设计，确保移动端和桌面端一致体验

**测试集成策略**:
- 扩展现有测试框架，添加金融计算逻辑单元测试
- 实现回测算法的基准测试，确保计算准确性
- 添加 tushare API 的模拟测试，避免在测试中调用真实API
- 集成端到端测试，验证完整的用户操作流程

### 代码组织和标准

**文件结构方法**:
```
apps/
├── server/
│   ├── src/
│   │   ├── lib/
│   │   │   ├── auth.ts (现有)
│   │   │   ├── stock-data.ts (新增)
│   │   │   ├── backtest-engine.ts (新增)
│   │   │   └── ai-analysis.ts (新增)
│   │   ├── routers/
│   │   │   ├── index.ts (现有)
│   │   │   ├── stocks.ts (新增)
│   │   │   ├── backtest.ts (新增)
│   │   │   └── ai.ts (新增)
│   │   └── db/schema/
│   │       ├── auth.ts (现有)
│   │       ├── stocks.ts (新增)
│   │       └── finance.ts (新增)
├── web/
│   ├── src/
│   │   ├── components/
│   │   │   ├── ui/ (现有)
│   │   │   ├── stock-chart.tsx (新增)
│   │   │   ├── strategy-builder.tsx (新增)
│   │   │   └── backtest-results.tsx (新增)
│   │   ├── routes/
│   │   │   ├── __root.tsx (现有)
│   │   │   ├── dashboard.tsx (扩展)
│   │   │   ├── stocks/ (新增目录)
│   │   │   └── backtest/ (新增目录)
```

**命名约定**:
- 股票相关文件以 `stock-` 前缀命名
- 回测相关文件以 `backtest-` 前缀命名
- AI分析相关文件以 `ai-` 前缀命名
- 保持现有的 kebab-case 文件命名风格

**编码标准**:
- 严格遵循现有的 TypeScript 配置和 ESLint 规则
- 所有金融计算函数必须有完整的 JSDoc 注释
- 使用 Zod 验证所有外部数据（tushare API 响应）
- 实现统一的错误处理和日志记录机制

### 部署和运营

**构建过程集成**:
- 保持现有的 Turborepo 构建配置
- 添加金融数据模型的类型检查步骤
- 集成回测算法的性能基准测试到CI流程
- 实现数据库迁移脚本的自动化执行

**部署策略**:
- 保持现有的部署流程，添加数据库迁移步骤
- 实现定时任务的部署和监控（数据拉取任务）
- 配置环境变量管理（tushare API密钥等）
- 设置数据备份和恢复策略

**监控和日志**:
- 扩展现有日志系统，添加金融数据处理日志
- 实现数据质量监控（缺失数据、异常值检测）
- 添加回测性能监控和用户行为分析
- 集成支付和订阅状态监控

### 风险评估和缓解

**技术风险**:
- **数据依赖风险**: tushare API限制和稳定性 → 实现多数据源备份和缓存机制
- **计算性能风险**: 大量回测计算可能影响系统响应 → 实现异步队列和计算资源隔离
- **数据准确性风险**: 金融数据错误可能导致投资损失 → 实施多层数据验证和质量检查

**集成风险**:
- **认证系统兼容**: 付费功能集成可能影响现有认证 → 渐进式迁移和向后兼容
- **移动端性能**: 大量图表数据可能影响移动端体验 → 数据分页和懒加载策略
- **类型安全**: 复杂金融数据结构可能破坏类型安全 → 严格的类型定义和运行时验证

**部署风险**:
- **数据迁移风险**: 大量历史数据可能导致部署时间过长 → 分批迁移和零停机部署
- **定时任务风险**: 数据拉取任务失败可能影响整体功能 → 重试机制和监控告警
- **扩展性风险**: 万人级用户可能超出SQLite承载能力 → 数据库分片和缓存优化

---

## 5. Epic和Story结构 📚

### Epic方法

**Epic结构决策**: 单个综合Epic，因为所有功能（数据获取、策略回测、AI分析、移动端界面）都紧密关联，共同构成一个完整的股票分析平台。

## Epic 1: 中国股票分析平台核心功能开发

**Epic目标**: 在现有 neostock 认证框架基础上，构建完整的A股分析平台，提供数据获取、策略回测、AI分析和移动端友好的用户界面，支持付费订阅模式。

**集成要求**: 保持与现有 Better Auth、tRPC、Drizzle ORM 的完全兼容，确保现有用户认证功能不受影响，所有新功能通过扩展现有架构实现。

### Story 1.1 数据库架构扩展和股票基础数据管理

作为一个个人投资者，
我希望系统能够存储和管理A股的基础信息和历史数据，
以便我可以查询和分析股票信息。

#### 验收标准
1. 扩展 Drizzle schema 添加股票基础信息表（代码、名称、行业、上市日期等）
2. 创建日线数据表存储股价、成交量等交易数据
3. 实现数据表索引优化，确保查询性能
4. 保持与现有用户认证表的完全兼容性
5. 实现数据库迁移脚本，支持现有数据无缝升级

#### 集成验证
- **IV1**: 验证现有用户认证功能完全正常，登录注册不受影响
- **IV2**: 验证数据库迁移过程不会破坏现有用户数据
- **IV3**: 验证新表结构的查询性能不影响现有API响应时间

### Story 1.2 Tushare数据源集成和定时数据拉取

作为一个个人投资者，
我希望系统能够自动获取最新的A股数据，
以便我可以基于准确的数据进行分析。

#### 验收标准
1. 集成 tushare pro API，实现股票基础信息和日线数据获取
2. 创建定时任务，每日下午5点自动拉取当日数据
3. 实现数据验证和清洗逻辑，确保数据质量
4. 扩展 tRPC router 添加数据管理相关API端点
5. 实现错误处理和重试机制，提高数据获取可靠性

#### 集成验证
- **IV1**: 验证定时任务不会影响现有系统性能和稳定性
- **IV2**: 验证新的API端点与现有tRPC路由体系完全兼容
- **IV3**: 验证数据拉取过程的异常不会影响用户正常使用功能

### Story 1.3 股票搜索和详情页面开发

作为一个个人投资者，
我希望能够轻松搜索和查看股票的基本信息，
以便我可以选择感兴趣的股票进行深入分析。

#### 验收标准
1. 基于现有shadcn/ui组件创建股票搜索界面
2. 实现代码和名称的模糊搜索功能
3. 创建股票详情页面展示基本信息和最新价格
4. 实现响应式设计，确保移动端良好体验
5. 集成到现有TanStack Router路由系统

#### 集成验证
- **IV1**: 验证新页面与现有导航系统和用户菜单完全集成
- **IV2**: 验证移动端布局与现有页面保持一致的设计风格
- **IV3**: 验证搜索功能不会影响现有页面的加载性能

### Story 1.4 K线图表和技术指标可视化

作为一个个人投资者，
我希望能够查看股票的K线图和技术指标，
以便我可以进行技术分析和判断买卖时机。

#### 验收标准
1. 集成轻量级图表库实现K线图展示
2. 支持多种技术指标叠加显示（MA、MACD、RSI等）
3. 实现图表的缩放、平移等交互功能
4. 优化移动端图表显示和触屏操作体验
5. 保持与现有UI主题和颜色系统的一致性

#### 集成验证
- **IV1**: 验证图表组件不会增加过多包体积或影响首页加载速度
- **IV2**: 验证图表的颜色主题与现有深色/浅色模式正确切换
- **IV3**: 验证移动端图表操作不会与现有手势导航冲突

### Story 1.5 交易策略构建器开发

作为一个个人投资者，
我希望能够创建和配置自己的交易策略，
以便我可以系统化地进行投资决策。

#### 验收标准
1. 创建策略配置界面支持技术指标参数设置
2. 实现策略逻辑的可视化构建（条件设置、买卖信号）
3. 提供策略模板和参数建议，降低使用门槛
4. 实现策略的保存、编辑和管理功能
5. 集成用户权限控制，区分免费和付费功能

#### 集成验证
- **IV1**: 验证策略数据与现有用户账户系统正确关联
- **IV2**: 验证权限控制与现有认证系统无缝集成
- **IV3**: 验证策略配置界面在不同设备上的响应性和可用性

### Story 1.6 回测引擎核心算法实现

作为一个个人投资者，
我希望能够测试我的交易策略在历史数据上的表现，
以便我可以评估策略的有效性。

#### 验收标准
1. 实现回测算法核心逻辑，支持买卖信号执行
2. 计算关键性能指标（收益率、夏普比率、最大回撤等）
3. 实现异步处理机制，避免长时间计算阻塞系统
4. 创建回测任务队列和状态管理
5. 实现回测结果的数据存储和检索

#### 集成验证
- **IV1**: 验证异步回测任务不会影响现有API的响应性能
- **IV2**: 验证回测计算结果的准确性和一致性
- **IV3**: 验证并发回测请求的处理能力和资源管理

### Story 1.7 回测结果展示和分析报告

作为一个个人投资者，
我希望能够清晰地查看回测结果和分析报告，
以便我可以理解策略的优缺点并做出改进。

#### 验收标准
1. 创建回测结果页面展示收益曲线和关键指标
2. 实现交易记录的详细展示和筛选功能
3. 提供策略对比功能，支持多策略性能比较
4. 生成可视化的分析图表和风险评估报告
5. 支持回测结果的导出和分享功能

#### 集成验证
- **IV1**: 验证大量回测数据的加载不会影响页面响应速度
- **IV2**: 验证回测结果页面与现有导航和布局系统兼容
- **IV3**: 验证移动端回测结果展示的可读性和交互性

### Story 1.8 AI分析模块和智能推荐系统

作为一个个人投资者，
我希望获得AI驱动的股票分析和投资建议，
以便我可以做出更明智的投资决策。

#### 验收标准
1. 集成大语言模型API进行股票分析和推荐
2. 实现基于多维数据（价格、财务、新闻）的综合分析
3. 提供日内交易、短线和中线的差异化建议
4. 创建AI分析结果的缓存机制，优化响应速度
5. 实现AI分析历史记录和准确性跟踪

#### 集成验证
- **IV1**: 验证AI API调用不会影响现有系统稳定性
- **IV2**: 验证AI分析结果与用户权限系统正确集成
- **IV3**: 验证AI分析功能在高并发情况下的性能表现

### Story 1.9 用户权限和付费订阅系统

作为一个个人投资者，
我希望能够根据需要选择合适的付费方案，
以便我可以享受相应级别的功能和服务。

#### 验收标准
1. 扩展现有用户系统添加订阅状态和权限级别
2. 实现功能访问控制，区分免费和付费功能
3. 集成支付系统支持订阅购买和续费
4. 创建订阅管理界面，支持方案升级和取消
5. 实现权限变更时的平滑过渡和数据保护

#### 集成验证
- **IV1**: 验证付费功能控制不会影响现有免费用户体验
- **IV2**: 验证订阅状态变更与现有认证系统同步正确
- **IV3**: 验证支付流程的安全性和数据保护措施

### Story 1.10 移动端优化和最终系统集成

作为一个个人投资者，
我希望能够在手机上流畅使用所有分析功能，
以便我可以随时随地进行投资决策。

#### 验收标准
1. 优化所有页面的移动端布局和交互体验
2. 实现PWA支持，提供类原生应用体验
3. 优化移动端图表和数据可视化的性能
4. 完成系统集成测试，确保所有功能协调工作
5. 实现完整的错误处理和用户反馈机制

#### 集成验证
- **IV1**: 验证移动端所有功能与桌面端功能完全一致
- **IV2**: 验证系统整体性能满足万人级用户访问需求
- **IV3**: 验证所有新功能不会破坏现有系统的任何部分

---

## 📋 总结

这个 PRD 为 neostock 项目提供了从基础认证框架转换为完整中国股票分析平台的详细规划。通过渐进式的 10 个 Story 开发，确保在保持现有系统稳定性的同时，构建出功能完整、用户友好的金融分析工具。

**核心价值主张**: 为个人投资者提供专业级的A股分析工具，结合AI大语言模型的智能分析，让普通用户也能享受量化投资的便利。

**关键成功因素**:
- 保持与现有 Better-T-Stack 架构的完全兼容性
- 确保移动端优先的用户体验
- 实现稳定可靠的付费订阅模式
- 提供准确可信的金融数据和分析结果

🎯 **下一步**: 开始执行 Story 1.1，进行数据库架构扩展和股票基础数据管理的开发工作。